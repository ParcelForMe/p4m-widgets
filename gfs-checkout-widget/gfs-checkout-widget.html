<link rel="import" href="../../polymer/polymer.html" />
<link rel="import" href="../../iron-list/iron-list.html" />

<link rel="import" href="../../paper-toggle-button/paper-toggle-button.html" />
<link rel="import" href="../../paper-spinner/paper-spinner.html" />
<link rel="import" href="../../paper-toast/paper-toast.html" />
<link rel="import" href="../../paper-button/paper-button.html" />
<link rel="import" href="../../paper-tabs/paper-tabs.html" />
<link rel="import" href="../../iron-pages/iron-pages.html" />
<link rel="import" href="../../iron-icons/iron-icons.html" />
<link rel="import" href="../../iron-dropdown/iron-dropdown.html" />
<link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html" />
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-listbox/paper-listbox.html">

<link rel="import" href="../gfs-droppoint/gfs-droppoint.html" />
<link rel="import" href="../gfs-droppoint/gfs-location-button.html" />
<link rel="import" href="../gfs-calendar/gfs-calendar.html" />
<link rel="import" href="../map-region-manager/map-region-manager.html" />

<script src="../../momentjs/min/moment.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMQhcXM06TZBHZ95LwJBRVGSV4CqUQMpI&libraries=places"></script>
<link href="css/custom.css" rel="stylesheet" />
<link href="../gfs-shared/gfs.css" rel="stylesheet" />

<dom-module id="gfs-checkout">
    <!--<link rel="import" type="css" href="custom.css">-->

    <template>     

        <map-region-manager id="regionManager"></map-region-manager>

		<div id="widgetContainer">          
            <paper-tabs selected="{{selectedTab}}" no-bar>           
                <paper-tab>{{calendarDeliveryTitle}}</paper-tab>
                <paper-tab>Click and Collect</paper-tab>
                <paper-tab>{{standardDeliveryTitle}}</paper-tab>
            </paper-tabs>
            <iron-pages id="pages" selected="{{selectedTab}}"  on-iron-select="onSelectTab">           
                <iron-page id="pageCalendar">
                    <div id="calendar-loading" class="loading">
                        <paper-spinner active id="calendar-spinner"></paper-spinner>
                    </div>
                    <div class="pageContent horizontal layout">
                        <gfs-calendar id="calendar" class="flex" on-select-shipping-option="_selectCalendarShippingOption" day-definite-data="{{_data.dayDefinite}}" selected-delivery-date="{{overrideDeliveryDate}}" selected-shipping-method-id="{{overrideShippingMethodId}}"></gfs-calendar>
                    </div>
 
                </iron-page>
                <iron-page id="pageDroppoints">
                    <div id="mapTools" class="pageContent">
                        <!-- <div class="header" style="display:none">
                            <h3>{{dropPointTitle}}</h3>
                        </div> -->

                        <div class="toggleDropPointsViewControls">
                            <template is="dom-if" if="{{_showingDroppointsList}}">
                                <a href="#" id="viewAsList" on-tap="_toggleDroppointView">
                                <i class="p4micon p4micon-map-with-marker"></i>
                                </a>
                            </template>
                            <template is="dom-if" if="{{_showingDroppointsMap}}">
                                <a href="#" id="viewAsList" on-tap="_toggleDroppointView">
                                <i class="p4micon p4micon-list"></i></a>
                            </template>
                           
                        </div>


                        <div class="location-points">
                        <paper-dropdown-menu label="My Locations" noink no-animations>
                          <paper-listbox class="dropdown-content">
                            <paper-item>
                            <template is="dom-repeat" items="{{_consumerAddresses}}">
                                <gfs-location-button on-click="_onClickConsumerAddress" google-api-key="AIzaSyAMQhcXM06TZBHZ95LwJBRVGSV4CqUQMpI" address-data="{{item}}" on-locate="panToLocation"></gfs-location-button>
                            </template>
                            <div id="dp-address" class="style-scope gfs-droppoint">
                            </div>
                            </paper-item>
                            <paper-item>
                            <template is="dom-repeat" items="{{_consumerAddresses}}">
                                <gfs-location-button on-click="_onClickConsumerAddress" google-api-key="AIzaSyAMQhcXM06TZBHZ95LwJBRVGSV4CqUQMpI" address-data="{{item}}" on-locate="panToLocation"></gfs-location-button>
                            </template>
                            <div id="dp-address" class="style-scope gfs-droppoint">
                            </div>
                            </paper-item>
                            
                          </paper-listbox>
                        </paper-dropdown-menu>
                        </div>

                        <div class="adjoiner"><p>or</p></div>
                      
                        <div class="search-postcode-wrap">
                            <address-lookup-field id="droppointAddress" on-foundplace="_panToPlace"></address-lookup-field>
                            <div type="submit" class="search-button" on-click="_findPostcode"><iron-icon icon="icons:search"></iron-icon></div>
                        </div>

                        <div class="adjoiner"><p>or</p></div>

                        <div class="collection-points">
                        <paper-dropdown-menu label="My Collection Points" noink no-animations>
                          <paper-listbox class="dropdown-content">
                            <paper-item>
                                <div class="wrap gfs-droppoint">
                                    <div class="dpProviderName style-scope gfs-droppoint">
                                    <div class="dpProviderLogo"><local-image local-folder="gfs-droppoint/images" class="imageicon style-scope gfs-droppoint" height="45">
                                        <img class="style-scope local-image" src="http://localhost:8081/lib/p4m-widgets/gfs-droppoint/images/DPD.png">
                                    </local-image></div>
                                    DPD
                                    </div>
                                    <template is="dom-if" class="style-scope gfs-droppoint"></template>
                                    
                                    <template is="dom-if" class="style-scope gfs-droppoint"></template>

                                    <div id="dp-address" class="style-scope gfs-droppoint">
                                        212 Strand
                                        <br class="style-scope gfs-droppoint">
                                        <template is="dom-repeat" class="style-scope gfs-droppoint"></template>
                                        London, WC2R 1AP
                                    </div>
                                </div>
                            </paper-item>
                            <paper-item>
                                <div class="wrap gfs-droppoint">
                                    <div class="dpProviderName style-scope gfs-droppoint">
                                    <div class="dpProviderLogo"><local-image local-folder="gfs-droppoint/images" class="imageicon style-scope gfs-droppoint" height="45">
                                        <img class="style-scope local-image" src="http://localhost:8081/lib/p4m-widgets/gfs-droppoint/images/DPD.png">
                                    </local-image></div>
                                    DPD
                                    </div>
                                    <template is="dom-if" class="style-scope gfs-droppoint"></template>
                                    
                                    <template is="dom-if" class="style-scope gfs-droppoint"></template>

                                    <div id="dp-address" class="style-scope gfs-droppoint">
                                        212 Strand
                                        <br class="style-scope gfs-droppoint">
                                        <template is="dom-repeat" class="style-scope gfs-droppoint"></template>
                                        London, WC2R 1AP
                                    </div>
                                </div>
                            </paper-item>
                            <paper-item>
                                <div class="wrap gfs-droppoint">
                                    <div class="dpProviderName style-scope gfs-droppoint">
                                    <div class="dpProviderLogo"><local-image local-folder="gfs-droppoint/images" class="imageicon style-scope gfs-droppoint" height="45">
                                        <img class="style-scope local-image" src="http://localhost:8081/lib/p4m-widgets/gfs-droppoint/images/DPD.png">
                                    </local-image></div>
                                    DPD
                                    </div>
                                    <template is="dom-if" class="style-scope gfs-droppoint"></template>
                                    
                                    <template is="dom-if" class="style-scope gfs-droppoint"></template>

                                    <div id="dp-address" class="style-scope gfs-droppoint">
                                        212 Strand
                                        <br class="style-scope gfs-droppoint">
                                        <template is="dom-repeat" class="style-scope gfs-droppoint"></template>
                                        London, WC2R 1AP
                                    </div>
                                </div>
                            </paper-item>
                          </paper-listbox>
                        </paper-dropdown-menu>
                        </div>
                        


                    </div>
                    <div class="page" id="pageDroppoints">

                        <div id="mapContainer">

                            <div id="dropPointDetails" class$="{{_dropPointDetailsClass}}">
                                <div id="droppoint_overlay" style="height: {{mapHeight}}px; display: block">
                                    <div id="droppoint_overlay_close" on-click="_hideDropPointDetails">
                                        <img src="./images/x.png" alt="close" />
                                    </div>
                                    <gfs-droppoint id="overlay-droppoint" click-to-choose="true" droppoint-data="{{_selectedDropPoint}}" disable-unchoose="true" on-click="_hideDropPointDetails" container-class="overlay" show-distance="true" show-opening-hours="true"></gfs-droppoint>
                                </div>
                            </div>
                            <div class="hidden">
                                <div id="droppoint_info" class="noscroll">
                                    <gfs-droppoint show-opening-hours-link="true" click-to-choose="true" on-opening-hours-link-click="_showDropPointDetails" disable-unchoose="true" id="infobox-droppoint" droppoint-data="{{_selectedDropPoint}}" on-select-delivery-option="onUpdateDroppointDeliveryOptions" show-shipping-options="true" button-type="tick"></gfs-droppoint>
                                </div>
                            </div>
                            <img id="locateme" on-click="_locateMe" src="./images/locateme.png" />
                            <!--
                               <div id="gfsMapCanvas-loading" class="loading"><paper-spinner id="search-spinner"></paper-spinner></div> 
                            -->
                            <div id="mainMapArea">
                                <div id="gfsMapCanvas">
                                    <div class="loading">
                                        <paper-spinner active id="map-spinner"></paper-spinner>
                                    </div>
                                </div>
                                <template is="dom-if" if="{{_preferredDroppoints.length}}">
                                    <div class="preferredDroppoints">
                                        <h3>My Collection Points</h3>
                                        <template id="mapPreferredDropPointList" is="dom-repeat" items="{{_preferredDroppoints}}" sort="sortByDistance">
                                            <gfs-droppoint click-to-choose="true" on-select="_onSelectPreferredDroppoint" container-class="dp-mini-card" xon-droppoint-click="_onClickDroppoint" button-type="tick" disable-unchoose="true" droppoint-data="{{item}}" class="droppoint"></gfs-droppoint>
                                        </template>
                                    </div>
                                </template>


                            </div>
                        </div>

                        <array-selector id="dropPointSelector" items="{{_dropPoints}}" selected="{{chosen}}" multi="false"></array-selector>
                        <div id="dropPointListContainer" class="hidden">

                            <div class="cardList">
                                <div id="list-loading" class="loading">
                                    <paper-spinner active id="list-spinner"></paper-spinner>
                                </div>
                                <div id="mainDropPointListArea">
                                    <div id="dropPointList">
                                        <template id="dropPointListTemplate" is="dom-repeat" items="{{_dropPoints}}" sort="sortByDistance" filter="filterToMap">
                                            <gfs-droppoint on-select-delivery-option="onUpdateDroppointDeliveryOptions" on-select="_onSelectPreferredDroppoint" disable-unchoose="true" scroll-into-view-on-choose="true" show-shipping-options="true" show-opening-hours="true" show-distance="true" button-type="standard" droppoint-data="{{item}}" class="droppoint"></gfs-droppoint>
                                        </template>
                                    </div>

                                    <div class="preferredDroppoints">
                                        <h3>My Collection Points</h3>
                                        <template id="listPreferredDropPointList" is="dom-repeat" items="{{_preferredDroppoints}}" sort="sortByDistance">
                                            <gfs-droppoint  click-to-choose="true" on-select="_onSelectPreferredDroppoint" disable-unchoose="true" button-type="tick" droppoint-data="{{item}}" class="droppoint"></gfs-droppoint>
                                        </template>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </iron-page>
                <iron-page id="pageStandard">
                    <div id="standard-loading" class="loading"><paper-spinner active id="standard-spinner"></paper-spinner></div>
                    <ul class="separated">
                        <template id="standardRatesTemplate" is="dom-repeat" items="{{standardRates}}" sort="sortServices">
                            <li class="gfsStd horizontal layout center">
                                <label for$="{{item.id}}">
                                    <p class="methodname lg">{{item.methodTitle}}</p>
                                    <p class="price lg">{{currencySymbol}}{{item.price}}</p>
                                    <p class="deliveryDateRange">{{item.deliveryDateRange}}</p>
                                </label>
                                <div class="flex"></div>
                                <i name="shipping_method" on-click="updateDeliveryOptionsEvent" checked="{{item.selected}}" value="{{item.id}}" id="{{item.id}}" class="p4micon-check-circle link standard-delivery-selection"></i>
                                <!-- <inputtype="radio" checked="{{item.selected}}" value="{{item.id}}" id="{{item.id}}" class="radio standard-delivery-selection " /> -->
                            </li>
                        </template>
                    </ul>
                </iron-page>
            </iron-pages>
        </div>
        <input type="text" value="{{_selectedDropPoint.droppointId}}" id="dropPointRadio" class="hidden" />
        <paper-toast id="errorNotification" class="fit-bottom"></paper-toast>

        <style include="p4m-shared"></style>

    </template>



    <script>
        /* Warning message goes here */
        /*global Polymer*/
        var DAY_MS = 1000 * 60 * 60 * 24;
        var DOW_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun', '?'];
        var MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        // set them here so you can access the home marker
        var geocoder = null;
        var marker = null;

        // element registration
        Polymer({
            is: "gfs-checkout",

            // add properties and methods on the element's prototype

            properties: {
                //=== Element attributes ===//
                accessToken: {
                    type: String
                },

                currencySymbol: {
                    type: String,
                    value: '£'
                },

                gfsData: {
                    type: String
                },

                autoLoad: {
                    type: Object,
                    value: true
                },

                preselect: {
                    type: Object,
                    value: true
                },

                useDropPoints: {
                    type: Object,
                    value: true
                },

                useStandard: {
                    type: Object,
                    value: true
                },

                useCalendar: {
                    type: Object,
                    value: true
                },

                calendarLabels: {
                    type: Object,
                    value: {
                        //prev: "<<",
                        //next: ">>",
                        months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                        weekdays: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"]
                    }
                },

                allowCalendarPreselect: {
                    type: Object,
                    value: true
                },

                defaultTab: {
                    type: String //If 'calendar', shows calendar on startup
                },

                initialAddress: {
                    type: String
                },
               
                defaultPostCode: {
                    type: String
                },

                defaultCountryCode: {
                    type: String
                },

                /*
                selectedTab: {
                    type: String,
                    value: "2"
                },*/

                // ATTRIBUTES
                //
                // These properties represent text used for labels, titles and prompts throughout the widget.
                // They are controlled by passing values via the element attributes.
                // To override the default values shown below, simply pass through the attributes name, with camel caps converted to dashed lower case:
                // e.g: 'dropPointTitle' would be set by:
                // <gfs-checkout drop-point-title="Your text goes here" ...

                dropPointTitle: {
                    type: String,
                    value: 'Would you prefer to collect your order?'
                },

                dropPointDeliveryTitle: {
                    type: String,
                    value: 'Select your preferred collection point to view available services:'
                },

                calendarDeliveryTitle: {
                    type: String,
                    value: 'Choose your day'
                },

                calendarDayPrompt: {
                    type: String,
                    value: 'Please select a delivery time:'
                },

                standardDeliveryTitle: {
                    type: String,
                    value: 'Standard Delivery'
                },

                //If set, preselect this shipping method (if possible)
                overrideShippingMethodId: {
                    type: String
                },

                //If set, preselect this shipping date (if possible)
                overrideDeliveryDate: {
                    type: String //ISO Date format
                },

                //If set, preselect this droppoint (if possible)
                overrideDroppointId: {
                    type: String
                },

                hideMapUI: {
                    type: Object,
                    value: false
                },

                mapHeight: {
                    type: Number,
                    value: 400
                },

                homeIcon: {
                    type: String
                },

                markerIcon: {
                    type: String
                },

                selectedMarkerIcon: {
                    type: String
                },

                //TODO: Investigate removing these
                /*startingLatitude: {
                	type: Number,
                	value: 37.4220279
                },

                //TODO: Investigate removing these
                startingLongitude: {
                	type: Number,
                	value: -122.0840677
                },*/

                startingZoomLevel: {
                    type: Number,
                    value: 14
                },

                serviceSortOrder: {
                    type: String, //cheapestFirst, fastestFirst, expensiveFirst, slowestFirst
                    value: "cheapestFirst"
                },

                selectedServiceDetails: {
                    type: Object,
                    value: {
                        service: null,
                        serviceCode: null,
                        carrier: null,
                        shipping: null,
                        deliveryAddress: null,
                        expDeliveryDateStart: null,
                        expDeliveryDateEnd: null,
                        collectPoint: null
                    }
                },

                // PRIVATE PROPERTIES
                //
                // Do not modify these properties.

                _postData: {
                    type: Object,
                    value: {}
                },

                _autoChooseCollectionPoint: {
                    type: Object,
                    value: true
                },

                _selectedDropPoint: {
                    type: Object
                },

                _dropPointDetailsClass: {
                    type: String,
                    value: "hidden"
                },



                _shippingRateGroups: {
                    type: Array,
                    notify: true,
                    value: []
                },

                _data: {
                    type: Object,
                    value: {
                        dayDefinite: [],
                        droppoints: [],
                        standardRates: [],
                        links: [],
                        nonDayDefinite: []
                    },
                    notify: true
                },

                _dropPoints: {
                    type: Array,
                    value: [],
                    notify: true
                },

                _preferredDroppoints: {
                    type: Array,
                    value: []
                },

                _consumerAddresses: {
                    type: Array,
                    value: [],
                    notify: true
                },

                _map: {
                    type: Object
                },

                _currentMarker: {
                    type: Object
                },

                _dropPointTickClass: {
                    type: String,
                    value: "notchosen"
                },

                _dropPointChooseBtnText: {
                    type: String,
                    value: "Choose"
                },

                _showingDroppoints: {
                    type: Object,
                    value: false
                },

                _showingDroppointsMap: {
                    type: Object,
                    value: true
                },

                _showingDroppointsList: {
                    type: Object,
                    value: false
                },

                _infoWindow: {
                    type: Object
                },

                //Lookup for deliveries on a given day
                _deliveryDays: {
                    type: Object,
                    value: {}
                },

                //Lookup for deliveries on a given day
                _deliveryDroppoints: {
                    type: Object,
                    value: {}
                },

                _earliestDelivery: {
                    type: Object,
                    value: null
                },

                _infoBoxDroppoint: {
                    type: Object
                },

                // set default service parameters when API is not available
                /*
                defaultService: {
                    type: String,
                    value: ""
                },

                defaultCarrier: {
                    type: String,
                    value: ""
                },

                defaultPrice: {
                    type: String,
                    value: ""
                },

                defaultMinDeliveryTime: {
                    type: String,
                    value: ""
                },

                defaultMaxDeliveryTime: {
                    type: String,
                    value: ""
                },

                defaultCarrierCode: {
                    type: String,
                    value: ""
                }*/

            },

            listeners: {
                "datetoggleon": "_deliveryDateSelected",
                "prevmonth": "_calendarMonthChanged",
                "nextmonth": "_calendarMonthChanged",
                "droppoint-changed": "_droppointChanged"
            },

            // METHODS

            // This function is called as soon as the widget is ready
            ready: function () {
                console.log("GFS Checkout ready", new Date().getTime());
                //this.countryCode = this.defaultCountryCode;
                //this.postCode = this.defaultPostCode;
                if (this.gfsData) {
                    if (this.gfsData) {
                        this._postData = JSON.parse(atob(this.gfsData).replace(/\r?\n|\r/g, ""));
                    }
                    else if (this.autoLoad) {
                        this.postGfsData(function () { });
                    }
                }               
            },

            createPostData: function (config) {
                var requiredFields = ['countryCode', 'Postcode', 'town', 'addressLines', 'contactEmail', 'recipientFirstName', 'recipientLastName', 'recipientTitle', 'cartValue'];
                var missingFields = requiredFields.filter(function (f) {
                    return (typeof (requiredFields[f]) !== "undefined");
                });
                if (missingFields.length) {
                    throw ("Missing fields: " + missingFields.toString());
                }
                else {
                    var now = new Date();
                    var maxDate = new Date(now.getTime() + (1000 * 60 * 60 * 24 * 14));
 
                    this._postData = {
                        "Request": {
                            "DateRange": {
                                "DateFrom": this._makeDateStr(now),
                                "DateTo": this._makeDateStr(maxDate)
                            },
                            "Order": {
                                "Transit": {
                                    "Recipient": {
                                        "Location": {
                                            "CountryCode": {
                                                "Code": config.countryCode,
                                                "Encoding": "ccISO_3166_1_Alpha2"
                                            },
                                            "Postcode": config.Postcode,
                                            "town": config.town,
                                            "addressLineCollection": config.addressLines
                                        },
                                        "contactDetails": {
                                            "Email": config.contactEmail
                                        },
                                        "Person": {
                                            "firstName": config.recipientFirstName,
                                            "lastName": config.recipientLastName,
                                            "title": config.recipientTitle
                                        }
                                    }
                                },
                                "Value": {
                                    "CurrencyCode": "GBP",
                                    "Value": config.cartValue
                                }
                            },
                            "RequestedDeliveryTypes": ["dmDropPoint", "dmStandard"],
                            "Session": {
                                "APIKeyId": "CL-4CE92613-89A6-4248-A573-A9A7333E6A06",
                                "sessionID": ""
                            }
                        }
                    }
                }
              
            },

            postGfsData: function (callback) {
                if (this.accessToken === "") {
                    var error =  "No access token";
                    this.$.errorNotification = error;
                    this.$.errorNotification.show();
                    callback(error);
                }
                else {
                    console.log(this._postData);
                    this._postReq(this._postData, callback);
                }
            },

            _makeRequest: function (method, url, callback) {
                if (!callback || typeof (callback) !== "function") {
                    throw "No callback";
                }
                var httpRequest = new XMLHttpRequest();
                this._showAsLoading(true);

                httpRequest.open(method, url, true);
                this._attachHeaders(httpRequest, method);

                httpRequest.onreadystatechange = (function () {
                    if (httpRequest.readyState !== XMLHttpRequest.DONE) {
                        this._showAsLoading(true);
                    }
                    else {
                        this._showAsLoading(false);
                        try {
                            if (httpRequest.status == 200 || httpRequest.status == 201) {
                                callback(null, httpRequest.responseText);
                            }
                            else {                               
                                callback(httpRequest.status, httpRequest.responseText);
                            }                                 
                        }
                        catch (e) {
                            console.error(e.stack);
                            callback(e);
                        }
                    }
                }).bind(this);
                return httpRequest;
            },

            _attachHeaders: function(httpReq, method) {
                var headers = this._computeHeader();
                for (var key in headers) {
                    httpReq.setRequestHeader(key, headers[key]);
                }
                httpReq.setRequestHeader('Content-Type', 'application/json');                
            },

            _computeHeader: function () {
                return {
                    "Authorization": "Bearer " + atob(this.accessToken)
                };
            },

            _postReq: function (data, callback) {
                if (typeof (callback) !== "function") {
                    throw "No callback provided";
                }
                var request = this._makeRequest('POST', "///rest.test.api.checkout.justshoutgfs.com/api/CheckoutSession",
                    (function (err, data) {
                        if (err) {
                            callback(err);
                        }
                        else {
                            this._getReq(data, (function (err) {
                                callback(err);
                            }).bind(this));
                        }
                    }).bind(this)
                );
                request.send(JSON.stringify(data));
            },

            _getReq: function (resourceUrl, callback) {
                var self = this;
                if (typeof (callback) !== "function") {
                    throw "No callback provided";
                }
                this._sessionId = resourceUrl.substring(resourceUrl.lastIndexOf("/") + 1).replace('"','');
                var url = "///rest.test.api.checkout.justshoutgfs.com/api/CheckoutSession/" + this._sessionId;
                var request = this._makeRequest('GET', url, (function (err, data) {

                    console.log("GFS Checkout GET response", new Date().getTime());

                    if (err) {
                        callback(err);
                    }
                    else {
                        var result = JSON.parse(data);
                        if (result.message) {
                            callback(result.message);
                        }
                        else {
                            //debugger;
                            this.set('_data', JSON.parse(data));
                            this.set('_dropPoints', this._data.droppoints);
                            this._processAllDroppoints();
                            this._requestDroppointList(this._preferredDroppoints, (function (err) {
                                this._delayedInit.bind(self)();
                                callback(err);
                            }).bind(this));
                        }

                    }
                }).bind(this));
                request.send("");
            },

            _closeReq: function (callback) {
                var data = {
                    closeSession: true,
                    selectedService: this.selectedServiceDetails.serviceId,
                    selectedDroppoint: this.selectedServiceDetails.collectionPoint
                };
                callback(null);

                //Commenting out the below until we know the correct API call
                /*
                var request = this._makeRequest('POST', '///rest.test.api.checkout.justshoutgfs.com/api/CheckoutSession', (function (err, data) {

                    console.log("GFS Checkout Patch response", new Date().getTime());

                    if (err) {
                        callback(err);
                    }
                    else {
                        var result = JSON.parse(data);
                        if (result.message) {
                            callback(result.message);
                        }
                        else {
                            callback(null);
                        }
                    }
                }).bind(this));
                request.send(JSON.stringify(data));*/
            },

            _requestDroppointsByGeoBoxes: function (boxes, callback) {
                var self = this;
                var url = "///rest.test.api.checkout.justshoutgfs.com/api/CheckoutSession?sessionId=" + this._sessionId + "&regions=" + JSON.stringify(boxes);
                var request = this._makeRequest('GET', url, (function (err, data) {
                    var result = JSON.parse(data);
                    if (err || result.message) {
                        callback(err || result.message)
                    }
                    else {
                        if (result.droppoints && result.droppoints.length) {
                            this._dropPoints = this._dropPoints.concat(result.droppoints).sort(this.sortByDistance);
                            this._processAllDroppoints();
                            
                            this._loadDroppointMarkers(this._dropPoints);
                        }
                        callback(null);                     
                    }

                }).bind(this));
                request.send("");
            },

            setGfsOrderValue: function (value) {
                console.log('setGfsOrderValue(' + value + ')');
                this._postData.Request.Order.Value.Value = value;
                //this.postGfsData(callback);
            },

            setGfsAddress: function (address) {
                console.log('setGfsAddress(' + JSON.stringify(address) + ')');
                this._postData.Request.Order.Transit.Recipient.Location = address;
                //this.postGfsData(callback);
            },

            setGfsService: function(serviceId) {
                updateDeliveryOptions();
            },

            _handleError: function (e) {
                console.error("GFS Checkout Error", e);
              },

            _handlePatchResponse: function (e) {
                this.fire("close-checkout-complete", e.detail.response);
            },

            requestDropPointsByAddress: function (addressLine, postCode, countryCode, callback) {
  
                var self = this;
                this._geoCodeAddress(addressLine, postCode, countryCode, function (err, data) {
                    if (!err && data) {
                        var box = [[data.lng() - 0.1, data.lat() - 0.1], [data.lng() + 0.1, data.lat() + 0.1]];
                        self._requestDroppointsByGeoBoxes([box], callback);
                    }
                    else {
                        console.error("Failed to locate address", err);
                        callback(err || "Failed to locate address");
                    }
                })
            },

            _handleGetLocationResponse: function(e) {
                console.log(e);
            },

            _delayedInit: function () {
                this._processInputData();


                if (this.useDropPoints) {
                    this._makeMap();
                    this._findPostcode();
                    this._processAllDroppoints();
                }

                this.showPage_Standard(this.preselect);
            },

            _apiKeyChanged: function(newValue, oldValue) {
                console.log('API Key changed to', newValue);
            },

            isNonGfs: function(item) {
                return item.carrierCode !== 'gfs';
            },

            isGfs: function(item) {
                return item.carrierCode === 'gfs';
            },

            _processInputData: function () {
                this._processDayDefiniteData();
                this._processNonDayDefiniteData();
            },

            _showAsLoading: function (loading) {
                if (loading) {
                    this.$$('#list-spinner').active = true;
                    this.$$('#list-loading').classList.remove('hidden');
                    this.$$('#standard-loading').classList.remove('hidden');
                    this.$$('#calendar-loading').classList.remove('hidden');
                }
                else {
                    this.$$('#list-spinner').active = false;
                    this.$$('#list-loading').classList.add('hidden');
                    this.$$('#standard-loading').classList.add('hidden');
                    this.$$('#calendar-loading').classList.add('hidden');
                }
            },


            sortByDistance: function (a, b) {
                if (a.chosen) return -1
                else if (b.chosen) return 1
                else if (a === b) return 0;
                else return a.distanceInMeters < b.distanceInMeters ? -1 : 1;
            },

            filterToMap: function (item) {
                if (this._map) {
                    if (this._mapViewPort) {
                        var sw = { longitude: this._mapViewPort[0][0], latitude: this._mapViewPort[0][1] };
                        var ne = { longitude: this._mapViewPort[1][0], latitude: this._mapViewPort[1][1] };

                        if ((item.geoLocation.coordinates.latitude > sw.latitude && item.geoLocation.coordinates.latitude < ne.latitude)
                            && (item.geoLocation.coordinates.longitude > sw.longitude && item.geoLocation.coordinates.longitude < ne.longitude)) {
                            return true;
                        }
                        else {
                            return false;
                        }                      
                    }
                    else return true;
                }
                else {
                    return true;
                }              
            },
            /*
            getClosestDroppoint: function (dpList) {
                return dpList.reduce(function (prev, curr) {
                    return (prev.distanceMeters < curr.distanceInMeters) ? prev : curr;
                });
            },*/

            sortServices: function (a, b) {
                if (a == b) return 0;

                switch (this.serviceSortOrder) {
                    case "cheapestFirst":
                        return a.price < b.price ? -1 : 1;
                    case "fastestFirst":
                        return a.deliveryTimeFrom < b.deliveryTimeFrom ? -1 : 1;
                    case "expensiveFirst":
                        return a.price > b.price ? -1 : 1;
                    case "slowestFirst":
                        return a.deliveryTimeFrom > b.deliveryTimeFrom ? -1 : 1;
                    default:
                        return;
                }
            },

            sortDayDefiniteServices: function (a, b) {
                if (a == b) return 0;

                switch (this.serviceSortOrder) {
                    case "expensiveFirst":
                        return a.price > b.price ? -1 : 1;
                    case "cheapestFirst":
                    case "fastestFirst":
                    case "slowestFirst":
                    default:
                        return a.price < b.price ? -1 : 1;
                }
            },


            setPreferredDroppoints: function (droppointList) {
                this._preferredDroppoints = droppointList;//.filter(function (item) { return true });
                this._processPreferredDroppoints();

                if (this._preferredDroppoints.length > 0) {             
                    this._showPreferredDroppoints();
                }
               
            },

            setConsumerAddresses: function (addressList) {
                //console.log("Setting consumer addresses", addressList);
                this.set('_consumerAddresses', addressList);
            },


            _processAllDroppoints: function () {
                //debugger;
                this._removeDupDropPoints();
                this._addDropPointDeliveries();
                this._processPreferredDroppoints();
                this._findAllDeliveryDroppoints();
            },

            _removeDupDropPoints: function () {
                var self = this;
                var uniques = [];
                for (var j = 0; j < this._dropPoints.length; j++) {
                    var dp = this._dropPoints[j];
                    if (!uniques.find(function(item) {
                        return item.droppointId == dp.droppointId;
                    })) {
                        uniques.push(dp);
                    }
                }
                this.set('_dropPoints', uniques);
            },

            _processPreferredDroppoints: function()
            {
                //Now replace preferred items with real data
                var self = this;
                this._preferredDroppoints = this._preferredDroppoints.map(function (item) {
                    var existingItem = self._droppointById(null, item.droppointId);
                    if (existingItem) {
                        existingItem.chosen = item.chosen;
                    }
                    return existingItem || item;
                });
            },

            _addDropPointDeliveries: function()
            {
                var self = this;
                this._dropPoints.map(
                    function (item) {
                        item.collectionPoint = true;

                        //TODO: This often seems to return delivery method IDs associated with the wrong provider?
                        item.deliveries = self._findDropPointDeliveries(item.providerId);
                        return item;
                    }
                );
                console.log(this._dropPoints);
            },
            
            // find the earliest of each service
            _getGroupedByService: function() {
                var self = this;
                var results = [];
                var services = [];

                // find the earliest of each non day definite service
                this._data.nonDayDefinite.forEach(function(day) {
                    day.rates.forEach(function(service) {
                        if (service.serviceType.type === "dmStandard") {
                            if (typeof(services[service.methodTitle]) === "undefined") {
                                services[service.methodTitle] = {
                                    deliveryDate: day.deliveryDate,
                                    service: service
                                };
                            } else {
                                var servicesDay = new Date(services[service.methodTitle].deliveryDate)
                                var nonDayDefiniteDay = new Date(day.deliveryDate);
                                if (servicesDay.getTime() > nonDayDefiniteDay.getTime())
                                    services[service.methodTitle] = {
                                        deliveryDate: day.deliveryDate,
                                        service: service
                                    };
                            }
                        }
                    });
                });

                // create array for display in polymer
                for (var service in services) {
                    var item = services[service];
                    var obj = {
                        id: item.service.id,
                        methodTitle: item.service.methodTitle,
                        price: item.service.price,
                    };
                    // non day definite
                    var startDate = new Date(item.deliveryDate);
                    var endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + (item.service.maxDD - 1));
                    obj.deliveryDateRange = this._formatNonDayDefiniteDate(startDate, endDate);
                    obj.deliveryTimeFrom = endDate.getTime();
                    results.push(obj);
                }
                return results;
            },

            _getDeliveryRateById: function(id) {
                var combinedRateGroups = this._data.dayDefinite.concat(this._data.nonDayDefinite);
                var rates = [];
                combinedRateGroups.forEach(function(group) {
                    rates = rates.concat(group.rates);
                });
                var resultList = rates.filter(function(rate) {
                    return rate.id == id
                });
                if (resultList.length) {
                    if (resultList.length > 1) {
                        console.warn("getDeliveryRateById(): Multiple matches");
                    }
                    return resultList[0];
                } else return null;
            },

            _processNonDayDefiniteData: function() {
                if (this._data.nonDayDefinite.constructor === Array && this._data.nonDayDefinite.length > 0) {
                    this._data.standardRates = this._getGroupedByService();
                    this.standardRates = this._data.standardRates;
                }
            },

            _processDayDefiniteData: function() {
                this.notifyPath('_data.dayDefinite');
            },

            _makeMap: function () {
                var self = this;

                var home = null;

                self._infoWindow = new google.maps.InfoWindow({
                    content: self.$.droppoint_info
                });
                var position = new google.maps.LatLng(37, 0);

                // map options
                var mapOptions = {

                    // initial zoom level
                    zoom: self.startingZoomLevel,
                    minZoom: self.startingZoomLevel - 2,

                    // initial center position
                    center: position,

                    // type of map (ROADMAP, SATELLITE, TERRAIN, HYBRID)
                    mapTypeId: google.maps.MapTypeId.TERRAIN,

                    // show or hide streetview control
                    streetViewControl: false,

                    // show or hide the google map UI
                    disableDefaultUI: self.hideMapUI,

                    // map controls (only if disableDefaultUI is false)
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                        position: google.maps.ControlPosition.TOP_RIGHT,
                    },

                    zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.SMALL,
                        position: google.maps.ControlPosition.TOP_RIGHT
                    },

                    // remove points of interest from the map so as not to interfere
                    styles: [{
                        "featureType": "poi",
                        "elementType": "labels",
                        "stylers": [{
                            "visibility": "off"
                        }]
                    }]
                };

                //var postcode = document.getElementById('shipping:postcode').value; //Improve selection method

                self._map = new google.maps.Map(self.$.gfsMapCanvas, mapOptions);
                window.map = self._map;            

                //=== Home marker
                //TODO: Replace with call to geoCodeAddress
                /*
                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    componentRestrictions: {
                        country: this.countryCode,
                        postalCode: this.postCode
                    }
                }, function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        //self._map.setCenter(results[0].geometry.location);
                        var homeMarkerConfig = {
                            position: results[0].geometry.location,
                            map: self._map,
                            //animation: google.maps.Animation.DROP,
                            title: 'Home',
                            html: 'Home',
                            icon: self._getHomeIcon()
                        };
                        marker = new google.maps.Marker(homeMarkerConfig);
                        self._map.setCenter(homeMarkerConfig.position);
                        self._loadDroppointMarkers();
                        //self._showDropPointsView();
                        self._resetMap(self._map);
                    } else {

                        console.log('Google Maps API ERROR - Geocode was not successful for the following reason: ' + status);
                        //TODO: Include this in the template, instead of in code
                        $("#gfsMapCanvas").append("<div style='color: #d60000; margin: 20px auto; text-align: center;'> Postcode <strong>" + self.initialAddress + "</strong> return zero restults </div>");
                    }
                });
                */


                // 'idle' event is triggered when the user stopped zooming/dragging;
                google.maps.event.addListener(self._map, 'idle', function (event) {
                    //console.log(JSON.stringify(event));
                    //console.log('MAP EVENT idle');
                    self._mapMoved();
                });

                google.maps.event.addListener(self._map, 'click', function (event) {
                    //console.log('MAP EVENT click');
                    self._unselectDropPoint();
                });

                google.maps.event.addListener(self._map, 'center_changed', function (event) {
                    //console.log('MAP EVENT center_changed');
                    //self._unselectDropPoint();
                });

            },

            _loadDroppointMarkers: function (dropPointsArray) {
                var self = this;
                if (!dropPointsArray) return;
                //=== Drop point markers
                var marker;
                dropPointsArray.forEach(
					function (pointItem) {
					    var getCountryCode = pointItem.geoLocation.countryCode;
					    var markerConfig = {
					        position: new google.maps.LatLng(pointItem.geoLocation.coordinates.latitude, pointItem.geoLocation.coordinates.longitude),
					        map: self._map,
					        //animation: google.maps.Animation.DROP,
					        title: pointItem.droppointDescription,
					        customData: pointItem,
					        icon: self._droppointIcon(getCountryCode) + '/' + pointItem.providerName + '.png',
					        zIndex: google.maps.Marker.MAX_ZINDEX + 1
					        //icon: url + '/' + pointItem.geoLocation.countryCode + '/' + pointItem.providerName + '.png'
					    };
					    //console.log(pointItem.geoLocation.coordinates.longitude, pointItem.geoLocation.coordinates.latitude);
					    marker = new google.maps.Marker(markerConfig);
					    marker.addListener('click', function (clickedMarker) {
					        //debugger;
					        self._selectDropPointMarker(this);
					    });
					    // add a link to the marker to get to it from the droppoint, need to animate and centre the marker if selecting from list view
					    pointItem.marker = marker;
					}
				);
                this.$.dropPointListTemplate.render();

            },

            _droppointIcon: function(countryCode) {
                var url = this.resolveUrl('./images/');

                switch (countryCode) {
                    case "DE":
                        return url + '/DE/';
                    case "FR":
                    case "BE":
                    case "ES":
                        return url + '/FR/';
                    default:
                        return url + '/GB/';
                }
            },

            _onPostcodeSearchKeyDown: function (e) {
                //console.log(e);
                if (e && e.key && e.key === 'Enter') {
                    this._findPostcode();
                }
                else {
                    this._delayedPostcodeSearch();
                }
            },

            _delayedPostcodeSearch: function () {
                if (this._searchTimeout) {
                    window.clearTimeout(this._searchTimeout);
                }
                this._searchTimeout = window.setTimeout(this._findPostcode.bind(this), 300);
            },

            // Geocode service search
            _findPostcode: function () {
                if (this._searchTimeout) {
                    window.clearTimeout(this._searchTimeout);
                }
                var self = this;
                var postcode = this.$.droppointAddress.value || this.postCode;
                //self.initialAddress = address;
                //self.$$("#gfsMapCanvas-loading").classList.remove('hidden');

                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    componentRestrictions: {
                        country: this.countryCode,
                        postalCode: postcode
                    }
                }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {

                        self._panToGeoLocation({ lat: results[0].geometry.location.lat(), lng: results[0].geometry.location.lng() });

                        marker = new google.maps.Marker({
                            map: self._map,
                            icon: self._getHomeIcon(),
                            position: results[0].geometry.location
                        });
                    }

                    else {
                        /*
                        console.log('Google Maps API ERROR - Geocode was not successful for the following reason: ' + status);
                        self.$$("#gfsMapCanvas-loading").classList.add('hidden');
                        self.$.errorNotification.text = "Postcode not found";
                        self.$.errorNotification.fitInto = self.$.gfsMapCanvas;
                        self.$.errorNotification.open();
                        */
                    }
                });
            },


            _geoCodeAddress: function (streetAddress, postCode, countryCode, callback) {
                var addressStr = streetAddress + "," + postCode;
                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    componentRestrictions: {
                        country: countryCode || this.countryCode
                    },
                    address: addressStr
                },
                function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        if (results && results.length) {
                            var geoLocation = results[0].geometry.location;
                            callback(null, geoLocation);
                        }
                    }
                    else {
                        callback("No results");
                    }
                });
            },

            _mapMoved: function() {
                var self = this;
                if (self._moveMapTimeout) {
                    window.clearTimeout(self._moveMapTimeout);
                }
                self._moveMapTimeout = window.setTimeout((function() {
                    self._reloadDroppoints();
                }).bind(this), 100);

            },

            // used for trouble shooting
            _drawBoxes: function(boxes, color) {
                var self = this;
                boxes.forEach(function(rect) {
                    var boxCoords = [{
                        lat: rect[0][1],
                        lng: rect[0][0]
                    }, // north west
                        {
                            lat: rect[0][1],
                            lng: rect[1][0]
                        }, // south west
                        {
                            lat: rect[1][1],
                            lng: rect[1][0]
                        }, // south east
                        {
                            lat: rect[1][1],
                            lng: rect[0][0]
                        } // north east
                    ]

                    self._map.data.setStyle({
                        fillColor: color,
                        strokeColor: color,
                        strokeWeight: 2
                    });
                    self._map.data.add({
                        geometry: new google.maps.Data.Polygon([boxCoords])
                    });
                });
            },

            _updateMapViewPort: function() {
                var bounds = this._map.getBounds();
                if (!bounds) {
                    console.error("Failed to get map bounds");
                    return;
                }          
                var northEast = [bounds.getNorthEast().lng(), bounds.getNorthEast().lat()];
                var southWest = [bounds.getSouthWest().lng(), bounds.getSouthWest().lat()];
                if (northEast[0] === southWest[0] && northEast[1] === southWest[1]) return;
                this._mapViewPort = [southWest, northEast];
            },

            
            _reloadDroppoints: function() {
                if (this._sessionId) {
                    //console.log('reloadDroppoints()');

                    //Get viewport rectangle
                    this._updateMapViewPort();
                    if (!this._mapViewPort) return;

                    var boxes = [];
                    
                    this.$.regionManager.getUncoveredRectangles(this._mapViewPort).forEach(function (rect) {
                        boxes.push(rect.toGeoBox());
                    });

                    // console.log('Boxes to request:', JSON.stringify(boxes));
                    // self._drawBoxes(boxes, 'green');
                    
                    if (boxes.length > 0 && this._mapViewPort) {
                        this.$.regionManager.addRegion(this._mapViewPort);
                        this._requestDroppointsByGeoBoxes(boxes, function () { });
                    }
                    else {
                        console.log("Not requesting any regions");
                    }

                    
                    this._resetMap(this._map);
                }
            },

            _requestDroppointList: function (droppointList, callback) {
                //NOTE: This is temporary code, to be replaced by a dedicated API endpoint
                if (droppointList.length === 0) {
                    callback();
                }
                else {
                    var self = this;

                    //Make array of geoBoxes, tightly encompassing each droppoint
                    var boxes = [];
                    droppointList.forEach(function (dp) {
                        boxes.push([[dp.geoLocation.coordinates.longitude - 0.000001, dp.geoLocation.coordinates.latitude - 0.000001], [dp.geoLocation.coordinates.longitude + 0.000001, dp.geoLocation.coordinates.latitude + 0.000001]]);
                    });
                    this._requestDroppointsByGeoBoxes(boxes, callback);
                }

            },



            _showDropPointDetails: function() {
                this.mapHeight = this.$.gfsMapCanvas.clientHeight;
                this._dropPointDetailsClass = "fade-in";
            },

            _toggleDroppointView: function() {
                this._showingDroppointsList = !this._showingDroppointsList;
                this._showingDroppointsMap = !this._showingDroppointsMap;
                this._showDropPointsView();
            },

            _showDropPointsView: function () {
                var self = this;
                this.fire('show-droppoints');
                if (this._showingDroppointsMap) {
                    //Show droppoints
                    this.$.dropPointListContainer.classList.add('hidden');
                    this.$.mapContainer.classList.remove('hidden');
                    //this._makeMap();
                    this._loadDroppointMarkers(this._dropPoints);                                                                           
                    this._resetMap(this._map);
                    this._fixMapMarker();
                    this.panToDefaultLocation();

                }
                else {
                    this.$.dropPointListContainer.classList.remove('hidden');
                    this.$.mapContainer.classList.add('hidden');
                    this._resetMap(this._map);
                    this._fixMapMarker();
                }

            },

            _resetMap: function (map) {
                var self = this;
                if (map) {
                    window.setTimeout(function () {
                        google.maps.event.trigger(map, 'resize');
                        
                    }, 100);
                }           
            },

            _hideDropPointDetails: function() {
                this._dropPointDetailsClass = "fade-out";
            },

            _showPreferredDroppoints: function () {
                this.$.mainMapArea.classList.add("showPreferredDroppoints");
                this.$.mainDropPointListArea.classList.add("showPreferredDroppoints");
                var self = this;
                this._resetMap(this._map);
            },

            _getHomeIcon: function() {
                if (this.homeIcon) {
                    return this.homeIcon;
                } else {
                    return this.resolveUrl('./images/home.png');
                }
            },

            //Select a drop point marker
            _selectDropPointMarker: function (marker) {
                this.selectDropPoint(marker.customData.droppointId);
                //marker.customData.chosen = true;
                //this.fire("droppoint-changed", marker.customData);
            },

            selectDropPoint: function(dropPointId) {
                //Select the drop point, if it is known.
                var dp = this._droppointById(null, dropPointId);
                if (dp) {
                    this.set("_selectedDropPoint", dp);
                    this.set('_selectedDropPoint.chosen', true);
                    this.fire("droppoint-changed", dp);
                }
                else {
                    console.log("Couldn't find droppoint", dropPointId);
                }
            },

            _unselectDropPoint: function() {
                if (this._selectedDropPoint) {
                    if (this._infoWindow) {
                        this._infoWindow.close();
                    }
                    this._hideDropPointDetails();
                    this._selectedDropPoint.chosen = false;
                    this._selectedDropPoint = null;
                    //this._preselectForStandard();
                }
            },

            _chooseDroppointEvent: function (e) {
                this.chooseDroppoint(e.detail);
            },

            chooseDroppoint: function(droppoint) {
                this.chooseDropPointId(droppoint.droppointId);
            },

            chooseDropPointId: function(droppointId) {
                var dp = this._droppointById(null, droppointId);
                if (dp) {
                    this.selectDropPoint(droppointId);
                    this.set('_selectedDropPoint.chosen', true);
                    //this.fire("droppoint-changed", this._selectedDropPoint);
                }
            },

            _fixMapMarker: function () {
                if (this._showingDroppointsMap && this._selectedDropPoint) {
                    var dp = this._droppointById(this._selectedDropPoint.providerId, this._selectedDropPoint.droppointId);
                    if (dp) {
                        this._currentMarker = dp.marker;
                    }
                    else {
                        //Make a marker
                        this._loadDroppointMarkers([this._selectedDropPoint]);
                        this._currentMarker = this._selectedDropPoint.marker; //this._droppointById(this._selectedDropPoint.providerId, this._selectedDropPoint.droppointId).marker;
                    }
                    //console.log("### Opening info box");
                   
                    this.$.dropPointRadio.setAttribute('checked', 'true');
                    this._map.panTo(this._currentMarker.getPosition());
                    var self = this;
                    window.setTimeout(function () {
                        self._infoWindow.open(self._map, self._currentMarker);
                    }, 200);
                }
            },

            _droppointChanged: function(e) {
                //console.log('_droppointChanged', e.detail);
                var changedDroppoint = e.detail;

                if (this._selectedDropPoint)
                    if (changedDroppoint.droppointId !== this._selectedDropPoint.droppointId)
                        this._unselectDropPoint();

                this.set("_selectedDropPoint", changedDroppoint);
                this.$.dropPointListTemplate.render(); //Re-sort the list of drop point cards
                //this.$.listPreferredDropPointList.render(); //Re-sort the preferred list
                this._fixMapMarker();            
            },

            _droppointById: function (providerId, droppointId) {
                if (!this._dropPoints) {
                    return;
                }
                for (var i = 0; i < this._dropPoints.length; i++) {
                    if (/*(this._dropPoints[i].providerId === providerId) && */(this._dropPoints[i].droppointId === droppointId)) {
                        return this._dropPoints[i];
                    }
                }
            },

            _locateMe: function() {
                var self = this;
                // Try HTML5 geolocation.
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            var pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            self._map.setCenter(pos);

                        },
                        function() {
                            handleLocationError(true, self._infoWindow, GMap.getCenter());
                        }
                    );
                } else {
                    // Browser doesn't support Geolocation
                    //handleLocationError(false, infoWindow, GMap.getCenter());
                }
            },

            setMapHome: function(location) {
                var homeMarkerConfig = {
                    position: location,
                    map: this._map,
                    //animation: google.maps.Animation.DROP,
                    title: 'Home',
                    html: 'Home',
                    icon: this._getHomeIcon()
                };
                marker = new google.maps.Marker(homeMarkerConfig);
                //this._map.setCenter(homeMarkerConfig.position);
            },

            panToDefaultLocation: function () {
                var self = this;
                if (this._postData.Request.Order.Transit.Recipient.Location) {
                    var location = this._postData.Request.Order.Transit.Recipient.Location;
                    this._geoCodeAddress(location.addressLineCollection[0], location.Postcode, location.CountryCode.Code, function (err, data) {
                        if (err) {
                            console.error('panToDefaultLocation():', err);
                        }
                        else {
                            var geoLocation = {
                                lat: data.lat(),
                                lng: data.lng()
                            };

                            self._panToGeoLocation(geoLocation);
                            self.setMapHome(geoLocation);
                        }

                    });

                }
                else if (this._consumerAddresses.length) {
                    if (this._consumerAddresses[0].geoLocation.coordinates.latitude && this._consumerAddresses[0].geoLocation.coordinates.longitude) {
                        var geoLocation = {
                            lat: this._consumerAddresses[0].geoLocation.coordinates.latitude,
                            lng: this._consumerAddresses[0].geoLocation.coordinates.longitude
                        };
                        this._panToGeoLocation(geoLocation);
                    }
                }
            },


            _makeDateStr: function(d) {
                function pad(n, padSize) {
                    var str = n.toString();
                    var padZeros = (new Array(padSize)).join('0');
                    return (padZeros + str).substr(-padSize);
                }
                return (
                    pad(d.getFullYear(), 4) + '-' +
                    pad(d.getMonth() + 1, 2) + '-' +
                    pad(d.getDate(d), 2)
                );
            },

            _selectCalendarShippingOption: function (e) {
                //console.log('Updating delivery options with', e.detail.shippingMethodId, e.detail.deliveryDate);
                this.updateDeliveryOptions(e.detail.shippingMethodId, e.detail.deliveryDate);
            },

            _formatDayDefiniteDate: function(deliveryDate) {
                return '(Est. arrival: ' + moment(deliveryDate).format("ddd, Do MMM") + ')';
            },

            _formatNonDayDefiniteDate: function(startDate, endDate) {
                return '(Est. arrival: ' + moment(startDate).format("ddd, Do MMM") + ' - ' + moment(endDate).format("ddd, Do MMM") + ')';
            },

            _findDropPointDeliveries: function(providerId) {
                var self = this;
                //var droppointIndex = providerId;
                if (typeof (this._deliveryDroppoints[providerId]) !== "undefined") {
                    var results = [];
                    for (var service in this._deliveryDroppoints[providerId]) {
                        var item = this._deliveryDroppoints[providerId][service];
                        var obj = {
                            id: item.service.id,
                            methodTitle: item.service.methodTitle,
                            price: item.service.price,
                        };
                        if (item.service.maxDD == item.service.minDD) {
                            // day definite
                            var startDate = new Date(item.deliveryDate);
                            obj.deliveryDateRange = this._formatDayDefiniteDate(startDate);
                        } else {
                            // non day definite
                            var startDate = new Date(item.deliveryDate);
                            var endDate = new Date(startDate);
                            endDate.setDate(endDate.getDate() + (item.service.maxDD - 1));
                            obj.deliveryDateRange = this._formatNonDayDefiniteDate(startDate, endDate);
                        }
                        results.push(obj);
                    }
                    return results;
                } else {
                    return null;
                }
            },

            //Make a lookup for droppoint provider, allowing all shipping methods for that provider to be returned
            _processDeliveryArray: function (obj) {
                var self = this;
                obj.forEach(function(day) {
                    day.rates.forEach(function(service) {
                        if (service.serviceType.type === "dmStandardDropPoint") {
                            service.serviceType.droppointProviders.forEach(function (provider) {
                                //console.log('PROVIDER:', provider.id, provider.name);
                                if (typeof(self._deliveryDroppoints[provider.id]) === "undefined")
                                    self._deliveryDroppoints[provider.id] = [];
                                if (typeof(self._deliveryDroppoints[provider.id][service.methodTitle]) === "undefined") {
                                    self._deliveryDroppoints[provider.id][service.methodTitle] = {
                                        deliveryDate: day.deliveryDate,
                                        service: service
                                    };
                                } else {
                                	var objsDay = new Date(self._deliveryDroppoints[provider.id][service.methodTitle].deliveryDate);
                                	var droppointDay = new Date(day.deliveryDate);
                                	if (objsDay.getTime() > droppointDay.getTime())
                                    if (self._deliveryDroppoints[provider.id][service.methodTitle].deliveryDate < day.deliveryDate) {
                                        self._deliveryDroppoints[provider.id][service.methodTitle] = {
                                            deliveryDate: day.deliveryDate,
                                            service: service
                                        };
                                    }
                                }
                            });
                        }
                    });
                });
            },

            _findAllDeliveryDroppoints: function() {
                this._processDeliveryArray(this._data.dayDefinite);
                this._processDeliveryArray(this._data.nonDayDefinite);
            },

            _selectService: function (id) {
                var serviceSelected = null;
                if (this.standardRates && this.standardRates.length) {
                    this.standardRates.map(function (item) {
                        item.selected = (item.id == id);
                        if (item.selected) {
                            serviceSelected = item;
                        }
                        return item;
                    });
                    this.set('standardRates', JSON.parse(JSON.stringify(this.standardRates)));
                    //if (serviceSelected) return serviceSelected;
                }

                if (this.dayDefinite && this.dayDefinite.length) {
                    this.dayDefinite.map(function (item) {
                        item.selected = (item.id == id);
                        if (item.selected) serviceSelected = item;
                        return item;
                    });
                    return serviceSelected;
                }
                else return null;
            },

            _preselectForCalendar: function() {
                this.$.calendar.autoSelect();
            },

            _preselectForStandard: function () {
                if (this.standardRates) {
                    //this.set('_selectedDropPoint', null);
                    this._unselectDropPoint();
                    var preselectedService = this.standardRates[0];
                    if (!preselectedService.selected) {
                        preselectedService.selected = true;
                    }                   
                    
                    this.updateDeliveryOptions(preselectedService.id, preselectedService.deliveryDate);
                    this.set('standardRates', JSON.parse(JSON.stringify(this.standardRates)));
                    this.$.standardRatesTemplate.render();
                    this.fire('selectedservicechanged', this.selectedServiceDetails);//.standardRates[0]);
                    this.fire('preselectedservice', this.selectedServiceDetails);
                }

            },

            _selectCheapestMethod: function (cheapestMethod) {
                /*
				cheapestMethod.selected = true;
				var method = this._getDeliveryRateById(cheapestMethod.id);
				this.selectedServiceDetails.serviceId = method.id;
				this.selectedServiceDetails.service = method.methodTitle;
				this.selectedServiceDetails.serviceCode = method.carrierCode;
				this.selectedServiceDetails.carrier = method.carrierName;
				this.selectedServiceDetails.shipping = method.price;
			    //this.selectedServiceDetails.expDeliveryDateStart = moment(method.deliveryTimeFrom).toISOString();
				this.selectedServiceDetails.expDeliveryDate = moment.utc(method.deliveryTimeTo).toISOString();
				//this.selectedServiceDetails.expDeliveryDateEnd = moment(method.deliveryTimeFrom).add(method.maxDD - method.minDD, 'days').toISOString();
				this.selectedServiceDetails.checked = cheapestMethod.selected;
				this.selectedServiceDetails.currencySymbol = this.currencySymbol;

                if (this._selectedDropPoint) {
					this.selectedServiceDetails.collectionPoint = this._selectedDropPoint.droppointId;
					this.selectedServiceDetails.deliveryAddress = this._selectedDropPoint.geoLocation;
				} else {
					this.selectedServiceDetails.collectionPoint = null;
					this.selectedServiceDetails.deliveryAddress = actualPost.Request.Order.Transit.Recipient.Location; //TODO: What is this?
                }
				this.fire('selectedservicechanged', this.selectedServiceDetails);
				this.fire("getStandardSelectedService", this.selectedServiceDetails);*/
			},


            getChosenServiceDetails: function() {
				return JSON.stringify(this.selectedServiceDetails);
            },

            _unselectMethod: function() {
                var methods = this.standardRates;
                methods.forEach(function (item) {
                    item.selected = false;
                });
            },

            //Select a delivery service
            updateDeliveryOptions: function (methodId, dateOverride) {
                //debugger;
                /*this._unselectMethod();
                if (this.selectedServiceDetails) {
                    var currentMethod = this._getDeliveryRateById(this.selectedServiceDetails.serviceId);
                    if (currentMethod) {
                        currentMethod.selected = false;
                        // this.notifyPath('_data.standardRates');


                        var _data = JSON.parse(JSON.stringify(this.standardRates));
                        this.set('standardRates', _data);
                        
                    }
                }
                this.$.standardRatesTemplate.render();
                //zzzzzzzzz
                */
                var newMethod = this._getDeliveryRateById(methodId);
                if (!newMethod) {
                    console.error("Method not available");
                    this.fire('noservice');
                    return;
                }
                else {
                    this.selectedServiceDetails.serviceId = methodId;
                    this.selectedServiceDetails.service = newMethod.methodTitle;
                    this.selectedServiceDetails.serviceCode = newMethod.carrierCode;
                    this.selectedServiceDetails.carrier = newMethod.carrierName;
                    this.selectedServiceDetails.shipping = newMethod.price;
                    this.selectedServiceDetails.selected = true;
                    this.selectedServiceDetails.checked = true;
                    this.selectedServiceDetails.currencySymbol = this.currencySymbol;

                    if (dateOverride) {
                        this.selectedServiceDetails.expDeliveryDate = moment.utc(dateOverride).toISOString();
                    }
                    else {
                        this.selectedServiceDetails.expDeliveryDate = moment.utc(newMethod.deliveryTimeTo).add(newMethod.maxDD - newMethod.minDD, 'days').toISOString();
                    }

                    if (this._selectedDropPoint) {
                        this.selectedServiceDetails.collectionPoint = this._selectedDropPoint.droppointId;
                        this.selectedServiceDetails.providerId = this._selectedDropPoint.providerId;
                        this.selectedServiceDetails.provider = this._selectedDropPoint.providerName;
                        this.selectedServiceDetails.deliveryAddress = this._selectedDropPoint.geoLocation;
                    }
                    else {
                        this.selectedServiceDetails.collectionPoint = null;
                        this.selectedServiceDetails.providerId = null;
                        this.selectedServiceDetails.provider = null;
                        this.selectedServiceDetails.deliveryAddress = null;
                    }

                    this._selectService(methodId);
                    //this.set('standardRates', JSON.parse(JSON.stringify(this.standardRates)));
                    //debugger;
                    this.$.standardRatesTemplate.render();
                    this.fire('selectedservicechanged', this.selectedServiceDetails);
                }
            },


            updateDeliveryOptionsEvent: function (e) {
                if (e.target.checked) {                    
                    this.updateDeliveryOptions(e.target.id);
                }
            },

            onUpdateDroppointDeliveryOptions: function(e) {
                this.updateDeliveryOptions(e.detail);
            },

            onSelectTab: function (e) {
                if (e.detail.item.id === "pageCalendar") {
                    this.onShowPage_Calendar();
                }
                else if (e.detail.item.id === "pageStandard") {
                    this.onShowPage_Standard();
                }
                else if (e.detail.item.id === "pageDroppoints") {
                    this.onShowPage_Droppoints();
                }
                else {
                    console.error("Unknown tab");
                }
            },

            showPage_Calendar: function() {              
                this.$.pages.select(0);
                this.onShowPage_Calendar();              
            },

            onShowPage_Calendar: function(preselect) {
                this.showingDroppoints = false;
                //TODO: Choose soonest option by default
                
                this._unselectDropPoint();
                if (preselect) {
                    this._preselectForCalendar();                  
                }
               
                this.fire('show-calendar');
            },

            showPage_Standard: function (preselect) {
                this.$.pages.select(2)           
                this.onShowPage_Standard(preselect);
			},

			onShowPage_Standard: function(preselect) {
			    this.showingDroppoints = false;
                //If preselect override,
			    if (typeof (preselect) !== "undefined") {
			        if (preselect) {
			            this._preselectForStandard();
			        }                   
			    }
			    else {
			        if (this.preselect) {
			            this._preselectForStandard();
			        }
			    }
			    //zzzzz
			    this.$.standardRatesTemplate.render();
			    this.fire('show-standard');
			},

            showPage_Droppoints: function () {
                this.$.pages.select(1);
                this.onShowPage_Droppoints();
            },

            onShowPage_Droppoints: function() {
            	if (this._map) {
                    this.showingDroppoints = true;
                    this._showDropPointsView();
                }
            },

			showView_DroppointsList: function() {

			},

			_onClickDroppoint: function(e) {
			    this.selectDropPoint(e.detail);
			},

			broadcastState: function () {
			    //fire events relating to UI state
			    if (this.showingDroppoints) {
			        this.showPage_Droppoints();
			    }
			    else {
			        //this.showPage_Standard();
			    }
			},

			_onClickConsumerAddress: function (e) {
			    this._panToGeoLocation(e.currentTarget.geoLocation);
			},

			_onSelectPreferredDroppoint: function (dp) {
			    var geoLocation = {
			        lat: dp.currentTarget.droppointData.geoLocation.coordinates.latitude,
			        lng: dp.currentTarget.droppointData.geoLocation.coordinates.longitude
			    };
			    this._panToGeoLocation(geoLocation);
			},

			_panToGeoLocation: function (geoLocation) {
                this._map.panTo(geoLocation);
                this._mapViewPort = [[ geoLocation.lng - 0.01,geoLocation.lat - 0.01], [geoLocation.lng + 0.01, geoLocation.lat + 0.01]];
			},

			_panToPlace: function (e) {
			    this._panToGeoLocation(e.detail.geometry.location);
            }

        });
    </script>
</dom-module>
<script src="../../webcomponentsjs/webcomponents.min.js"></script>
<link rel="import" href="../../polymer/polymer.html"/>
<link rel="import" href="../local-image/local-image.html" />

<dom-module id="gfs-droppoint">

	<template>
		<style>
            .content {
                 cursor: pointer;
            }

			h3 {
				margin-top: 0px;
			}

			ul {
				padding-left: 2px;
			}

			li {
				display: flex;
                flex-direction: row;
			}

			tr {
				line-height: 0.6em;
			}

			.content-container {
				margin: auto;
				/*width: 100%;*/
                cursor: pointer;
			}

			.overlay {
				margin: auto;
				width: 100%;
			}

			.overlay .special-badges {
				float: none;
			}

            .overlay #dp-minor-info {
                display: block;
            }

            .dp-large-card .dp-details {
                display: flex;
                flex-direction: row;     
                min-height: 175px;     
            }

            .dp-large-card #dp-minor-info {
                display: block;
                
            }

			.no-button button {
				display: none;
			}

			.no-button.dp-card .actions {
				display: none;
			}

			.no-button.dp-card {
				/*height: 208px;*/
			}

			.dp-card {
				padding: 10px;
				margin: 10px;
				background-color: #FAFAFA;
				border-radius: 3px;
				box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
				border: 1px solid #FAFAFA;
			}

            .dp-large-card {
				padding: 10px;
				margin: 10px;
				background-color: #FAFAFA;
				border-radius: 3px;
				box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
				border: 1px solid #FAFAFA;
			}

			.dp-mini-card {
				padding: 10px;
				background-color: #FAFAFA;
				border-radius: 3px;
				box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
				border: 1px solid #FAFAFA;
                margin-right: 20px;
                margin-bottom: 10px;
			}


			.dp-card .content {
				display: flex;
			}

			.dp-card .content .dp-details {
				width: 66%;
				overflow: hidden;
			}

			.dp-small-heading {
				margin-top: 8px;
				margin-bottom: 0px;
				font-size: 0.6em;
			}

			.label {
				color: white;
				font-weight: bold;
			}

			.dp-content {
				width: 100%;
			}

			#dp-address {
				text-align: left;
                clear: both;            
			}

			.open-late {
				font-size: 0.5em;
				padding: 4px;
			}

			#dp-distance {
				margin-bottom: 0px;
			}

				#dp-distance .fa {
					margin-right: 0.2em;
				}

			.choose-droppoint {
				background-color: #555555;
				border: none;
				color: white;
				margin-top: 3px;
				padding: 8px 20px;
				text-align: center;
				text-decoration: none;
				font-size: 16px;
				/*float: right;*/
				cursor: pointer;
				transition: opacity 300ms ease-in-out 
			}

			.choose-droppoint:hover {
				opacity: .85;
			}

			.choose-droppoint.selected {
				background-color: #4CAF50; /* Green */
			}

			.choose-droppoint.unselected:hover {
				opacity: 1;
			}

			.choose-droppoint.unselect {
				background-color: #d60000; /* Green */
			}

			.choose-droppoint.unselect:hover {
				opacity: 1;
			}

			.dp-opening-hours table {
				margin-top: 6px;
			}

			div.dp-day-name {
				font-weight: bold;
			}

			.b-cancel {
			}

			.b-tick {
				display: block;
				height: 32px;
				width: 32px;
                float: right;
			}

			.b-tick.not-selected {
                display: none;
				background-image: url('./images/tick.png');
				background-position: -6px 0;
				background-repeat: no-repeat;
			}

			.b-tick.selected {
				background-image: url('./images/tick_on.png');
				background-position: -6px 0;
				background-repeat: no-repeat;
			}

			.special-badges {
				margin: 5px 0 0;
				display: flex;
				float: right;
			}

			.open-late {
				background-image: url('./images/opensign.png');
				background-repeat: no-repeat;
				background-size: 26px 26px;
				width: 32px;
			}

			.parking {
				background-image: url('./images/parking.png');
				background-repeat: no-repeat;
				background-size: 32px 32px;
				width: 32px;
			}

			.open-late .badge-text {
				margin-top: 22px;
				font-weight: bold;
			}

			.overlay .open-late {
				-webkit-filter: invert(1);
				filter: invert(1);
			}



			/* MP customization */
			.dp-card {
				width: 336px;
				height: 340px;
				margin: 10px 20px 10px 0;
			}

            .dp-mini-card {
			}

            .dp-large-card {
                width: auto;
            }

            .dp-large-card .content {
                display: flex;
                flex-direction: row;
            }

            .dp-large-card .dp-opening-hours {
                width: 280px;
                xpadding-left: 10px;
            }

            .dp-large-card .dp-header {
                width: 300px;
                margin-right: 10px;
            }

            label {
                display: block;
                margin-top: 4px;
                padding-top: 2px;
                padding-left: 4px;
            }


			/* opening hours table style */
			td.dp-day-time-slots {
				line-height: 10px;
			}

			.dp-day-name, .dp-day-time-slot {
				font-size: 13px;
			}

			.multi-times {
				line-height: 20px
			}

			.dp-icon {
				margin: 0 0 5px;
                float: left;
			}

			#dp-address, #dp-distance {
				font-size: 13px;
			}

            #dp-distance {
                margin-right: 10px;
            }

			/* clear floats */
			.clear-fl {
				clear: both;
			}

			.overlay {
				font-size: 13px;
			}

			#dp-address {
				max-width: 200px;
			}

            input[type="radio"] {
                display: inline-block;
            }

            span.gfsmethodname {
                display: flex;
                flex-direction: row;
            }

            #dp-body {
                width: 100%;
                overflow: hidden;
                padding: 0px;
                margin: 0px;
            }

		</style>


		<div class$="{{containerClass}}" on-click="_onClick">
			<template is="dom-if" if="{{title}}">
				<h3>{{title}}</h3>
			</template>

			<div class="content">

				<div class="dp-details">
                    <div class="dp-header">
                        <div class="dp-icon">
                            <template is="dom-if" if="{{droppointData.providerName}}">
                                <local-image img-src="{{droppointData.providerName}}.png" local-folder="gfs-droppoint/images" class="imageicon" height="45"></local-image>
                                <b class="dpProviderName">{{droppointData.providerName}}</b>
                            </template>
                        </div>
                        <template is="dom-if" if="{{_isTickButton}}">
                            <div class$="b-tick {{buttonClass}}"></div>
                        </template>
                        <div id="dp-address">
                            <template is="dom-repeat" items="{{droppointData.geoLocation.addressLines}}">
                                {{item}}
                                <br />
                            </template>
                            {{droppointData.geoLocation.town}}, {{droppointData.geoLocation.postCode}}

                        </div>
                        <template is="dom-if" if="{{showDistance}}">
                            <div id="dp-distance">
                                <div class="dp-small-heading">Distance</div>
                                <i class="fa fa-road"></i>{{droppointData.localizedDistance}}
                            </div>
                        </template>

                    </div>

                    <div id="dp-body">
                        <div id="dp-minor-info">

                            <template is="dom-if" if="{{showOpeningHoursLink}}">

                                <div id="opening-hours-link">
                                    <div class="dp-small-heading">Opening Hours</div>
                                    <a class="droppoint_info" on-click="_openingHoursLinkClick"> View Opening Hours </a>
                                </div>
                            </template>


                            <template is="dom-if" if="{{showOpeningHours}}">

                                <div class="dp-opening-hours">
                                    <div class="dp-small-heading">Opening Hours</div>
                                    <table>
                                        <template is="dom-repeat" items="{{_weekCollection}}">
                                            <tr>
                                                <td class="dp-day-name"><ul><li>{{item.day}}</li></ul></td>
                                                <td class="dp-day-time-slots">
                                                    <ul class="testMe">
                                                        <template is="dom-repeat" items={{item.timeSlots}}>
                                                            <li class="dp-day-time-slot">{{item.fromTime}} - {{item.toTime}}</li>
                                                        </template>
                                                    </ul>
                                                </td>
                                            </tr>
                                        </template>
                                    </table>
                                </div>

                            </template>
                        </div>

                    </div>


                </div>
            </div>
            <template is="dom-if" if="{{showShippingOptions}}">
                <template id="shippingOptionsIfTemplate" is="dom-if" if="{{droppointData.selected}}">
                    <div class="shippingOptions">
                        <div class="dp-small-heading">Collection options</div>
                        <ul>
                            <template id="shippingOptionsTemplate" is="dom-repeat" items="{{droppointData.deliveries}}" xsort="sortServices">
                                <li class="delivery-place">

                                    <input type="radio"
                                            name="shipping_method_{{_id}}"
                                            checked="{{item.selected}}"
                                            value="{{item.id}}"
                                            id="dp-{{item.id}}"
                                            on-click="onClickOption"
                                            class="radio droppoint-delivery-selection" />

                                    <label for$="dp-{{item.id}}">
                                        <span class="gfsmethodname"><span class="price">{{currencySymbol}}{{item.price}}</span>&nbsp;{{item.methodTitle}}</span>
                                        <div>{{item.deliveryDateRange}}</div>
                                    </label>
                                </li>
                            </template>
                        </ul>
                    </div>
                </template>

            </template>

			<div class="actions">
				<template is="dom-if" if="{{_isStandardButton}}">
					<div on-click="select" class$="button choose-droppoint {{buttonClass}}">{{buttonText}}</div>
				</template>
			</div>
		</div>

	</template>

	<script>

        Polymer({
            is: "gfs-droppoint",

            properties: {
                title: {
                    type: String
                },

                droppointData: {
                    type: Object,
                    value: {}
                },

                containerClass: {
                    type: String,
                    value: "content-container"
                },

                showOpeningHours: {
                    type: Object,
                    value: false
                },
                showOpeningHoursLink: {
                    type: Object,
                    value: false
                },
                showDistance: {
                    type: Object,
                    value: true
                },
                showShippingOptions: {
                    type: Object,
                    value: false
                },
                currencySymbol: {
                    type: String,
                    value: "£"
                },

                //== Button
                buttonType: {
                    type: String,
                    value: "standard"
                },
                buttonNotSelectedClass: {
                    type: String,
                    value: "not-selected"
                },
                buttonSelectedClass: {
                    type: String,
                    value: "selected"
                },
                buttonClass: {
                    type: String,
                    value: "droppoint-button"
                },

                //== Private properties
                _weekCollection: {
                    type: Object,
                    notify: true
                },
                _id: {
                    type: String,
                    value: Math.floor(Math.random() * 99999) + (new Date().getDate()).toString()
                }
            },

            observers: [
                //"selectedChanged(data.selected)"
                //"_onShippingOptionSelected(data.deliveries.*.selected)"
            ],
            listeners: {
               // "select-delivery-option": "_onShippingOptionsChanged"
            },

			ready: function () {

				var self = this;
				this.initData();

                //Set the button type, if any
				if (this.buttonType === "none")
				{
					this._isTickButton = false;
					this._isStandardButton = false;					
				} 
				else {
					this._isTickButton = (this.buttonType === "tick");
					this._isStandardButton = !this._isTickButton;
				}

			    //Listen for a droppoint being selected somewhere on the page
			    //Window-level listener, to ensure that we get our peers
				window.addEventListener('droppoint-selected', this.onOtherDroppointSelected.bind(this), false);
			},


			initData: function () {
                //Set a unique ID
			    this._id = Math.floor(Math.random() * 99999) + (new Date().getDate()).toString()

                //Ensure 'selected' has a value
			    if (typeof (this.droppointData.selected) === "undefined") {
				    this.droppointData.selected = false;
				}

                //Build a nice week view of delivery methods
			    if (this.droppointData.collectionSlots) { // && this.droppointData.collectionSlots) {
			        this.droppointData.distanceInKm = (Math.round(this.droppointData.distanceInMeters / 100)) / 10;

					var dayCount = 0;
					var self = this;
					var buildWeekCollection = [];
					this.droppointData.weekCollectionSlots = [];
					if (!this.droppointData.collectionSlots) this.droppointData.collectionSlots = [];

					this.droppointData.collectionSlots.forEach(function (collectionSlot) {
						dayCount++;
						if (dayCount <= 7) {

							collectionSlot.collectionDateTime = self._getUtcTime(new Date(collectionSlot.collectionDate));
							collectionSlot.day = DOW_NAMES[collectionSlot.collectionDateTime.getDay()];

							collectionSlot.timeSlots.forEach(function (timeSlot) {
							    timeSlot.fromTime = timeSlot.from; //self._getTimeStr(timeSlot.fromDateTime);
							    timeSlot.toTime = timeSlot.to; //self._getTimeStr(timeSlot.toDateTime);
							});
								
							if (collectionSlot.timeSlots.length > 0) {;
							    buildWeekCollection.push(collectionSlot);
							}

						}
					});

					this.set('_weekCollection', buildWeekCollection);
				}
			},

			select: function() {
			    this.set('droppointData.selected', true);
			    this.autoSelectMethod();
			    this.fire('droppoint-selected', this.droppointData);
			},

			unselect: function () {
			    this.set('droppointData.selected', false);
			    this.render();
			},

            //== Global event handler
            //Another droppoint widget has been selected. React to this, by:
            // * selecting myself (if the other widget represents the same droppoint), or;
			// * unselecting myself (otherwise).
			onOtherDroppointSelected: function (e) {
			    
			    var dp = e.detail;

                //If the droppoint selected was this one, make sure this "selected" value reflects the other one
			    if (dp.droppointId == this.droppointData.droppointId) {
			        if (this.droppointData.selected !== dp.selected) {
			            this.set('droppointData', dp);
			        }
			        this.render();

			        return;
			    }
                //If it's another one and it's been selected, unselect me
			    else if (dp.selected) {
			        this.unselect();
			    }
			},

            //Update the button appearance based on whether this droppoint is selected or not
			render: function () {

			    if (!this.droppointData) {;
                    console.error("No droppoint data")
			        return;
			    }
			    else if (this.droppointData.selected) {
				    this.set('buttonClass', this.buttonSelectedClass);
					this.buttonText = "Selected";
				}
				else {
				    this.set('buttonClass', this.buttonNotSelectedClass);
					this.buttonText = "Select";
				}
			},

			onClickOption: function (e) {
			    this.selectMethod(e.target.value);		   
			},

            //Select a shipping option by ID
            //Fire on-select-delivery-option to be received by parent
            //Set deliveries[n].selected to true on selected method, false on all others
			selectMethod: function (shippingOptionId) {            
			    for (var i=0; i< this.droppointData.deliveries.length; i++) {
			        var item = this.droppointData.deliveries[i];

			        this.set("droppointData.deliveries." + i + ".selected", item.id === shippingOptionId);
			        this.fire('select-delivery-method', shippingOptionId);
			    }
			},

			autoSelectMethod: function() {
			    if (this.droppointData.deliveries) {		        
			        this.selectMethod(this.droppointData.deliveries[0].id);
			    }
			    else {
			        console.error("No delivery options available");
			    }
			},

            /*
			_onShippingOptionsChanged: function() {
			    this._onShippingOptionSelected();
			},
            */

			_getUtcTime: function (d) {
				var utc = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), d.getUTCHours(), d.getUTCMinutes(), d.getUTCSeconds());
				return utc;
			},

			_getTimeStr: function (d) {
				var minutes = d.getMinutes().toString().length == 1 ? '0' + d.getMinutes() : d.getMinutes();
				var hours = d.getHours() > 12 ? (d.getHours() % 12).toString() : d.getHours().toString();
				var ampm = d.getHours() >= 12 ? 'pm' : 'am';
				return hours + ':' + minutes + ampm;
			},

			_openingHoursLinkClick: function (e) {
			    this.fire('opening-hours-link-click', e);
			},

			_onClick: function () {
			    this.select();
			}

		});
	</script>
</dom-module>

<link rel="import" href="../../polymer/polymer.html" />
<link rel="import" href="../../iron-collapse/iron-collapse.html" />
<link rel="import" href="../../iron-input/iron-input.html" />
<link rel="import" href="../../paper-spinner/paper-spinner.html" />
<link rel="import" href="../p4m-address/p4m-address.html" />

<dom-module id="p4m-address-list">

    <template>
        <div id="container">
            <div class="card-body card-edit">
                <div class="consumer-form">
                    <input is="iron-input" type="text" id="consumer-email" bind-value="{{consumerData.Email}}" placeholder="Email address" />
                    <a class="p4m-button p4m-primary-button" href="#" on-tap="checkEmail">Go</a>
                    <input is="iron-input" type="text" id="consumer-given-name" bind-value="{{consumerData.GivenName}}" placeholder="First name" disabled />
                    <input is="iron-input" type="text" id="consumer-family-name" bind-value="{{consumerData.FamilyName}}" placeholder="Last name" disabled />
                </div>
            </div>

            <p><a id="addNewAddress" href="#" on-tap="addNewAddress">Add a new address</a></p>

            <template is="dom-repeat" items="{{addressListData}}" filter="filterNewOnly">
                <p4m-address address-data="{{item}}" on-canceledit="cancelAdd" cart-data="{{cartData}}" mode="edit" on-save="onAddAddress"></p4m-address>
            </template>

            <template is="dom-repeat" items="{{addressListData}}" filter="filterOldOnly">
                <p4m-address address-data="{{item}}" on-canceledit="cancelEdit" cart-data="{{cartData}}" mode="view" on-save="onUpdateAddress" on-select="onSelectAddress"></p4m-address>
            </template>
            <paper-spinner id="spinner"></paper-spinner>

        </div>

    </template>

    <style>
        #container {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #spinner {
            width: 50px;
            height: 50px;
            position: absolute;
            top: 65px;
            left: 40%;
            margin: auto;
        }

        .hidden {
            display: none;
        }

        .consumer-form {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        .consumer-form input {
            margin: 4px;
            width: 100px;
            max-width: 100%;
        }
    </style>

    <script>
    //
        Polymer({
            is: "p4m-address-list",

            properties: {
                addressListData: {
                    type: Array,
                    notify: true
                },
                cartData: {
                    type: Object,
                    notify: true
                },
                newAddress: {
                    type: Object,
                    value: {},
                    notify: true
                },
                _addedNewAddress: {
                    type: Object,
                    value: false
                }
            },

            observers: [
                "onCartAddressDataChange(cartData.BillingAddressId)",
                "onCartAddressDataChange(cartData.AddressId)"
            ],

            ready: function()
            {
                
            },

            checkEmail: function () {
                // load a popup to ask the P4M server to check the email address
                // if the email is known the we can ask the user to login if they have completed their registration
                // or if not, let them know that if they validate their email address we can use their stored info
                var email = this.$["consumer-email"].value;
                this.popup = this.popupCenter("/p4m/checkEmail?email=" + email, "Checking...", 300, 200);
                var self = this;
                this.popup.onunload = function () {
                    alert('unload: '+self.popup.closed);
                }
                this.popup.onpagehide = function () {
                    alert('hide: ' + self.popup.closed);
                }
            },

            popupCenter: function (url, title, w, h) {
                var left = (screen.width / 2) - (w / 2);
                var top = (screen.height / 2) - (h / 2);
                return window.open(url, title, 'toolbar=no, location=no, directories=no, status=no, menubar=yes, scrollbars=no, resizable=no, copyhistory=no, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);
            },

            addNewAddress: function () {
               
                if (this.addressListData && !this._addedNewAddress) {
                    this._addedNewAddress = true;
                    //Add empty object to handle adding a new address
                    this.push('addressListData', this.newAddress);
                }             

            },

            cancelAdd: function(e) {
                console.log("Cancel add address");
                this._addedNewAddress = false;
                this.pop('addressListData');

                //this.$.newAddressCollapse.opened = false;
            },

            cancelEdit: function (e) {
                // revert card to previous values
                console.log("Cancel edit address");
                //this.$.newAddressCollapse.opened = false;
            },

            onAddAddress: function(addressElement) {
                this.fire('add', addressElement.detail);
            },

            onUpdateAddress: function (addressElement) {
                this.fire('update', addressElement.detail);
            },

            onSelectAddress: function(e) {
                this.fire('select', e.detail);
            },

            onCartAddressDataChange: function (e) {
                var i = 0;
                //console.log("Changed delivery or billing address");
                if (this.addressListData) {
                    this.addressListData.forEach((function (item) {
                        this.notifyPath('addressListData.#' + i + "._update", Math.random());
                        i++;
                    }).bind(this));
                }

                //this.notifyPath('addressData', this.addressListData);
            },

            filterNewOnly: function (e) {
                return (typeof(e.Label) === "undefined");
            },

            filterOldOnly: function (e) {
                return (typeof (e.Label) === "string" && e.AddressType == "Address");
            },

            showAsLoaded: function () {
                this.$.spinner.active = false;
                this.$.spinner.classList.add('hidden');
                this.$.container.classList.remove('loading');
            },

            showAsLoading: function () {
                this.$.spinner.active = true;
                this.$.spinner.classList.remove('hidden');
                this.$.container.classList.add('loading');
            },

            getDropPointById: function (dropPointId) {
                return (this.addressListData.find(function (item) { return item.DropPointId == dropPointId }));
            }

        });
    </script>
</dom-module>

<link rel="import" href="../../polymer/polymer.html" />
<link rel="import" href="../../iron-collapse/iron-collapse.html" />
<link rel="import" href="../p4m-card/p4m-card.html" />
<link rel="import" href="../p4m-card/p4m-new-card.html" />

<dom-module id="p4m-card-list">

    <template>
        <div id="container">
            <div class="add-new horizontal layout center end-justified style-scope p4m-address-list">
            <div class="link add" id="addNewCardLink" id="addNewCardText" on-tap="addNewCard">
                <span>Add a New Card</span>
                <i class="p4micon-add-circle link"></i>
            </div>
            </div>

            <iron-collapse id="newCardCollapse">
                <p4m-new-card id="newCard" consumer-data="{{consumerData}}" on-gotnewcard="onGotNewCard"></p4m-new-card>
            </iron-collapse>

            <!-- <iron-collapse id="cardListCollapse">  help BAZ! -->
            <div class="cardList">
                <template is="dom-repeat" items="{{consumerData.PaymentMethods}}">
                    <p4m-card card-data="{{item}}" on-selected="onCardSelected" show-cvv="false" container-class="card-list-item" selected-card-id="{{selectedCardId}}"></p4m-card>
                </template>
            </div>
            <!-- </iron-collapse> -->

        </div>

    </template>

    <style>
        .cardList {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }
    </style>

    <script>
    //
        Polymer({
            is: "p4m-card-list",

            properties: {
                consumerData: {
                    type: Object,
                    notify: true
                },
                cartData: {
                    type: Object,
                    notify: true
                },
                selectedCardId: {
                    type: String,
                    notify: true
                }
            },

            observers: [
                "onConsumerDataChange(consumerData.DefaultPayMethodId)",
                "onCartDataChange(cartData.PayMethodId)"
            ],

            ready: function()
            {
            },

            onCardSelected(e) {
                this.set("selectedCardId", e.detail.Id); //This should now trigger the other cards to update their UI
            },

            addNewCard: function () {
                var ctrl = this.$.newCardCollapse;
                var lbl = this.$.addNewCardLink;
                if (!ctrl.opened) {
                    this.$.newCard.loadRealexForm();
                    lbl.firstElementChild.innerText = "Cancel";
                    lbl.classList.add("cancel");
                    lbl.classList.remove("add");
                    
                    // lbl.innerHTML = 'Cancel<i class="p4micon-delete-circle link" onclick="addRow()"></i>';
                }
                else {
                    lbl.firstElementChild.innerText = "Add a New Card";
                    lbl.classList.add("add");
                    lbl.classList.remove("cancel");
                    // lbl.innerHTML = 'ADD<i class="p4micon-add-circle link" onclick="addRow()"></i>';
                }
                ctrl.toggle();

            },


            onGotNewCard: function () {
                this.addNewCard();
            },



            onConsumerDataChange: function () {
                if (false && !this.selectedCardId && this.consumerData) {
                    //console.log("Setting selectedCardId to", this.consumerData.DefaultPayMethodId);
                    var foundDefaultCard = this.getCardDataById(this.consumerData.DefaultPayMethodId);
                    if (foundDefaultCard) {
                        this.set('selectedCardId', this.consumerData.DefaultPayMethodId);
                        this.fire('selected', foundDefaultCard);
                    }
                }
            },

            onCartDataChange: function () {
                if (!this.selectedCardId && this.cartData && this.cartData.PayMethodId && this.consumerData) {
                    //console.log("Setting selectedCardId to", this.cartData.PayMethodId);
                    var foundCard = this.getCardDataById(this.cartData.PayMethodId || this.consumerData.PayMethodId);
                    if (foundCard) {
                        this.set('selectedCardId', this.cartData.PayMethodId);
                        this.fire('selected', foundCard);
                    }
                }
            },

            getCardDataById: function (id) {
                var item;
                for (var i = 0; i < this.consumerData.PaymentMethods.length; i++) {
                    item = this.consumerData.PaymentMethods[i];
                    if (item.Id === id) {
                        return item;
                    }
                }
            },

            _cardsOnly: function (item) {
                return true;// (item && item.AccountType && item.AccountType === "Card");
            }


        });
    </script>
</dom-module>

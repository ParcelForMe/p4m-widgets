
<link rel="import" href="../../polymer/polymer.html" />

<link rel="import" href="../../polymer-cookie/polymer-cookie.html" />
<link rel="import" href="../../paper-tabs/paper-tabs.html" />
<link rel="import" href="../../iron-pages/iron-pages.html" />

<link rel="import" href="../p4m-spinner/p4m-spinner.html" />
<link rel="import" href="../p4m-shared/p4m-shared.html" />
<link rel="import" href="../p4m-profile/p4m-profile.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="import" href="../p4m-cart/p4m-cart.html" /> 
<link rel="import" href="../p4m-order-summary/p4m-order-summary.html" />
<link rel="import" href="../p4m-address-list/p4m-address-list.html" />
<link rel="import" href="../p4m-purchase/p4m-purchase.html" />
<link rel="import" href="../p4m-purchase/p4m-purchase-btn.html" />
<link rel="import" href="../p4m-card-list/p4m-card-list.html" />
<link rel="import" href="../p4m-delivery/p4m-delivery.html" />
<link rel="import" href="../p4m-order-text/p4m-order-text.html" />
<link rel="import" href="../p4m-overlay/p4m-general-fault.html" />

<link rel="import" href="../p4m-discount-input/p4m-discount-input.html" />
<link rel="import" href="../p4m-discount-list/p4m-discount-list.html" />

<link rel="import" href="../gfs-checkout-widget/gfs-checkout-widget.html" />
<link rel="import" href="../address-lookup-field/address-lookup-field.html" />  


<link rel="import" href="../p4m-imports/p4m-imports.html" />  
 
<link rel="stylesheet" href="../p4m-shared/p4m.css" />

<dom-module id="p4m-checkout">

    <template>

        <p4m-api id="p4mCheckoutApi" ssl="true" on-noservice="onP4mNoService" host-base-domain="parcelfor.me" host-type="{{hostType}}" version="v2"></p4m-api>
        <p4m-api id="localApi" is-local="true"></p4m-api>
        <div id="container" class$="{{_changeIndicatorClass}}">

            <div id="topPanel" class="topPanel">
                <img class="p4m-register-logo" src="../p4m-shared/img/P4M-Top-Header.png" id="peli-icon-header" />
                <!-- Not using due to Variable font baselines screwing alignment across browsers, Including in logo image instead.
                <h2>Checkout &amp; Delivery</h2> -->
                <div class="flex-spacer"></div>
                <div><span class="font-weight-light">Welcome,</span> </div>
                <p4m-profile mode="basic"></p4m-profile>
            </div>

            <div id="panelContainer" class="horizontal layout">
                <div id="detailPanel" class="p4m-panel flex-2">                   
                    <paper-tabs selected="{{selectedTab}}" no-bar>
                        <paper-tab>My Order<p4m-spinner species="progress" id="myorder_spinner"></p4m-spinner></paper-tab>
                        <paper-tab>Addresses<p4m-spinner species="progress" id="addresses_spinner"></p4m-spinner></paper-tab>
                        <paper-tab>Delivery Options<p4m-spinner species="progress" id="delivery_spinner"></p4m-spinner></paper-tab>
                        <paper-tab>Payment Options<p4m-spinner species="progress" id="payment_spinner"></p4m-spinner></paper-tab>                  
                    </paper-tabs>
                    <iron-pages id="p4mPages" selected="{{selectedTab}}" on-iron-select="_onSelectTab">                   
                        <iron-page id="cartPage">                       
                            <p4m-cart id="cart" cart-data="{{cartData}}"></p4m-cart>                         
                        </iron-page>
                        <iron-page id="addressPage">
                            <p4m-address-list id="addressList" address-list-data="{{consumerData.addresses}}" cart-data="{{cartData}}" on-select="onSelectAddressFromList" on-add="onAddAddress" on-update="onUpdateAddress"></p4m-address-list>
                        </iron-page>
                        <iron-page id="deliveryPage">
                            <div id="shippingSelector" class="hidden">

                                <gfs-checkout id="gfsCheckoutWidget" access-token="{{gfsAccessToken}}"  on-selectedservicechanged="onGfsServiceChanged" on-gfs-token-expired="onGfsSessionExpiry" on-noservice="onGfsNoService" delivery-preferences="{{deliveryPreferences}}" consumer-addresses="{{consumerData.addresses}}" ></gfs-checkout>
                            </div>
                            <div id="noShippingWarning">
                                Please <a class="link" href="#">enter an address</a> to continue.
                            </div>

                            <template is="dom-if" if="{{useGfsCheckout}}">
                            </template>
                        </iron-page>
                        <iron-page id="cardPage">
                            <p4m-card-list id="cardList" consumer-data="{{consumerData}}" cart-data="{{cartData}}" platform="{{hostType}}" on-selected="onSelectPaymentMethod" on-gotnewcard="onGotNewCard"></p4m-card-list>
                        </iron-page>

                    </iron-pages>
                </div>
                <div id="summaryPanel" class="p4m-panel smallSummary flex-1">
                    <p4m-order-summary id="orderSummary" cart-data="{{cartData}}"></p4m-order-summary>
                    <p4m-purchase id="p4mPurchase" cart-data="{{cartData}}" on-payment-complete="onPaymentComplete" on-request-payment-method="goToPaymentMethods" use-paypal="{{usePaypal}}" selected-card="{{selectedCard}}" use-paypal="true"></p4m-purchase>
                </div>
            </div> 


            <footer id="footerpPanel" class$="footerPanel {{_changeIndicatorClass}}">
            
                <div class="left">
                    <p4m-order-text cart-data="{{cartData}}" consumer-data="{{consumerData}}" on-request-address="goToAddresses"></p4m-order-text>
                        <div id="downloadAppAd">
                                           <p class="p4m-info">Track your purchases in the free P4M App!</p>
                                           <div class="app-buttons"><a href="https://www.apple.com/ios/app-store/">
                                           <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                             viewBox="0 0 170.9 57.3" style="enable-background:new 0 0 170.9 57.3;" xml:space="preserve">
                        <style type="text/css">
                            .st0{fill:#58595B;}
                        </style>
                        <g>
                            <path class="st0" d="M106.6,33.2c-1.3-0.5-2.2-1-2.7-1.4c-0.6-0.5-0.8-1.1-0.8-1.8c0-0.7,0.2-1.2,0.7-1.7c0.6-0.5,1.4-0.8,2.4-0.8
                                c1.3,0,2.5,0.3,3.5,0.8l0.7-2.4c-1.1-0.6-2.5-0.9-4.2-0.9c-1.9,0-3.4,0.5-4.5,1.4c-1.1,1-1.7,2.2-1.7,3.7c0,2.3,1.6,4.1,4.8,5.3
                                c1.2,0.4,2,0.9,2.5,1.4c0.5,0.5,0.8,1.1,0.8,1.9c0,0.8-0.3,1.5-0.9,2c-0.6,0.5-1.5,0.8-2.6,0.8c-1.5,0-3-0.4-4.3-1.1l-0.7,2.5
                                c1.2,0.8,2.8,1.1,4.8,1.1c2.1,0,3.8-0.5,5-1.6c1.1-1,1.6-2.3,1.6-3.8c0-1.3-0.4-2.3-1.1-3.2C109.4,34.6,108.2,33.8,106.6,33.2z"/>
                            <rect x="75" y="14.3" class="st0" width="1.7" height="6.9"/>
                            <path class="st0" d="M75.9,13.3c0.6,0,1-0.4,1-0.9c0-0.5-0.4-0.9-1-0.9c-0.6,0-1,0.4-1,0.9C74.9,12.9,75.3,13.3,75.9,13.3z"/>
                            <path class="st0" d="M144.7,15.5c1,0,1.3,0.8,1.3,1.7v3.9h1.7v-4c0-2.2-1.2-3-2.4-3c-0.4,0-0.8,0.1-1.2,0.3
                                c-0.4,0.2-0.6,0.5-0.9,0.8h0v-4.1h-1.7v10h1.7V17c0-0.2,0-0.4,0.1-0.5C143.5,16,144,15.5,144.7,15.5z"/>
                            <path class="st0" d="M83.4,19.3c0,1,0.8,2,2.2,2c0.9,0,1.6-0.4,2-0.9h0l0.1,0.8h1.6c-0.1-0.4-0.1-1-0.1-1.6V17
                                c0-1.5-0.6-2.9-2.8-2.9c-1.1,0-2,0.3-2.5,0.6l0.3,1.1c0.5-0.3,1.2-0.5,1.8-0.5c1.2,0,1.4,0.7,1.4,1.2v0.1
                                C85,16.6,83.4,17.5,83.4,19.3z M87.5,17.8v0.9c0,0.1,0,0.3,0,0.4c-0.2,0.5-0.7,0.9-1.4,0.9c-0.5,0-1-0.3-1-1
                                C85.1,18,86.3,17.8,87.5,17.8z"/>
                            <path class="st0" d="M139.9,30.9c-0.7,0.5-1.2,1.2-1.5,2.1h-0.1l-0.1-2.5h-2.6c0.1,1.3,0.1,2.7,0.1,4.2v9.1h3v-7
                                c0-1.1,0.2-1.9,0.7-2.6c0.6-0.8,1.4-1.2,2.4-1.2c0.3,0,0.6,0,0.9,0.1v-2.8c-0.2,0-0.5,0-0.7,0C141.3,30.2,140.6,30.5,139.9,30.9z"
                                />
                            <rect x="79.4" y="11.1" class="st0" width="1.7" height="10"/>
                            <path class="st0" d="M62.7,17.8c-0.2,0.6-0.3,1.2-0.5,1.7h0c-0.1-0.6-0.3-1.1-0.5-1.7l-1.1-3.5h-1.9l2.5,6.9H63l2.6-6.9h-1.8
                                L62.7,17.8z"/>
                            <path class="st0" d="M55.8,25.3l-5.9,18.4h3.1l1.6-5.4h6l1.7,5.4h3.2l-6-18.4H55.8z M55.1,36.1l1.5-4.8c0.4-1.5,0.7-2.7,0.9-3.5
                                h0.1c0.5,1.8,0.8,3,0.9,3.5l1.6,4.8H55.1z"/>
                            <path class="st0" d="M70.7,20.4L70.7,20.4l0.2,0.8h1.6c-0.1-0.4-0.1-1-0.1-1.6V17c0-1.5-0.6-2.9-2.8-2.9c-1.1,0-2,0.3-2.5,0.6
                                l0.3,1.1c0.5-0.3,1.2-0.5,1.8-0.5c1.2,0,1.4,0.7,1.4,1.2v0.1c-2.5,0-4.1,0.9-4.1,2.6c0,1,0.8,2,2.2,2
                                C69.6,21.3,70.3,20.9,70.7,20.4z M68.2,19.1c0-1,1.2-1.3,2.4-1.3v0.9c0,0.1,0,0.3,0,0.4c-0.2,0.5-0.7,0.9-1.4,0.9
                                C68.7,20.1,68.2,19.7,68.2,19.1z"/>
                            <path class="st0" d="M74.4,30.2c-2,0-3.5,0.8-4.5,2.4h-0.1l-0.2-2.1h-2.6c0.1,1.5,0.1,2.9,0.1,4.4v14.3h3v-7c0.8,1.3,2,1.9,3.8,1.9
                                c1.6,0,3-0.6,4.1-1.7c1.2-1.3,1.8-3.1,1.8-5.4c0-2-0.5-3.7-1.6-4.9C77.3,30.8,76,30.2,74.4,30.2z M76,40.5
                                c-0.6,0.9-1.5,1.3-2.6,1.3c-0.9,0-1.7-0.3-2.3-1c-0.6-0.7-0.9-1.5-0.9-2.5v-2.2c0-0.2,0-0.5,0.1-0.9c0.2-0.8,0.6-1.4,1.2-1.9
                                c0.6-0.5,1.3-0.7,2-0.7c1.1,0,1.9,0.4,2.6,1.3c0.6,0.8,0.9,1.9,0.9,3.2C76.9,38.5,76.6,39.6,76,40.5z"/>
                            <path class="st0" d="M52.5,18.4h3l0.9,2.7h1.9l-3.1-9.5h-2.2l-3,9.5h1.8L52.5,18.4z M53.5,14.8c0.2-0.6,0.3-1.2,0.5-1.8h0
                                c0.1,0.5,0.3,1.2,0.5,1.8l0.7,2.3h-2.4L53.5,14.8z"/>
                            <path class="st0" d="M150,30.2c-1.9,0-3.5,0.7-4.7,2.1c-1.1,1.3-1.6,3-1.6,5c0,2,0.6,3.7,1.8,4.9c1.2,1.2,2.8,1.8,4.9,1.8
                                c1.7,0,3.2-0.3,4.5-0.8l-0.5-2.1c-1.1,0.4-2.3,0.6-3.6,0.6c-1.2,0-2.2-0.3-2.9-0.9c-0.8-0.7-1.3-1.7-1.3-3h8.9
                                c0.1-0.4,0.1-0.8,0.1-1.3c0-1.7-0.4-3.1-1.2-4.2C153.4,30.9,152,30.2,150,30.2z M146.6,35.7c0.1-0.9,0.4-1.7,0.9-2.3
                                c0.6-0.8,1.4-1.2,2.4-1.2c1.1,0,1.8,0.4,2.4,1.2c0.4,0.6,0.6,1.4,0.6,2.3H146.6z"/>
                            <rect x="99.8" y="11.1" class="st0" width="1.7" height="10"/>
                            <path class="st0" d="M89.1,30.2c-2,0-3.5,0.8-4.5,2.4h-0.1l-0.2-2.1h-2.6c0.1,1.5,0.1,2.9,0.1,4.4v14.3h3v-7c0.8,1.3,2,1.9,3.8,1.9
                                c1.6,0,3-0.6,4.1-1.7c1.2-1.3,1.8-3.1,1.8-5.4c0-2-0.5-3.7-1.6-4.9C91.9,30.8,90.6,30.2,89.1,30.2z M90.6,40.5
                                c-0.6,0.9-1.5,1.3-2.6,1.3c-0.9,0-1.7-0.3-2.3-1c-0.6-0.7-0.9-1.5-0.9-2.5v-2.2c0-0.2,0-0.5,0.1-0.9c0.2-0.8,0.6-1.4,1.2-1.9
                                c0.6-0.5,1.2-0.7,2-0.7c1.1,0,1.9,0.4,2.6,1.3c0.6,0.8,0.9,1.9,0.9,3.2C91.5,38.5,91.2,39.6,90.6,40.5z"/>
                            <path class="st0" d="M95,14.1c-1,0-1.8,0.4-2.2,1.1h0v-4.1H91v8.1c0,0.7,0,1.5-0.1,1.9h1.5l0.1-1h0c0.5,0.8,1.3,1.2,2.2,1.2
                                c1.5,0,3.1-1.2,3.1-3.7C97.9,15.5,96.7,14.1,95,14.1z M94.3,19.9c-0.7,0-1.4-0.5-1.5-1.2c0-0.1,0-0.3,0-0.4v-1.1
                                c0-0.2,0-0.3,0.1-0.5c0.2-0.8,0.8-1.3,1.5-1.3c1.2,0,1.7,1,1.7,2.2C96.1,19.1,95.4,19.9,94.3,19.9z"/>
                            <path class="st0" d="M152.7,21.3c1,0,1.8-0.2,2.4-0.4l-0.3-1.2c-0.5,0.2-1.1,0.3-1.9,0.3c-1.1,0-2.1-0.5-2.1-1.8h4.6
                                c0-0.2,0.1-0.4,0.1-0.7c0-1.5-0.7-3.3-3-3.3c-2.2,0-3.3,1.8-3.3,3.7C149.2,19.9,150.5,21.3,152.7,21.3z M152.5,15.3
                                c1.2,0,1.4,1,1.4,1.7h-3C150.9,16.3,151.4,15.3,152.5,15.3z"/>
                            <path class="st0" d="M116.8,27.2l-2.9,0.9v2.4h-1.9v2.2h1.9v6.7c0,1.7,0.3,2.9,1,3.6c0.7,0.7,1.6,1.1,2.7,1.1
                                c0.9,0,1.7-0.1,2.3-0.3l-0.1-2.2c-0.3,0.1-0.8,0.1-1.3,0.1c-1.2,0-1.7-0.8-1.7-2.5v-6.5h3.3v-2.2h-3.3V27.2z"/>
                            <path class="st0" d="M118.5,14.1c-2.1,0-3.5,1.4-3.5,3.6c0,2.2,1.5,3.5,3.4,3.5c1.7,0,3.5-1.1,3.5-3.6
                                C121.9,15.6,120.5,14.1,118.5,14.1z M118.4,20c-1,0-1.7-1-1.7-2.3c0-1.1,0.5-2.3,1.7-2.3c1.2,0,1.7,1.2,1.7,2.3
                                C120.1,19.1,119.4,20,118.4,20z"/>
                            <path class="st0" d="M127.5,30.2c-2,0-3.6,0.6-4.8,2c-1.2,1.3-1.8,3-1.8,5.1c0,2,0.6,3.6,1.7,4.9c1.2,1.3,2.7,1.9,4.7,1.9
                                c2,0,3.6-0.7,4.9-2c1.2-1.3,1.7-3,1.7-5c0-2-0.6-3.6-1.7-4.9C131,30.9,129.5,30.2,127.5,30.2z M130,40.3c-0.6,1.1-1.5,1.6-2.6,1.6
                                c-1.2,0-2-0.5-2.7-1.6c-0.5-0.9-0.8-1.9-0.8-3.1c0-1.3,0.3-2.3,0.8-3.2c0.6-1.1,1.5-1.6,2.7-1.6c1.2,0,2,0.5,2.7,1.6
                                c0.5,0.9,0.8,1.9,0.8,3.1S130.6,39.4,130,40.3z"/>
                            <path class="st0" d="M136.2,18.8c0,0.9,0.2,1.5,0.5,1.9c0.3,0.4,0.8,0.6,1.5,0.6c0.5,0,1-0.1,1.3-0.2l0-1.3
                                c-0.2,0.1-0.4,0.1-0.7,0.1c-0.7,0-0.9-0.4-0.9-1.3v-3h1.6v-1.3h-1.6v-1.8l-1.7,0.5v1.3h-1v1.3h1V18.8z"/>
                            <path class="st0" d="M107.1,21.3c1,0,1.8-0.2,2.4-0.4l-0.3-1.2c-0.5,0.2-1.1,0.3-1.9,0.3c-1.1,0-2.1-0.5-2.1-1.8h4.6
                                c0-0.2,0.1-0.4,0.1-0.7c0-1.5-0.7-3.3-3-3.3c-2.2,0-3.3,1.8-3.3,3.7C103.6,19.9,104.9,21.3,107.1,21.3z M106.8,15.3
                                c1.2,0,1.4,1,1.4,1.7h-3C105.3,16.3,105.7,15.3,106.8,15.3z"/>
                            <path class="st0" d="M123.6,21.1h1.7v-4c0-0.2,0-0.4,0.1-0.5c0.2-0.5,0.7-1,1.4-1c0.9,0,1.3,0.7,1.3,1.7v3.9h1.7v-4.1
                                c0-2.2-1.2-2.9-2.4-2.9c-1.1,0-1.9,0.6-2.2,1.2h0l-0.1-1h-1.5c0,0.6,0.1,1.3,0.1,2V21.1z"/>
                            <path class="st0" d="M36.1,28.8c0-4.1,3.4-6.1,3.5-6.2c-1.9-2.8-4.9-3.2-6-3.2c-2.5-0.3-5,1.5-6.2,1.5c-1.3,0-3.3-1.5-5.4-1.4
                                c-2.7,0-5.3,1.6-6.7,4.1c-2.9,5-0.7,12.4,2,16.4c1.4,2,3,4.2,5.1,4.1c2.1-0.1,2.9-1.3,5.4-1.3c2.5,0,3.2,1.3,5.4,1.3
                                c2.2,0,3.6-2,5-4c1.6-2.3,2.2-4.5,2.3-4.6C40.4,35.4,36.1,33.7,36.1,28.8z"/>
                            <path class="st0" d="M32,16.7c1.1-1.4,1.9-3.3,1.7-5.2c-1.6,0.1-3.6,1.1-4.8,2.5c-1,1.2-2,3.2-1.7,5C29,19.1,30.8,18.1,32,16.7z"/>
                            <path class="st0" d="M162.4,0H8.5C3.8,0,0,3.8,0,8.5v40.3c0,4.7,3.8,8.5,8.5,8.5h154c4.7,0,8.5-3.8,8.5-8.5V8.5
                                C170.9,3.8,167.1,0,162.4,0z M168.9,48.8c0,3.6-2.9,6.5-6.5,6.5H8.5c-3.6,0-6.5-2.9-6.5-6.5V8.5C2,4.9,4.9,2,8.5,2h154
                                c3.6,0,6.5,2.9,6.5,6.5V48.8z"/>
                        </g>
                        </svg>
                        </a>
                        <a href="https://play.google.com/store/apps">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 170.9 57.3" style="enable-background:new 0 0 170.9 57.3;" xml:space="preserve" class="style-scope p4m-checkout">
                        
                        <g class="style-scope p4m-checkout">
                            <path class="st0 style-scope p4m-checkout" d="M162.4,0H8.5C3.8,0,0,3.8,0,8.5v40.3c0,4.7,3.8,8.5,8.5,8.5h154c4.7,0,8.5-3.8,8.5-8.5V8.5
                                C170.9,3.8,167.1,0,162.4,0z M168.9,48.8c0,3.6-2.9,6.5-6.5,6.5H8.5c-3.6,0-6.5-2.9-6.5-6.5V8.5C2,4.9,4.9,2,8.5,2h154
                                c3.6,0,6.5,2.9,6.5,6.5V48.8z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M52.5,17.3h1.8c0.2,0.8,0.4,1.3,0.4,1.5h1.3c0-0.1-0.3-1-0.8-2.6c-0.6-1.6-0.8-2.4-0.8-2.6h-1.5
                                c0,0.2-0.3,1-0.9,2.6c-0.6,1.6-0.9,2.4-0.9,2.5h1.2C52.1,18.6,52.2,18.1,52.5,17.3z M53.3,14.3L53.3,14.3c0.1,0.1,0.3,0.8,0.7,2.2
                                h-1.4C53.1,15.2,53.3,14.4,53.3,14.3z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M57.7,18.8c0-0.9-0.1-1.7-0.1-2.4c0-0.5,0-1-0.1-1.6h0.1c0.1,0.4,0.5,1.1,1.3,2.2c0.7,1,1.1,1.6,1.1,1.7h1
                                c0-0.8-0.1-1.7-0.1-2.7c0-1,0-1.8,0.1-2.5h-1c0,0.8,0.1,1.5,0.1,2.2c0,0.5,0,1,0.1,1.6h-0.1c-0.1-0.4-0.5-1.1-1.2-2.1
                                c-0.7-1-1-1.5-1-1.7h-1.2c0,0.7,0.1,1.5,0.1,2.5c0,1,0,1.9-0.1,2.7H57.7z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M64,18.8c0.9,0,1.5-0.3,2-0.8c0.5-0.6,0.7-1.2,0.7-2c0-0.7-0.2-1.2-0.6-1.7c-0.4-0.5-1.1-0.7-2.1-0.7
                                c-0.1,0-0.2,0-0.4,0c-0.2,0-0.4,0-0.5,0h-0.7c0,0.7,0.1,1.5,0.1,2.5c0,1,0,1.9-0.1,2.7C63.1,18.8,63.6,18.8,64,18.8z M63.8,14.4
                                c0.6,0,1.1,0.2,1.4,0.5c0.3,0.3,0.4,0.8,0.4,1.3c0,0.5-0.1,0.9-0.4,1.3C65,17.8,64.5,18,64,18c-0.2,0-0.3,0-0.5-0.1
                                c0-0.6,0-1.2,0-1.9c0-0.6,0-1.1,0-1.7C63.6,14.4,63.7,14.4,63.8,14.4z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M68.9,18.8c0-0.7,0-1.4,0-2c0.1,0,0.3,0,0.4,0c0.4,0,0.6,0.1,0.8,0.3c0.2,0.2,0.4,0.8,0.7,1.7H72
                                c-0.3-0.9-0.6-1.5-0.8-1.9c-0.2-0.3-0.4-0.5-0.7-0.6v-0.1c0.7-0.3,1-0.7,1-1.4c0-0.8-0.6-1.2-1.8-1.2c-0.2,0-0.4,0-0.7,0
                                c-0.3,0-0.4,0-0.5,0h-0.7c0,0.7,0.1,1.5,0.1,2.5c0,1,0,1.9-0.1,2.7H68.9z M69.5,14.3c0.7,0,1,0.3,1,0.8c0,0.6-0.4,0.9-1.3,0.9
                                c-0.1,0-0.2,0-0.4,0c0-0.7,0-1.2,0-1.6C69,14.4,69.3,14.3,69.5,14.3z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M75.1,18.9c0.7,0,1.3-0.3,1.8-0.8c0.5-0.5,0.7-1.2,0.7-2c0-0.8-0.2-1.4-0.7-1.9c-0.5-0.5-1.1-0.7-1.7-0.7
                                c-0.7,0-1.3,0.3-1.8,0.8c-0.5,0.5-0.7,1.2-0.7,2c0,0.8,0.2,1.4,0.7,1.9C73.8,18.7,74.4,18.9,75.1,18.9z M74.1,14.9
                                c0.3-0.3,0.6-0.5,1-0.5c0.4,0,0.8,0.2,1,0.5c0.3,0.3,0.4,0.8,0.4,1.3c0,0.5-0.1,1-0.4,1.3c-0.3,0.3-0.6,0.5-1,0.5
                                c-0.4,0-0.8-0.2-1-0.5c-0.3-0.3-0.4-0.8-0.4-1.3C73.7,15.7,73.9,15.2,74.1,14.9z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M78.8,13.6c0,0.7,0.1,1.5,0.1,2.5c0,1,0,1.9-0.1,2.7h1.1c0-0.8-0.1-1.7-0.1-2.7c0-1,0-1.8,0.1-2.5H78.8z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M82.9,18.8c0.9,0,1.5-0.3,2-0.8c0.5-0.6,0.7-1.2,0.7-2c0-0.7-0.2-1.2-0.6-1.7c-0.4-0.5-1.1-0.7-2.1-0.7
                                c-0.1,0-0.2,0-0.4,0c-0.2,0-0.4,0-0.5,0h-0.7c0,0.7,0.1,1.5,0.1,2.5c0,1,0,1.9-0.1,2.7C82,18.8,82.5,18.8,82.9,18.8z M82.7,14.4
                                c0.6,0,1.1,0.2,1.4,0.5c0.3,0.3,0.4,0.8,0.4,1.3c0,0.5-0.1,0.9-0.4,1.3S83.4,18,82.9,18c-0.2,0-0.3,0-0.5-0.1c0-0.6,0-1.2,0-1.9
                                c0-0.6,0-1.1,0-1.7C82.5,14.4,82.6,14.4,82.7,14.4z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M92.4,16.2c-0.6-1.6-0.8-2.4-0.8-2.6H90c0,0.2-0.3,1-0.9,2.6c-0.6,1.6-0.9,2.4-0.9,2.5h1.2
                                c0-0.2,0.1-0.7,0.4-1.5h1.8c0.2,0.8,0.4,1.3,0.4,1.5h1.3C93.2,18.6,92.9,17.8,92.4,16.2z M89.9,16.5c0.5-1.4,0.7-2.1,0.7-2.2h0.1
                                c0,0.1,0.2,0.8,0.7,2.2H89.9z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M95.2,18.8c0-0.8,0-1.5,0-2c0.1,0,0.1,0,0.3,0c0.7,0,1.3-0.2,1.7-0.5c0.5-0.3,0.7-0.8,0.7-1.4
                                c0-0.5-0.2-0.8-0.5-1c-0.3-0.2-0.8-0.3-1.3-0.3c-0.2,0-0.4,0-0.7,0c-0.3,0-0.5,0-0.6,0h-0.7c0,0.7,0.1,1.5,0.1,2.5
                                c0,1,0,1.9-0.1,2.7H95.2z M95.7,14.3c0.7,0,1.1,0.3,1.1,0.8c0,0.6-0.5,0.9-1.4,0.9c-0.1,0-0.2,0-0.2,0c0-0.6,0-1.2,0-1.7
                                C95.3,14.4,95.5,14.3,95.7,14.3z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M99.9,18.8c0-0.8,0-1.5,0-2c0.1,0,0.1,0,0.3,0c0.7,0,1.3-0.2,1.7-0.5c0.5-0.3,0.7-0.8,0.7-1.4
                                c0-0.5-0.2-0.8-0.5-1c-0.3-0.2-0.8-0.3-1.3-0.3c-0.2,0-0.4,0-0.7,0c-0.3,0-0.5,0-0.6,0h-0.7c0,0.7,0.1,1.5,0.1,2.5
                                c0,1,0,1.9-0.1,2.7H99.9z M100.4,14.3c0.7,0,1.1,0.3,1.1,0.8c0,0.6-0.5,0.9-1.4,0.9c-0.1,0-0.2,0-0.2,0c0-0.6,0-1.2,0-1.7
                                C100,14.4,100.2,14.3,100.4,14.3z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M107.7,18.9c0.7,0,1.3-0.3,1.8-0.8c0.5-0.5,0.7-1.2,0.7-2c0-0.8-0.2-1.4-0.7-1.9c-0.5-0.5-1.1-0.7-1.7-0.7
                                c-0.7,0-1.3,0.3-1.8,0.8c-0.5,0.5-0.7,1.2-0.7,2c0,0.8,0.2,1.4,0.7,1.9C106.4,18.7,107,18.9,107.7,18.9z M106.8,14.9
                                c0.3-0.3,0.6-0.5,1-0.5c0.4,0,0.8,0.2,1,0.5c0.3,0.3,0.4,0.8,0.4,1.3c0,0.5-0.1,1-0.4,1.3c-0.3,0.3-0.6,0.5-1,0.5
                                c-0.4,0-0.8-0.2-1-0.5c-0.3-0.3-0.4-0.8-0.4-1.3C106.4,15.7,106.5,15.2,106.8,14.9z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M112.4,18.8c0-0.9-0.1-1.7-0.1-2.4c0-0.5,0-1-0.1-1.6h0.1c0.1,0.4,0.5,1.1,1.3,2.2c0.7,1,1.1,1.6,1.1,1.7h1
                                c0-0.8-0.1-1.7-0.1-2.7c0-1,0-1.8,0.1-2.5h-1c0,0.8,0.1,1.5,0.1,2.2c0,0.5,0,1,0.1,1.6h-0.1c-0.1-0.4-0.5-1.1-1.2-2.1
                                c-0.7-1-1-1.5-1-1.7h-1.2c0,0.7,0.1,1.5,0.1,2.5c0,1,0,1.9-0.1,2.7H112.4z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M59.1,31.3v2h6c-0.1,1.4-0.6,2.5-1.4,3.3c-1.2,1.2-2.8,1.8-4.6,1.8c-1.7,0-3.2-0.6-4.5-1.8
                                c-1.3-1.2-1.9-2.8-1.9-4.7c0-1.9,0.6-3.5,1.9-4.7c1.3-1.2,2.8-1.8,4.5-1.8c1.9,0,3.4,0.7,4.5,1.9l1.4-1.4c-0.6-0.8-1.5-1.4-2.6-1.8
                                c-1.1-0.5-2.2-0.7-3.4-0.7c-2.4,0-4.4,0.8-6,2.5c-1.7,1.6-2.5,3.7-2.5,6.1c0,2.4,0.8,4.5,2.5,6.1c1.7,1.6,3.7,2.5,6,2.5
                                c2.5,0,4.5-0.8,6-2.4c1.4-1.4,2-3.2,2-5.5c0-0.4,0-0.8-0.1-1.2H59.1z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M73.9,28.5c-1.7,0-3.1,0.6-4.1,1.7c-1.1,1.1-1.6,2.6-1.6,4.3s0.5,3.1,1.6,4.3c1.1,1.1,2.5,1.7,4.1,1.7
                                c1.7,0,3.1-0.6,4.1-1.7c1.1-1.1,1.6-2.6,1.6-4.3s-0.5-3.1-1.6-4.3C76.9,29,75.5,28.5,73.9,28.5z M76.4,37.4
                                c-0.7,0.7-1.6,1.1-2.6,1.1c-1,0-1.9-0.4-2.6-1.1c-0.7-0.7-1.1-1.7-1.1-2.9c0-1.2,0.4-2.2,1.1-2.9c0.7-0.7,1.6-1.1,2.6-1.1
                                c1,0,1.9,0.4,2.6,1.1c0.7,0.7,1.1,1.7,1.1,2.9C77.5,35.7,77.2,36.6,76.4,37.4z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M86.1,28.5c-1.7,0-3.1,0.6-4.1,1.7c-1.1,1.1-1.6,2.6-1.6,4.3s0.5,3.1,1.6,4.3c1.1,1.1,2.5,1.7,4.1,1.7
                                c1.7,0,3.1-0.6,4.1-1.7c1.1-1.1,1.6-2.6,1.6-4.3s-0.5-3.1-1.6-4.3C89.2,29,87.8,28.5,86.1,28.5z M88.7,37.4
                                c-0.7,0.7-1.6,1.1-2.6,1.1c-1,0-1.9-0.4-2.6-1.1c-0.7-0.7-1.1-1.7-1.1-2.9c0-1.2,0.4-2.2,1.1-2.9c0.7-0.7,1.6-1.1,2.6-1.1
                                c1,0,1.9,0.4,2.6,1.1c0.7,0.7,1.1,1.7,1.1,2.9C89.8,35.7,89.4,36.6,88.7,37.4z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M101.9,30.4L101.9,30.4c-0.5-0.6-1-1-1.7-1.4c-0.7-0.4-1.4-0.5-2.3-0.5c-1.5,0-2.7,0.6-3.8,1.7
                                c-1.1,1.1-1.6,2.6-1.6,4.3s0.5,3.1,1.6,4.3c1.1,1.1,2.3,1.7,3.8,1.7c0.8,0,1.6-0.2,2.3-0.6c0.7-0.4,1.2-0.8,1.6-1.4h0.1v1.1
                                c0,1.2-0.3,2.1-1,2.8c-0.7,0.7-1.6,1-2.7,1c-0.7,0-1.4-0.2-2-0.6c-0.6-0.4-1-0.9-1.2-1.5l-1.9,0.8c0.4,0.9,1,1.6,1.8,2.3
                                c0.8,0.7,1.9,1,3.3,1c1.6,0,3-0.5,4.1-1.5c1.1-1,1.7-2.5,1.7-4.4V28.8h-2V30.4z M100.8,37.4c-0.7,0.7-1.5,1.1-2.5,1.1
                                c-1,0-1.8-0.4-2.5-1.1c-0.7-0.7-1.1-1.7-1.1-2.9c0-1.2,0.4-2.2,1.1-2.9c0.7-0.7,1.5-1.1,2.5-1.1c1,0,1.8,0.4,2.5,1.1
                                c0.7,0.7,1,1.7,1,3C101.9,35.7,101.5,36.7,100.8,37.4z"></path>
                            <rect x="105.9" y="23.6" class="st0 style-scope p4m-checkout" width="2.1" height="16.4"></rect>
                            <path class="st0 style-scope p4m-checkout" d="M114.7,28.5c-1.6,0-2.9,0.6-4,1.8c-1,1.2-1.5,2.6-1.5,4.2c0,1.7,0.5,3.2,1.6,4.3c1.1,1.1,2.4,1.7,4.1,1.7
                                c1.2,0,2.3-0.3,3.1-0.9c0.8-0.6,1.4-1.3,1.8-2.2l-1.9-0.8c-0.5,1.3-1.6,1.9-3.1,1.9c-0.9,0-1.7-0.3-2.4-1c-0.7-0.7-1.1-1.6-1.1-2.7
                                h8.9l0-0.4c0-1.8-0.5-3.3-1.5-4.4C117.7,29,116.4,28.5,114.7,28.5z M111.5,33.1c0.2-0.8,0.6-1.5,1.2-2c0.6-0.5,1.2-0.7,2-0.7
                                c1.1,0,1.9,0.3,2.4,0.9c0.5,0.6,0.8,1.2,0.9,1.8H111.5z"></path>
                            <path class="st0 style-scope p4m-checkout" d="M132,23.6h-5.6v16.4h2.1v-6.6h3.5c1.4,0,2.6-0.5,3.6-1.4c1-0.9,1.5-2.1,1.5-3.5c0-1.4-0.5-2.6-1.5-3.5
                                C134.6,24.1,133.4,23.6,132,23.6z M134.2,30.5c-0.5,0.6-1.2,0.9-2.1,0.9h-3.5v-5.7h3.5c0.9,0,1.6,0.3,2.1,0.9
                                c0.5,0.6,0.8,1.3,0.8,2C135,29.2,134.7,29.9,134.2,30.5z"></path>
                            <rect x="138.5" y="23.6" class="st0 style-scope p4m-checkout" width="2.1" height="16.4"></rect>
                            <path class="st0 style-scope p4m-checkout" d="M146.9,28.5c-1.3,0-2.3,0.3-3,0.9c-0.8,0.6-1.3,1.2-1.5,1.9l1.9,0.8c0.2-0.5,0.5-0.9,1-1.2
                                c0.5-0.3,1.1-0.4,1.7-0.4c0.8,0,1.5,0.2,2.1,0.7c0.6,0.5,0.8,1.2,0.8,2v0.3c-0.8-0.5-1.8-0.7-3-0.7c-1.4,0-2.6,0.3-3.5,1
                                c-0.9,0.7-1.4,1.7-1.4,2.9c0,1.1,0.4,2,1.2,2.7c0.8,0.7,1.8,1,3,1c1.6,0,2.9-0.6,3.7-1.9h0.1v1.6h2v-6.8c0-1.5-0.5-2.7-1.4-3.6
                                C149.5,28.9,148.3,28.5,146.9,28.5z M148.8,37.5c-0.7,0.6-1.5,1-2.4,1c-0.6,0-1.2-0.2-1.6-0.5c-0.5-0.3-0.7-0.8-0.7-1.3
                                c0-0.6,0.3-1.1,0.8-1.6c0.5-0.4,1.3-0.7,2.3-0.7c1.2,0,2.1,0.2,2.7,0.7C149.9,36.1,149.5,36.9,148.8,37.5z"></path>
                            <polygon class="st0 style-scope p4m-checkout" points="157.9,36.9 157.9,36.9 154.6,28.8 152.3,28.8 156.9,39.3 154.3,45 156.5,45 163.5,28.8 161.2,28.8     
                                "></polygon>
                            <path class="st0 aqua style-scope p4m-checkout" d="M29.9,28.9c-2.3-2.3-4.6-4.6-6.9-7c-3.5-3.6-7.1-7.2-10.6-10.8c-0.2-0.2-0.3-0.2-0.5,0
                                c-0.5,0.5-0.6,1.1-0.6,1.7c0,5.2,0,10.5,0,15.7c0,0,0,0,0,0c0,2.2,0,4.4,0,6.6c0,3.1,0,6.2,0,9.3c0,0.7,0.2,1.4,0.8,1.8
                                c0.3,0.3,0.6,0.3,0.9-0.1c5.6-5.6,11.2-11.2,16.8-16.8C30.1,29.2,30.1,29.1,29.9,28.9z"></path>
                            <path class="st0 style-scope green p4m-checkout" d="M30.6,28.2c0.2,0.2,0.3,0.1,0.5,0c1.6-1.6,3.2-3.2,4.8-4.8c0.3-0.3,0.3-0.4-0.1-0.5c-7.2-4-14.4-8-21.5-12.1
                                c-0.3-0.2-0.6-0.3-1-0.3c0.1,0.1,0.1,0.2,0.2,0.2C19.2,16.6,24.9,22.4,30.6,28.2z"></path>
                            <path class="st0 style-scope red p4m-checkout" d="M31.3,30.3c-0.3-0.3-0.4-0.3-0.8,0c-5.2,5.3-10.4,10.5-15.6,15.8c0.1,0,0.2-0.1,0.3-0.2
                                c6.7-3.7,13.4-7.3,20.1-11c0.3-0.2,0.3-0.3,0.1-0.5C33.9,33,32.6,31.7,31.3,30.3z"></path>
                            <path class="st0 style-scope orange p4m-checkout" d="M43.5,27.2c-2-1.1-4-2.2-6-3.4c-0.2-0.1-0.4-0.1-0.6,0.1c-1.7,1.7-3.4,3.4-5.1,5c-0.2,0.2-0.2,0.3,0,0.5
                                c1.5,1.5,2.9,2.9,4.3,4.4c0.2,0.2,0.4,0.2,0.7,0.1c2-1.1,4-2.2,6.1-3.4c0.3-0.2,0.7-0.4,1-0.6c0.4-0.3,0.7-0.7,0.7-1.3
                                C44.6,28,44.2,27.5,43.5,27.2z"></path>
                        </g>
                        </svg>
                        </a>
                        </div>
                   </div>

                </div> <!-- END div.left -->

                <p4m-purchase-btn id="p4mPurchaseBtn"></p4m-purchase-btn>

            </footer>

        </div>

        <p4m-general-fault id="generalFault" no-cancel-on-outside-click with-backdrop></p4m-general-fault>
        <p4m-overlay id="screenOverlay" no-cancel-on-outside-click with-backdrop></p4m-overlay>

        <polymer-cookie id="sessionCookie" name="CartId"></polymer-cookie>

        <style include="p4m-shared">
            :host {
                position: relative;
                display: block;
            }

            p4m-general-fault {
               --p4m-general-fault-h1-border: 5px solid red;
                --p4m-general-fault-h1-border: #37a553;
                --p4m-general-fault-h1-font-size: 28px;
                --p4m-general-fault-h1-line-height: 1em;
                --p4m-general-fault-h1-margin-bottom: .425em;
            }
/*            iron-overlay-backdrop {
                --iron-overlay-backdrop-background-color: #37a553;
                --iron-overlay-backdrop-opacity: 0.95;
            }*/
            .litte-spinner {
                width: 20px;
                height: 20px;
                position: relative;
                xtop: 65px;
                xleft: 40%;
                margin-left: auto;
            }
            paper-tab {
                border-right: 1px solid rgba(255,255,255,0.2);
                padding: 0;
            }
            paper-tab:first-of-type {
                border-left: none;
            }
            #downloadAppAd {
                display: flex;
                flex: 1;
                flex-direction: column;
                align-items: flex-end;
                justify-content: center;
                padding: 0 15px;
            }
            #downloadAppAd p {
                color: #aaa;
                margin-top: 0;
                font-size: 12px;
                white-space: nowrap;
            }
            .app-buttons {
                display: flex;
                flex-direction: row;
                height: 36px;
            }
            .app-buttons a {
                display: block;
                margin-left: 5px;
            }
            .app-buttons a svg {
                height: 36px;
            }
            .app-buttons a svg path, .app-buttons a svg polygon, .app-buttons a svg rect {
                fill: #aaa;
                -webkit-transition: all 0.3s ease;
                -moz-transition: all 0.3s ease;
                -o-transition: all 0.3s ease;
                transition: all 0.3s ease;
            }
            .app-buttons a svg:hover path, .app-buttons a svg:hover polygon, .app-buttons a svg:hover rect {
                fill: #222;
            }
            .app-buttons a svg:hover path.orange, .app-buttons a svg:hover polygon.orange, .app-buttons a svg:hover rect.orange {
                fill: #ffb375;
            }
            .app-buttons a svg:hover path.red, .app-buttons a svg:hover polygon.red, .app-buttons a svg:hover rect.red {
                fill: red;
            }
            .app-buttons a svg:hover path.green, .app-buttons a svg:hover polygon.green, .app-buttons a svg:hover rect.green {
                fill: #adeda7;
            }
            .app-buttons a svg:hover path.red, .app-buttons a svg:hover polygon.red, .app-buttons a svg:hover rect.red {
                fill: #c33c7e;
            }
            .app-buttons a svg:hover path.aqua, .app-buttons a svg:hover polygon.aqua, .app-buttons a svg:hover rect.aqua {
                fill: #4dcdc7;
            }
            p4m-order-text {
                min-width: 472px;
                height: 84px;
                font-size: 14px;
                line-height: 16px;
                display: flex;
                align-items: center;
            }
            footer {
                overflow: hidden; 
                height: 84px;
            }
            #footerpPanel .left {
                display: flex;
                flex: 4;
                flex-wrap: wrap;
            }
            paper-input label {
                /*font-family: 'Roboto', 'Noto', sans-serif;
                -webkit-font-smoothing: antialiased;
                font-size: 16px;
                font-weight: 400;
                line-height: 24px;*/
                font-family: 'Lato', sans-serif;
                -webkit-font-smoothing: antialiased;
                font-size: 14px;
                font-weight: 400;
                line-height: 24px;
            }
        </style>
    </template>

    <script>

        Polymer({
            is: "p4m-checkout",

            properties: {
                sessionId: {
                    type: String
                },
                consumerData: {
                    type: Object,
                    notify: true
                    //observer: "onConsumerDataChange"
                },              
                cartData: {
                    type: Object,
                    notify: true,
                },
                isNew: {
                    type: Object,
                    value: false
                },
                deliveryData: {
                    type: Object,
                    notify: true
                },
                selectedTab: {
                    type: Number,
                    value: 0
                },
                currency: {
                    type: String,
                    value: "GBP"
                },
                selectedCard: {
                    type: Object
                },
                hostType:{
                    type: String,
                    value: "dev" //default value
                },
                useGfsCheckout: {
                    type: Object,
                    value: false
                },
                usePaypal: {
                    type: Object,
                    value: false,
                    notify: true
                },
                gfsAccessToken: {
                    type: String
                },
                gfsData: {
                    type: String
                },
                initialPostCode: {
                    type: String,
                    value: "W1A 0AX"
                },
                initialCountryCode: {
                    type: String,
                    value: "GB"
                },
                localCountries: {
                    type: Array,
                    value: []
                },
                onSessionExpiry: {
                    type: String
                },
                _notUseGfsCheckout: {
                    type: Object,
                    value: true
                },
                _changeTimer: {
                    //Timer object to allow sending of changes once user has finished interaction
                    type: Object
                },
                _changeIndicatorClass: {
                    type: String,
                    value: "not_changed"
                },
                _loadingStack: {
                    type: Number,
                    value: 0
                }
                
            },

            observers: [
                //"onCartDiscountChange(cartData.discounts.*)"
               "onCartItemsChange(cartData.items.*)",
               //"onCartAddressSelect(cartData.addressId)"
               "onConsumerAddressChange(consumerData.addresses.*)"
            ],

            listeners: {
                'noShippingWarning.tap': 'goToAddresses'
            },

            ready: function()
            {
                console.log("P4M Checkout ready", new Date().getTime());
                //console.log('Async:',async);
                var self = this;
                this.Tabs = { "ORDER": 0, "ADDRESS": 1, "DELIVERY": 2, "PAYMENT": 3 };
                this._notUseGfsCheckout = !this.useGfsCheckout;

                if (!this.sessionId) {
                    this.sessionId = this.$.sessionCookie.readCookie();
                }

                this.init();
            },

            init: function () {
                var self = this;
                self.initialising = true;
                console.log('Initialising...');
                window.addEventListener('discount', this.onDiscount.bind(this));
                window.addEventListener('discountdelete', this.onDiscountDelete.bind(this));

                self.sessionAddressId = hashThis(this.sessionId);

                //Set local countries -- this determins if Calendar and Click and Collect tabs are available
                this.localCountries.push(this.initialCountryCode);
                for (var i=0; i<this.localCountries.length; i++) {
                    this.localCountries[i] = this.localCountries[i].toLowerCase();
                }

                async.parallel(
                    [
                        function _consumer(callback) {
                            self._getConsumer(callback)
                        },

                        //Get local cart
                        function _localCart(callback) {
                            console.log('_localCart()');
                            if (self.sessionId) {
                                self.getLocalCart(function (err) {
                                    if (err) {
                                        callback(err)
                                    }
                                    else {
                                        console.log('init: First updateP4mCart() start');
                                        self.updateP4mCart(function(err) {
                                            console.log('init: First updateP4mCart() finished');
                                            callback(err);
                                        });
                                    }
                                });
                            }
                            else {
                                callback("No cart");
                                //self.getP4mCart(callback);
                            }
                        }
                    ],
                    function (err) {

                        if (err) {
                            self.initialising = false;
                            console.error(err);
                            console.log('...Initialisation aborted.');
                            throw err;
                        }
                        //Send info from cart and consumer to GFS
                        self.initialising = false;
                        console.log('_gfs()');
                        self._runGFS_IfReady(function (err) {
                            if (err) {
                                console.error(err);
                                console.error("Cancelled initialisation.");
                            }
                            self.initialising = false;
                            console.log('...Initialisation complete.');
                        })
                    }
                )

                this.$.p4mPurchase.beforePurchase = this.$.gfsCheckoutWidget._closeReq.bind(this.$.gfsCheckoutWidget);
            },

            _getConsumer: function (callback) {
                var self = this;
                if (!callback)
                    callback = function () { };


                self.$.p4mCheckoutApi.call('consumer', null, null, function (err, data) {
                    if (!data.success) {
                        callback(data.error);
                    }
                    else {
                        self.set('consumerData', data.consumer);
                        if (data.consumer.hasInstalledApp)
                            self.$.downloadAppAd.classList.add("hide");
                        callback(err, data);
                    }
                });
            },


            //Send all cart information to shipping plugin
            _gfsCurrentAddrId: null,
            _updateGfs: function (callback) {
                if (!callback) {
                    callback = function(){};
                }

                if (!this.cartData || !this.cartData.items || this.cartData.items.length === 0) {
                    callback();
                    return;
                }

                var self = this;
                
                this._gfsCurrentAddrId = this._gfsCurrentAddrId || this.cartData.addressId || this.consumerData.prefDeliveryAddressId;
                this._updateUiForAddress(this.getAddressById(this._gfsCurrentAddrId));

                var orderValue = 0.0;
                this.cartData.items.forEach(function (item) {
                    orderValue += item.qty * item.price;
                });
                if (orderValue <= 0.0) {
                    callback();
                    return;
                }

                var addrPrefs = this.consumerData.deliveryPreferences ? this.consumerData.deliveryPreferences.split(',') : null;
                var defAddr = this.getDefaultAddr();
                var currAddr = this.getCartAddr();
                var gfsPostConfig = {
                    countryCode: currAddr.countryCode,
                    town: currAddr.city,
                    postCode: currAddr.postCode,
                    addressLineCollection: [currAddr.street1, currAddr.street2],
                    contactEmail: this.consumerData.email,
                    recipientFirstName: this.consumerData.familyName,
                    recipientLastName: this.consumerData.givenName,
                    recipientTitle: this.consumerData.title || "",
                    favDropPoints: self._getPreferredDropPoints() || [],
                    favAddresses: self._getPreferredAddresses(currAddr) || [],
                    defaultAddress: p4mAddressToGfsAddress(defAddr),
                    cartValue: orderValue,
                    addressPreferences: addrPrefs,
                    deliveryPreferences: {
                        preferSoonest: this.consumerData.preferSoonestDelivery
                    },
                    mapCenter: { 'lat': currAddr.latitude, 'lng': currAddr.longitude }
                };

                //Make an object containing everything needed for GFS Checkout to re-select my previous delivery options
                var selection = null;
                if (!this.isNew && self.cartData.addressId) {
                    var addr = self.getAddressById(self.cartData.addressId);
                    var dropPointId = addr ? addr.dropPointId : null;
                    selection = {
                        dropPointId: dropPointId,
                        deliveryMethodId: self.cartData.serviceId,
                        address: p4mAddressToGfsAddress(addr) || null,
                        deliveryDate: self.cartData.expDeliveryDate ? new Date(self.cartData.expDeliveryDate) : null
                    }
                }
                this.toggleLoading(true);
                this.$.gfsCheckoutWidget.init(gfsPostConfig, selection, function(err) {
                    self.toggleLoading(false);
                    callback(err);
                });

            },

            getDefaultAddr: function () {
                return this.getAddressById(this.consumerData.prefDeliveryAddressId);
            },

            getCartAddr: function () {
                var returnAddr = null;
                var addrId = (this.cartData && this.cartData.addressId) ? this.cartData.addressId : null;
                if (addrId)
                    returnAddr = this.getAddressById(addrId);
                if (!returnAddr) {
                    this.cartData.addressId = this.consumerData.prefDeliveryAddressId;
                    returnAddr = this.getAddressById(this.consumerData.prefDeliveryAddressId);
                }
                return returnAddr;
            },

            debug: function (e) {
                console.log("p4m-checkout debug", this.cartData);
            },

            getLocalCart: function (callback) {
                var self = this;
                this.$.localApi.call('getP4MCart', null, null, function (err, data) {
                    if (err) {
                        console.log("getLocalCart() error:", err);
                        callback(err);
                    }
                    else {
                        self.isNew = data.isNew;
                        self.cartData = data.cart;
                        callback(err, data.cart);
                    }
                });
            },

            sendCartItemChanges: function () {          
                //Send changes to local API, then to P4m

                var self = this;
                var changes = [];

                for (var sku in this.$.cart.changes) {
                    if (this.$.cart.changes[sku] === "" || this.$.cart.changes[sku] === null) {
                        this.$.cart.changes[sku] = 0;
                    }
                    changes.push({ItemCode: sku, Qty: this.$.cart.changes[sku]});
                }
                if (changes.length > 0) {
                    
                    var orderValue = 0.0;
                    for (var item in this.$.cart.items) {
                        orderValue += item.qty * item.price; 
                    }

                    //this.$.gfsCheckoutWidget.setGfsOrderValue(orderValue, function () {
                    //self._showAsLoadingShipping(true);
                    self.toggleLoading(true);

                    self.$.localApi.call('itemQtyChanged', {}, changes, function (err, newCartTotals) {
                        //console.log("Called local api itemQtyChanged");
                        console.log("sendCartItemChanges(): itemQtyChanged: new cart totals", newCartTotals);
                        self.$.cart.clearChanges();
                        self.updCartTotals(newCartTotals, function (err) { //This will trigger GFS to trigger updateP4mCart, so no need to call it in the callback here. Commented out.
                            self.toggleLoading(false);
                            self.set("cartData.discounts", newCartTotals.discounts);
                            /*self.updateP4mCart(function(err) {
                                self.toggleLoading(false);
                                //callback(err);
                            });*/
                            
                        });

                    });
                    //})

                }
                else {
                    //console.log("No changes to send");
                }
            },

            //Send new total to shipping module and ask for new shipping price etc
            updCartTotals: function (newCartTotals, callback, updDiscount) {
                // this gets called when an item qty is changed, or when a discount is changed
                this.cartData.tax = newCartTotals.tax || 0;
                this.cartData.shippingAmt = newCartTotals.shipping || 0;
                this.cartData.total = newCartTotals.total || 0;
                if (!updDiscount && this.cartData.total > 0) {
                    var self = this;
                    this._updateGfs(function () {
                        self.updateP4mCart(callback);
                    });
                }
                else
                    this.updateP4mCart(callback);
            },

            _showAsLoadingShipping: function(loading) {
                this.$.delivery_spinner.active = loading;
            },
            
            _toggleAddressesLoading: function(loading) {
                this.$.addresses_spinner.active = loading;  
            },


            toggleLoading: function (loading) {
                var showAsLoading;
                if (loading === 'reset') {
                    this._loadingStack = 0;
                }
                else if (loading) {
                    this._loadingStack++;
                }
                else {
                    this._loadingStack--;
                }
                showAsLoading = (this._loadingStack > 0);

                if (showAsLoading) {
                    this.$.screenOverlay.open();
                    this.$.orderSummary.showAsLoading();
                    this._showAsLoadingShipping(this.cartData && this.cartData.total > 0);
                    this._toggleCartEditing(false);

                    //this.$.p4mPurchase.setLoadingState(true);
                }
                else {
                    this.$.screenOverlay.close();
                    this.$.orderSummary.showAsLoaded();
                    this._showAsLoadingShipping(false);
                    this._toggleCartEditing(true);
                    //this.$.p4mPurchase.setLoadingState(false);
                }

            },

            _toggleCartEditing: function(allowEditing) {
                this.$.cart.toggleEditing(allowEditing);
            },

            updateP4mCart: function (callback) {
                //Send changes to P4M
                if (!callback) {
                    console.warn('updateP4mCart: no callback');
                    callback = function () { };
                } 
                console.log('updateP4mCart()');
                this.updating = true;
                try {
                   
                    var self = this;
                    var cartMessage =
                    {
                        "sessionId": this.sessionId,
                        "clearItems": (!this.cartData.id), //true, // are we always replacing the whole cart? or ClearItems = this.cartData.Id === null; ??
                        "cart": this.cartData
                    };

                    this.toggleLoading(true);
                    this.$.p4mCheckoutApi.call('postCart', null, cartMessage, function (err, data) {
                        self.updating = false;
                        if (err) {  
                            //This is a workaround. Need to either stop the double-post, or fix the 404 response to them.
                            /*console.warn('An error occurred while updating ParcelForMe:', err);
                            console.log('Stack:', new Error().stack);
                            self.onRemoteCartData.bind(self)({Cart:self.cartData}, callback);  //TODO: Fix double-post error causing 404 in P4M back end, so we can stop suppressing errors here*/

                            callback(err);
                        }
                        else {
                            self.onRemoteCartData.bind(self)(data, callback);
                        }
                    });
                }
                catch (e) {
                    this.updating = false;
                }                
            },

            onRemoteCartData: function (data, callback) {
                console.log('onRemoteCartData()');
                this.toggleLoading(false);
                if (!data.success) {
                    console.error(data.error);
                    callback(data.error)
                }
                else {
                    
                    if (!data.cart || !data.cart.items || data.cart.items.length === 0) {

                        window.location.reload(true);
                    }                  
                    else {
                        this.cartData = data.cart;
                        this.isNew = data.isNew;
                    }
                    callback(null);
                }                                     
            },

            onCartItemsChange: function (e) {
                console.log('p4m-checkout: onCartItemsChange()');
                //If this is a valid change record,
                var beforeHash = JSON.stringify(e.base);
                var afterHash = JSON.stringify(e.value);
                if (e.path && beforeHash !== afterHash ) {
                    //Start timer, then send changes.
                    //If more changes are detected while the timer is active, reset the timer.
                    console.log("onCartItemsChange: Preparing to send cart changes");
                    if (this._changeTimer) window.clearTimeout(this._changeTimer);
                    this._changeTimer = window.setTimeout(this.sendCartItemChanges.bind(this), 2000);
                }
                else
                {
                    console.log("onCartItemsChange: No cart changes");
                }
            },

            onConsumerAddressChange: function (e) {
                if (!this.initialising)
                    this._runGFS_IfReady();
            },

            _runGFS_IfReady: function (callback) {
                var shouldShow = this._readyForShippingSelector();
                this._ensureShippingVisible(shouldShow);
                if (shouldShow && !this._gfsCurrentAddrId) {
                    this._updateGfs(callback);
                }
                else if (callback)
                    callback();
            },

            _ensureShippingVisible: function (show) {
                if (show) {
                    this.$.noShippingWarning.classList.add('hidden');
                    this.$.shippingSelector.classList.remove('hidden');
                }
                else {
                    this.$.noShippingWarning.classList.remove('hidden');
                    this.$.shippingSelector.classList.add('hidden');
                }
            },

            _readyForShippingSelector: function () {
                return this.cartData && this.getDefaultAddr();
            },

            //Take data from shipping selector representing selected shipping options
            //For example output, see gfs-checkout event selectedservicechanged
            //WARNING: Nothing in this function should send messages to the shipping selector or an endless feedback loop will ensue!
            currentService: {},
            updateShippingService: function (data, callback) { //service, shipping, expDeliveryDate, collectPoint) {
                var self = this;
                if (!callback) {
                    throw "updateShippingService(): No callback";
                }
                this.updatingShipping = true;
                //If nothing has changed, exit
                if (this.currentService.shipping === data.shipping &&
                    this.currentService.collectionPoint === data.collectionPoint &&
                    this.currentService.service === data.service &&
                    this.currentService.serviceId === data.serviceId &&
                    this.currentService.expDeliveryDate === data.expDeliveryDate &&
                    this.sameAddress(this.currentService.deliveryAddress, data.deliveryAddress)) {
                        console.warn("updateShippingService(): Nothing has changed")
                        this.updatingShipping = false;
                        callback(null);                       
                }
                else {
                    self.toggleLoading(true);
                    var addr = this.consumerData.addresses.find(a => a.id === this.cartData.addressId);
                    var shippingDetails = { 'service': data.service, 'amount': data.shipping, 'dueDate': data.expDeliveryDate, 'address': addr };
                    // got new shipping details so we need to get updated tax from the host
                    this.$.localApi.call('updShippingService', null, shippingDetails, function (err, cartTotals) {
                        if (err) {
                            console.error("localApi updShippingService error: ", err);
                            self.toggleLoading(false);
                            callback(err);
                        }
                        else {
                            self.currentService = data;
                            self.set('cartData.carrier', data.carrier);
                            self.set('cartData.shippingAmt', data.shipping);
                            self.set('cartData.serviceName', data.service);
                            self.set('cartData.serviceId', data.serviceId);
                            self.set('cartData.dropPointId', data.collectionPoint);
                            self.set('cartData.expDeliveryDate', data.expDeliveryDate);
                            self.set('cartData.tax', cartTotals.tax || 0);
                            self.set('cartData.total', cartTotals.total || 0);
                            if (data.collectionPoint) {
                                self.selectCollectPoint(data.provider, data.providerId, data.collectionPoint, data.deliveryAddress, data.companyName, function (err) {
                                    self.updateP4mCart(function (err) {
                                        self.updatingShipping = false;
                                        self.toggleLoading(false);
                                        callback(err);
                                    });
                                });
                            }
                            else if (data.deliveryAddress.id && data.deliveryAddress.id !== self.cartData.addressId) {
                                console.log("update shipping addr: ", addr);
                                self.selectDeliveryAddress(data.deliveryAddress.id, false /*Not updating GFS*/, function (err) {
                                    self.updateP4mCart(function (err) {
                                        self.updatingShipping = false;
                                        self.toggleLoading(false);
                                        callback(err);
                                    })
                                });
                            }
                            else {
                                // something has changed on the cart so we need to update it
                                console.log("updating cart because service or address has changed");
                                self.updateP4mCart(function (err) {
                                    self.updatingShipping = false;
                                    self.toggleLoading(false);
                                    callback(err);
                                })
                            }
                        }
                    });
                }
            },

            sameAddress: function (addr1, addr2) {
                return (
                    addr1.addressLineCollection.length === addr2.addressLineCollection.length &&
                    (addr1.addressLineCollection.length == 0 || addr1.addressLineCollection[0] === addr2.addressLineCollection[0]) &&
                    (addr1.addressLineCollection.length <= 1 || addr1.addressLineCollection[1] === addr2.addressLineCollection[1]) &&
                    ((!addr1.countryCode && !addr2.countryCode) || addr1.countryCode.code === addr2.countryCode.code) &&
                    addr1.county === addr2.county &&
                    addr1.postCode === addr2.postCode &&
                    addr1.town === addr2.town
                ) ? true : false;
            },

            selectCollectPoint: function (providerName, providerId, collectPointId, collectPointAddress, company, callback) {
                if (!callback) callback = function () { };
                var self = this;
                var result;
                if (!collectPointId) {
                    console.error("No collectPointId");
                    if (callback)
                        callback();
                    return;
                }
               
                var existingDropPoint = this.$.addressList.getDropPointById(collectPointId);
                if (!existingDropPoint || existingDropPoint.unsaved) {
                    var directions = collectPointAddress.directions ? collectPointAddress.directions.split("]").pop() : "";
                    var prefOrder = this.consumerData.addresses.length || 1;
                    var address =
                    {
                        "id": this.sessionAddressId,
                        "addressType": "Collect",
                        "label": providerName,
                        "companyName": company,
                        "specialInstructions": directions,
                        "street1": collectPointAddress.addressLines[0] || "",
                        "street2": collectPointAddress.addressLines[1] || "",
                        "city": collectPointAddress.town,
                        "postCode": collectPointAddress.postCode,
                        "state": collectPointAddress.county,
                        "country": collectPointAddress.country,
                        "countryCode": collectPointAddress.countryCode,
                        "phone": collectPointAddress.phone,
                        "latitude": collectPointAddress.coordinates.latitude,
                        "longitude": collectPointAddress.coordinates.longitude,
                        "dropPointProviderId": providerName,              
                        "dropPointId": collectPointId,
                        "collectPrefOrder": prefOrder,
                        "unsaved": true
                    };
                    self.saveAddress(address, function (err, result) {
                        self.notifyPath('consumerData.addresses');
                        callback(err);
                    });
                            
                }
                else {
                    //TODO: Replace with selectDeliveryAddress?
                    this.selectDeliveryAddress(existingDropPoint.id, false, callback);
                }
              
            },

            onPaymentComplete: function (e) {
                if (e && e.detail.redirectUrl) {
                    window.location = e.detail.redirectUrl;
                }
            },
            

            onSelectPaymentMethod: function (e) {
                var updCart = this.selectedCard !== undefined && this.selectedCard !== null;
                this.set('cartData.payMethodId', e.detail.id);
                this.selectedCard = e.detail;
                if (updCart) {
                    this.updateP4mCart();
                }
            },

            //onCardHashData: function (data) {
            //    this.set('cardTimestamp', data.Timestamp);
            //    this.set('cardMerchantId', data.MerchantId);
            //    this.set('cardHash', data.Hash);               
            //},

            onDiscount: function (e) {
                var cartDiscount = this.cartData.discounts.find(function (element, index, arr) { return element.code === e.detail.code; }); //TODO: Change to bound function; arrow functions may not work in older browsers
                if (cartDiscount) {
                    if (cartDiscount.description !== e.detail.description ||
                        cartDiscount.amount !== e.detail.amount ||
                        cartDiscount.code !== e.detail.code)
                    {
                        cartDiscount.description = e.detail.description;
                        cartDiscount.amount = e.detail.amount || 0;
                        cartDiscount.code = e.detail.code;
                        this.updCartTotals(e.detail, null, true);
                    }
                }
                else {
                    this.push('cartData.discounts', e.detail);
                    this.updCartTotals(e.detail, null, true);
                }
            },

            onDiscountDelete: function (e) {
                var code = e.detail;              
                var item = this.cartData.discounts.find(function(element, index, arr) { return (element.code === code) });
                if (item) {
                    item.amount = 0;
                    item.description = "Deleted";
                    var self = this;
                    this.$.localApi.call('removeDiscountCode', null, { "discountCode": code }, function (err, response) {
                        if (response && response.success)
                            self.updCartTotals(response, null, true);   // this will upate the cart as well
                    });
                }
            },

            onGotNewCard: function(){
                 this._getConsumer();
            },

            onSelectAddressFromList: function (e) {
                var self = this;
                if (e.detail) {

                    //If changed billing address, tell P4M
                    if (e.detail.isBilling && self.cartData.billingAddressId != e.detail.id) {
                        self.set('cartData.billingAddressId', e.detail.id);
                        self.updateP4mCart();
                    }
                    //If changed delivery address, tell GFS and P4M
                    else if (e.detail.isDelivery && self.cartData.addressId != e.detail.id) {
                        self.selectDeliveryAddress(e.detail.id, true, function (err) {
                            if (err) {
                                console.error(err);
                            }
                        });                     
                    }
                }
            },

            selectDeliveryAddress: function (addressId, sendToGfs, callback) {
                var self = this;
                var address = this.getAddressById(addressId);
                if (!callback) callback = function(){};

                if (!address) {
                    callback("No such address");
                    //return false;
                }
                else {
                    self.set('cartData.addressId', addressId); //This allows the address UI to update
                    self.notifyPath('cartData.addressId');
                    //Send to GFS Checkout and await shipping event
                    //If this is a user-initiated address change, we need to tell GFS and get new shipping details back (via onGfsServiceChanged)
                    if (sendToGfs) {
                        // the address is changing so we need to set the default service method and del. date
                        self.cartData.serviceId = null;
                        self.cartData.expDeliveryDate = null;
                        self._gfsCurrentAddrId = addressId;
                        this._updateGfs(function (err) {
                            self.$.gfsCheckoutWidget.selectFavAddress(address);
                            callback(err, address);
                        });
                    }
                    else {
                        callback(null, address);
                    }
                }
            },

            onAddAddress: function (e) {
                this.onUpdateAddress(e);
            },

            saveAddress: function (address, finalCallback) {
                if (!address.addressType) {
                    address.addressType = 'Address';
                }
                var self = this;
                var result = null

                var hasAnAddress = this.consumerData.addresses.length && this.consumerData.addresses.some(function (address) { return address.id && address.id != ""; });
                var existingAddress = hasAnAddress && address.id && address.id != "" && this.getAddressById(address.id);
                var postData =
                {
                    "Address": address,
                    "isPrefDeliveryAddr": !hasAnAddress,
                    "isBillingAddr": !hasAnAddress
                };

                async.series(
                    [
                        function _postAddress(callback) {
                            self.toggleLoading(true);
                            // send the new address details to P4M
                            self.$.p4mCheckoutApi.call("postAddress", null, postData, function (err, data) {
                                result = data;
                                address = result.address;
                                // if this is the first address it will be set as the billing and delivery addresses
                                if (result.isBillingAddr && (!self.consumerData.billingAddressId || self.consumerData.billingAddressId !== address.id)) {
                                    self.set('consumerData.billingAddressId', address.id);
                                    self.set('cartData.billingAddressId', address.id);
                                }
                                if (result.isPrefDeliveryAddr && (!self.consumerData.prefDeliveryAddressId || self.consumerData.prefDeliveryAddressId !== address.id)) {
                                    self.set('consumerData.prefDeliveryAddressId', address.id);
                                }
                                if (!existingAddress) {
                                    self.push('consumerData.addresses', result.address);
                                }
                                else
                                    self.updAddressById(address);
                                if (address.addressType === 'Address')
                                    self.$.gfsCheckoutWidget.setFavAddresses(self._getPreferredAddresses(address));
                                else
                                    self.$.gfsCheckoutWidget.setFavDropPoints(self._getPreferredDropPoints());
                                callback(err, result);
                            });
                        },
                        function _selectAddress(callback) {
                            // check if the selected address has changed
                            if (!self.cartData.addressId || self.cartData.addressId != address.id) {
                                var sendToGfs = result.address.addressType === 'Address';
                                self.selectDeliveryAddress(result.address.id, sendToGfs, function (err, data) {
                                    //  result = data;
                                    callback(err);
                                });
                            }
                            else
                                callback(null);
                        }
                    ],
                    function (err) {
                        self.toggleLoading(false);
                        finalCallback(err, result);
                    }
                )
            },

            onUpdateAddress: function (addressElement) {
                // here we're adding or updating an address only, not setting a default value on the consumer at this stage

                this._toggleAddressesLoading(true);

                var self = this;
                this.saveAddress(addressElement.detail.addressData, function (err, result) {
                    self._toggleAddressesLoading(false);
                    if (err) {
                        throw err;
                    }
                    else {
                        addressElement.detail.addressData.id = result.address.id;
                        self._ensureShippingVisible(true);
                    }
                });

            },

            _updateUiForAddress: function (address) {
                if (address && address.countryCode) {
                    var localDelivery = this.localCountries && this.localCountries.constructor == Array && this.localCountries.length && (this.localCountries.indexOf(address.countryCode.toLowerCase()) > -1);

                    this.$.gfsCheckoutWidget.enableClickAndCollect(localDelivery);
                    this.$.gfsCheckoutWidget.enableCalendarDelivery(localDelivery);
                    if (!localDelivery) {
                        this.$.gfsCheckoutWidget.showPage_Standard(); //Show the standard tab, which is now the only available one.
                    }
                }
            },
            /*
            preselectDeliveryMethod: function () {
                //Select delivery details based on selected address and user's preferences
                if (!this.consumerData) throw "No consumer data"
                else if (!this.cartData) throw "No cart data";

               
                //this.consumerData.PreferSoonestDelivery = true; //TODO: Remove. This is just here for testing.
                //Rather than opening a page, let's handle this directly.

                if (this.consumerData.PreferSoonestDelivery) {
                    if (this.$.gfsCheckoutWidget) {
                        //this.$.gfsCheckoutWidget.showPage_Calendar(true);
                        this.$.gfsCheckoutWidget._preselectForCalendar();
                    }
                }
                else {
                    if (this.$.gfsCheckoutWidget) {
                        this.$.gfsCheckoutWidget._preselectForStandard();
                        //this.$.gfsCheckoutWidget.showPage_Standard(true);
                    }

                }
               

            },
*/
  
            /*
            selectPreferredAddress: function (callback) {
                //If there is a preferred delivery address, select that.
                //PRECONDITION: Consumer data and Cart data exists
                console.log('selectPreferredAddress');
                if (this.consumerData.prefDeliveryAddressId) {
                    this.selectDeliveryAddress(this.consumerData.prefDeliveryAddressId, false, callback);
                }
                else {
                    callback("No preferred address");
                }
            },*/

            _getPreferredDropPoints: function() {
                return this.consumerData.addresses         
                    .filter(function (item) { return (item.addressType == "Collect" && item.latitude && item.dropPointId) })
                    .sort(this.sortByPreference)
                    .map(p4mDroppointToGfsDroppoint);
            },

            sortByPreference: function (a, b) {
                if (a.collectPrefOrder < b.collectPrefOrder)
                    return -1
                else if (b.collectPrefOrder < a.collectPrefOrder)
                    return 1
                else 
                    return 0;
            },

            _getPreferredAddresses: function (topAddr) {
                var preferredAddress = topAddr || this.getDefaultAddr();
                var prefId = preferredAddress ? preferredAddress.id : null;
                return this.consumerData.addresses
                    .filter(function (item, i) { return (item.addressType == "Address") }) //Only addresses, not droppoints
                    .sort(function (a, b) { if (a.id == prefId) { return -1; } else { return 1 } })
                    .filter(function (item, i) { return (i < 99) }) //Up to 99 addresses                   
                    .map(p4mAddressToGfsAddress);
            },

            onGfsServiceChanged: function (e) {
                if (this.initialising) {
                    console.warn('onGfsServiceChanged(): not updating while initialising');
                    return;
                }
                else {
                    console.log("p4m widget: onGfsServiceChanged():", e);
                    this.triggerChangeIndicator();
                    this.updateShippingService(e.detail, function () { console.log("onGfsServiceChanged: updateShippingService complete")});
                }
            },

            triggerChangeIndicator: function() {

                this.set("_changeIndicatorClass", "not_changed");
                window.setTimeout(function(){this.set("_changeIndicatorClass", "change")}.bind(this), 10);
                

            },

            onGfsServicePreselect: function (e) {
                this.updateShippingService(e.detail, function () { console.log("onGfsServicePreselect: updateShippingService complete") });
            },

            onGfsNoService: function (e) {
                // this.preselectDeliveryMethod();
                console.error('No GFS service');
                this.showGeneralFault();
            },

            onP4mNoService: function (e) {
                console.error('No P4M service');

                this.showGeneralFault();
            },

            onGfsSessionExpiry: function (e) {
                console.log("GFS Checkout session expired");
                var self = this;
                this.$.localApi.call('renewShippingToken', null, null, function (err, data) {
                    if (err) {
                        self.showGeneralFault();
                    }
                    self._gfsCurrentAddrId = null;
                    self.toggleLoading('reset');
                    self._updateGfs(function () { self.$.gfsCheckoutWidget.refreshShippingTab(); });
                });
            },

            addressExists: function(addrId) {
                if (this.consumerData && this.consumerData.addresses && this.consumerData.addresses.length > 0) 
                    return this.consumerData.addresses.find(function (item) { return item.id === addrId });
                return false;
            },

            getAddressById: function (id) {
                if (id && this.consumerData && this.consumerData.addresses && this.consumerData.addresses.length > 0) {
                    var foundItem = this.consumerData.addresses.find(function (item) { return item.id == id });
                    if (foundItem)
                        return foundItem;
                }
                return null;
            },

            updAddressById: function (address) {
                //return;
                if (!this.consumerData) {
                    return null;
                }
                var foundAt = this.consumerData.addresses.findIndex(function (addr) { return addr.id === address.id; });
                if (foundAt >= 0)
                    for (var prop in address) {
                        if (address.hasOwnProperty(prop)) {
                            this.consumerData.addresses[foundAt][prop] = address[prop];
                        }
                    }
                    //this.consumerData.addresses[foundAt] = address;
            },

            goToPaymentMethods: function () {
                this.selectedTab = this.Tabs.PAYMENT;
                this.$.cardList.addNewCard();
            },

            goToAddresses: function () {
                this.selectedTab = this.Tabs.ADDRESS;
                this.$.addressList.toggleAddressMode();
            },

            _onSelectTab: function (tab) {
                //Tab changed
                //console.log(tab);
                var page = tab.detail.item;
                if (page.id === 'deliveryPage') {
                    // refresh google map because it's been hidden
                    this.$.gfsCheckoutWidget.checkMapIsReset();
                }
//                console.log('page selected', page);
            },

            showGeneralFault: function() {
                //return; //Debug
                this.fire('generalFault');
                this.$.generalFault.open();
            },

            hideGeneralFault: function () {
                this.$.generalFault.close();
            },
        });

        function p4mDroppointToGfsDroppoint(item) {
           var gfsAddress = {
                droppointId: item.dropPointId,
                droppointDescription: item.companyName,
                geoLocation: {
                                    
                    postCode: item.postCode,
                    addressLineCollection: [item.companyName, item.street1],
                    addressLines: [item.companyName, item.street1],
                    town: item.city,
                    coordinates: {
                        latitude: item.latitude,
                        longitude: item.longitude
                    },
                    countryCode: item.countryCode,
                    county: "",
                    directions: item.specicalInstructions
                },
                providerId: item.dropPointProviderId,
                providerLogo: "https://s-media-cache-ak0.pinimg.com/avatars/pelithepenguin_1453991623_140.jpg",
                providerName: item.label
            };
            return gfsAddress;

        }

        function p4mAddressToGfsAddress(item) {
            if (!item) return false
            else {

                var gfsAddress = {
                    id: item.id,
                    countryCode: {
                        code: item.countryCode || "GB",
                        encoding: "ccISO_3166_1_Alpha2"
                    },
                    postCode: item.postCode || "",
                    town: item.city,
                    addressLineCollection: [item.street1, item.street2],
                    addressLines: [item.street1, item.street2],
                    name: item.label
                };
                if (item.latitude && item.longitude) {
                    gfsAddress.lat = item.latitude,
                    gfsAddress.lng = item.longitude
                }
                return gfsAddress;
            }
        }

        function hashThis(value) {
            //return Math.random().toString();
            return value.split("").reverse().join("")
        }
    </script>
</dom-module>

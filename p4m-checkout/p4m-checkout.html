
<link rel="import" href="../../polymer/polymer.html" />

<link rel="import" href="../../polymer-cookie/polymer-cookie.html" />
<link rel="import" href="../../paper-tabs/paper-tabs.html" />
<link rel="import" href="../../iron-pages/iron-pages.html" />
<link rel="import" href="../../iron-media-query/iron-media-query.html" />  

<link rel="import" href="../p4m-spinner/p4m-spinner.html" />
<link rel="import" href="../p4m-shared/p4m-shared.html" />
<link rel="import" href="../p4m-profile/p4m-profile.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="import" href="../p4m-cart/p4m-cart.html" /> 
<link rel="import" href="../p4m-order-summary/p4m-order-summary.html" />
<link rel="import" href="./p4m-footer.html" />
<link rel="import" href="../p4m-address-list/p4m-address-list.html" />
<link rel="import" href="../p4m-purchase/p4m-purchase.html" />
<link rel="import" href="../p4m-card-list/p4m-card-list.html" />
<link rel="import" href="../p4m-overlay/p4m-overlay.html" />
<link rel="import" href="../p4m-overlay/p4m-general-fault.html" />

<link rel="import" href="../p4m-discount-input/p4m-discount-input.html" />
<link rel="import" href="../p4m-discount-list/p4m-discount-list.html" />

<link rel="import" href="../gfs-checkout-widget/gfs-checkout-widget.html" />
<link rel="import" href="../address-lookup-field/address-lookup-field.html" />  


<link rel="import" href="../p4m-imports/p4m-imports.html" />  
 
<link rel="stylesheet" href="../p4m-shared/p4m.css" />

<dom-module id="p4m-checkout">

    <template>

        <meta name="viewport" content="width=device-width,initial-scale=1">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <p4m-api id="p4mCheckoutApi" ssl="true" on-noservice="onP4mNoService" host-base-domain="parcelfor.me" host-type="{{hostType}}" version="v2"></p4m-api>
        <p4m-api id="localApi" is-local="true" on-noservice="onRetailerNoService"></p4m-api>

        <!-- P4m standard dom-if media-queries -->    
        <iron-media-query query="(max-width: 768px)" query-matches="{{mobile}}"></iron-media-query>
<!--         <iron-media-query query="(max-width: 375px)" query-matches="{{Phone}}"></iron-media-query>
        <iron-media-query query="(min-width: 376px) and (max-width: 767px)" query-matches="{{Phablet}}"></iron-media-query>
        <iron-media-query query="(min-width: 768px) and (max-width: 1024px)" query-matches="{{Tablet}}"></iron-media-query>
        <iron-media-query query="(min-width: 1024px)" query-matches="{{Desktop}}"></iron-media-query>
        <iron-media-query query="(min-width: 768px)" query-matches="{{LargerThanPhone}}"></iron-media-query>
        <iron-media-query query="(max-width: 767px)" query-matches="{{SmallerThanDesktop}}"></iron-media-query> -->

        <!-- LargerThanPhone  --> 
<!--         <template is="dom-if" if="{{LargerThanPhone}}">       
        </template>  -->
        <!-- / LargerThanPhone -->

        <!-- SmallerThanDesktop -->
<!--         <template is="dom-if" if="{{SmallerThanDesktop}}">
        </template>  -->
        <!-- / smallerThanDesktop -->

        <div id="container" class$="{{_changeIndicatorClass}}"> 
            <div id="topPanel" class="topPanel">
				<template is="dom-if" if="{{!mobile}}" restamp>
                    <img class="p4m-register-logo" src="../p4m-shared/img/P4M-Top-Header.png" id="peli-icon-header" />
                </template>
    			<template is="dom-if" if="{{mobile}}" restamp>
                    <div class="logos">
                        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 456.2 91" style="enable-background:new 0 0 456.2 91;" xml:space="preserve" id="logo">
                            <style type="text/css">
                                .st0 {display: none;}
                                .st1 {display: inline;}
                                .st2 {fill: #ffffff;}
                            </style>
                            <g id="Layer_2" class="st0"><rect x="0.6" class="st1" width="480" height="91"></rect></g>
                            <g id="Layer_1">
                                <g id="Vector_Smart_Object_xA0_Image_1_"></g>
                                <g id="Parcel_For_Me"></g>
                                <g>
                                    <path class="st2" d="M157.8,32.8c0-0.2-0.4-0.4-0.6-0.4h-0.4c-0.2,0-0.4,0.2-0.6,0.4l-11.7,25.6c-0.2,0.4,0.2,1,0.9,0.8h2.4
                                                                            c0.4,0,0.5-0.4,0.8-0.6c0.6-1.6,1.5-3.3,2.3-5.1h12.5l2.3,5.3c0,0.4,0.4,0.6,0.8,0.6h2.5c0.6,0,0.9-0.6,0.6-1L157.8,32.8z
                                                                                M152.2,50.2l4.7-10.4h0.2l4.7,10.4H152.2z"></path>
                                    <path class="st2" d="M95.7,5.7c-4.1,1-12.2,4.5-19.8,1.3c-11.1-4.3-15.3,8-16.2,11.5C58.9,21.7,51.1,46,8.6,4.1
                                                                            C7.4,2.8,5.6,3.7,5.8,5.4c0.5,14.4,13.6,28.3,13.6,28.3S49.9,67.5,6,75.3c-9,2-4.1,4.5-2,5.3c0.8,0.2,1.4,0.8,2,1.4
                                                                            c0.8,0.8,1.3,2,0,3.5c-2.4,2.4-5.7,6.4,3.7,5.1c9.4-1.4,69.6-8.8,71.9-51.7C82.7,14.5,92,11.4,96.5,7.1
                                                                            C97.1,6.5,96.5,5.4,95.7,5.7z M73.7,10.8c1,0,1.6,0.2,2.3,0.2c0.2,0.2,0.5,0.5,0.2,0.8l-1.3,1.7c0,0-3.5,4.1-5.5,1.8
                                                                            c-0.2-0.2-0.2-0.4-0.4-0.6C67.8,11.8,71.9,10.4,73.7,10.8z M14.5,87.6c-0.2,0-0.4-0.2-0.6-0.2c-0.6-1.6-1.4-6.7,8.2-11.2
                                                                            C49,66,56.8,45.7,59.5,38c3.3-9,7.4-15.8,13.5-10.2C89.7,43.1,69.3,79.4,14.5,87.6z"></path>
                                    <path class="st2" d="M132.4,32.6h-8.5c-0.5,0-0.8,0.4-0.8,0.8v25.2c0,0.4,0.4,0.8,0.8,0.8h2.3c0.4,0,0.8-0.4,0.8-0.8v-9h5.5
                                                                            c4.6,0,8.5-3.8,8.5-8.5C140.9,36.6,137.1,32.6,132.4,32.6z M132.2,45.9h-5.3v-9.4h5.3c2.7,0,4.9,1.8,4.9,4.5
                                                                            C137.2,43.9,134.9,45.9,132.2,45.9z"></path>
                                    <path class="st2" d="M70.7,13.8c1,1.3,2.8-1,2.8-1l0.6-0.4c0.2-0.2,0-0.4-0.2-0.4s-0.6,0-1-0.2c-1-0.2-3.1,0.6-2.4,1.8
                                                                            C70.5,13.8,70.7,13.8,70.7,13.8z"></path>
                                    <path class="st2" d="M40.1,22.6c0,0.6,0.4,0.9,0.8,1c2.3,0.8,10.4,3.5,13.1-1.6c0.6-1,0.2-2.3-0.6-3.1c-6.1-4.9-9-9.4-11.8-14.3
                                                                            V4.4c-2.4-5.1-7.4-7.1-6.4,3.5C35.8,16.4,39.1,21.1,40.1,22.6z"></path>
                                    <path class="st2" d="M377.4,40.8c0-4.5-3.9-8.2-8.4-8.2h-10.4c-0.5,0-0.8,0.4-0.8,0.8l-0.2-0.1v24.9c0,0.4,0.4,0.8,0.8,0.8h2.4
                                                                            c0.4,0,0.8-0.4,0.8-0.8v-9.6h5.7l5.1,10c0,0.2,0.4,0.4,0.6,0.4h3.1c0.6,0,0.9-0.6,0.6-1l-5.1-9.6
                                                                            C375.1,47.2,377.4,44.3,377.4,40.8z M368.5,45.7h-6.7v-9.2h6.7c2.4,0,4.7,2,4.7,4.5C373.2,43.7,370.9,45.7,368.5,45.7z"></path>
                                    <path class="st2" d="M313.6,32.6h-15.1c-0.5,0-0.8,0.4-0.8,0.8l-0.2-0.1v25.3c0,0.4,0.4,0.8,0.8,0.8h2.4c0.4,0,0.8-0.4,0.8-0.8
                                                                            v-10h10.2c0.4,0,0.8-0.4,0.8-0.8v-2c0-0.4-0.4-0.8-0.8-0.8h-10.2v-8.8h12.1c0.5,0,0.8-0.4,0.8-0.8v-2
                                                                                    C314.4,33,314,32.6,313.6,32.6z"></path>
                                    <path class="st2" d="M196.8,40.8c0-4.5-3.9-8.2-8.4-8.2H178c-0.5,0-0.8,0.4-0.8,0.8l-0.2-0.1v24.9c0,0.4,0.4,0.8,0.8,0.8h2.4
                                                                            c0.4,0,0.8-0.4,0.8-0.8v-9.6h6l5.1,10c0,0.2,0.4,0.4,0.6,0.4h3.1c0.6,0,0.9-0.6,0.6-1l-5.3-9.6C194.5,47.2,196.8,44.3,196.8,40.8z
                                                                                M188,45.7h-7v-9.2h7c2.4,0,4.7,2,4.7,4.5C192.7,43.7,190.4,45.7,188,45.7z"></path>
                                    <path class="st2" d="M334.7,32.4c-7.6,0-13.7,6.1-13.7,13.7s6.1,13.7,13.7,13.7c7.6,0,13.7-6.2,13.7-13.7
                                                                            C348.5,38.5,342.3,32.4,334.7,32.4z M334.7,55.9c-5.3,0-9.8-4.5-9.8-9.8c0-5.6,4.5-10,9.8-10c5.3,0,9.8,4.7,9.8,10
                                                                            S340.2,55.9,334.7,55.9z"></path>
                                    <path class="st2" d="M451.8,36.3c0.5,0,0.8-0.4,0.8-0.8v-2c0-0.4-0.4-0.8-0.8-0.8h-15.2c-0.5,0-0.8,0.4-0.8,0.8h0.1v25.2
                                                                            c0,0.4,0.4,0.8,0.8,0.8h15.1c0.5,0,0.8-0.4,0.8-0.8v-2c0-0.4-0.4-0.8-0.8-0.8h-12.1v-8.2h10.2c0.4,0,0.8-0.4,0.8-0.8v-2
                                                                            c0-0.4-0.4-0.8-0.8-0.8h-10.2v-7.8H451.8z"></path>
                                    <path class="st2" d="M252.5,32.6h-15.1c-0.5,0-0.8,0.4-0.8,0.8v25.2c0,0.4,0.4,0.8,0.8,0.8h15.1c0.5,0,0.8-0.4,0.8-0.8v-2
                                                                            c0-0.4-0.4-0.8-0.8-0.8h-12.1v-8.2h10.2c0.4,0,0.8-0.4,0.8-0.8v-2c0-0.4-0.4-0.8-0.8-0.8h-10.2v-7.8h12.1c0.5,0,0.8-0.4,0.8-0.8
                                                                            v-2C253.3,33,252.9,32.6,252.5,32.6z"></path>
                                    <path class="st2" d="M277,55.7h-10.2V33.4c0-0.4-0.4-0.8-0.8-0.8h-2.4c-0.5,0-0.8,0.4-0.8,0.8v25.1c0,0.4,0.4,0.8,0.8,0.8H277
                                                                            c0.5,0,0.8-0.4,0.8-0.8v-2C277.8,56.1,277.4,55.7,277,55.7z"></path>
                                    <path class="st2" d="M218,36.1c2.2,0,4.7,0.8,6.5,2.4c0.4,0.4,0.8,0.4,1,0l1.6-1.6c0.4-0.2,0.4-0.8,0-1c-2.7-2.2-5.3-3.5-9.2-3.5
                                                                            c-7.5,0-13.7,6.1-13.8,13.5c0,7.6,6.2,13.7,13.7,13.7c3.2,0,6.5-1.3,9.2-3.7c0.2-0.2,0.2-0.8,0-1l-1.8-1.6c-0.2-0.2-0.4-0.2-0.8,0
                                                                            c-1.8,1.4-3.7,2.4-6.5,2.4c-5.5,0-9.6-4.5-9.6-9.8C208.5,40.6,212.5,36.1,218,36.1z"></path>
                                    <path class="st2" d="M421.9,32.8c0-0.4-0.4-0.6-0.6-0.6h-0.6c-0.2,0-0.6,0.2-0.6,0.4l-8,19.5h-0.2l-8-19.5c0-0.2-0.4-0.4-0.6-0.4
                                                                                    h-0.6c-0.2,0-0.6,0.4-0.6,0.6l-4.8,25.6c0,0.4,0.2,0.8,0.8,0.8h2.4c0.2,0,0.6-0.4,0.6-0.6l2.7-16.9h0.2l7,17.6
                                                                                    c0,0.2,0.4,0.4,0.6,0.4h0.6c0.4,0,0.6-0.2,0.6-0.4l7-17.6h0.2l2.8,16.9c0.2,0.4,0.4,0.6,0.8,0.6h2.4c0.4,0,0.9-0.2,0.6-0.8
                                                                                    L421.9,32.8z"></path>
                                </g>
                            </g>
                        </svg>
                        <h2>Checkout &amp; Delivery</h2>
                    </div>
				</template>
                <div class="flex-spacer"></div>
                <div class="welcome"><span class="font-weight-light">Welcome,</span> </div>
                <p4m-profile mode="basic"></p4m-profile>
            </div>

            <template is="dom-if" if="{{!mobile}}" restamp>
                <div id="panelContainer" class="horizontal layout">
                    <div id="detailPanel" class="p4m-panel flex-2">
                        <paper-tabs selected="{{selectedTab}}" no-bar>
                            <paper-tab>My Order<p4m-spinner species="progress" id="myorder_spinner"></p4m-spinner></paper-tab>
                            <paper-tab>Addresses<p4m-spinner species="progress" id="addresses_spinner"></p4m-spinner></paper-tab>
                            <paper-tab>Delivery Options<p4m-spinner species="progress" id="delivery_spinner"></p4m-spinner></paper-tab>
                            <paper-tab>Payment Options<p4m-spinner species="progress" id="payment_spinner"></p4m-spinner></paper-tab>
                        </paper-tabs>
                        <iron-pages id="p4mPages" selected="{{selectedTab}}" on-iron-select="_onSelectTab">
                            <iron-page id="cartPage">
                                <p4m-cart id="cart" cart-data="{{cartData}}"></p4m-cart>
                            </iron-page>
                            <iron-page id="addressPage" style="overflow-x: hidden;">
                                <p4m-address-list id="addressList" address-list-data="{{consumerData.addresses}}" cart-data="{{cartData}}" on-select="onSelectAddressFromList" on-add="onAddAddress" on-update="onUpdateAddress"></p4m-address-list>
                            </iron-page>
                            <iron-page id="deliveryPage">
                                <div id="shippingSelector" class="hidden">

                                    <gfs-checkout id="gfsCheckoutWidget" access-token="{{gfsCheckoutToken}}" on-selectedservicechanged="onGfsServiceChanged" on-gfs-token-expired="onGfsSessionExpiry" on-noservice="onGfsNoService" on-no-delivery-opts="onNoDeliveryOpts" delivery-preferences="{{deliveryPreferences}}" consumer-addresses="{{consumerData.addresses}}"></gfs-checkout>
                                </div>
                                <div id="noShippingWarning">
                                    <p>Please <a class="link green" href="#">enter an address</a> to continue.</p>
                                </div>

                                <template is="dom-if" if="{{useGfsCheckout}}">
                                </template>
                            </iron-page>
                            <iron-page id="cardPage">
                                <p4m-card-list id="cardList" consumer-data="{{consumerData}}" cart-data="{{cartData}}" platform="{{hostType}}" on-selected="onSelectPaymentMethod" on-gotnewcard="onGotNewCard"></p4m-card-list>
                            </iron-page>

                        </iron-pages>
                    </div>
                    <div id="summaryPanel" class="p4m-panel smallSummary flex-1">
                        <p4m-order-summary id="orderSummary" cart-data="{{cartData}}"></p4m-order-summary>
                        <p4m-purchase id="p4mPurchase" cart-data="{{cartData}}" on-payment-complete="onPaymentComplete" on-request-payment-method="goToPaymentMethods" use-paypal="{{usePaypal}}" selected-card="{{selectedCard}}" ></p4m-purchase>
                    </div>
                </div>
                <p4m-footer consumer-data="{{consumerData}}" cart-data="{{cartData}}" change-indicator-class="{{_changeIndicatorClass}}"></p4m-footer>
            </template>
            
            <template is="dom-if" if="{{mobile}}" restamp>
                <div id="panelContainer" class="horizontal layout">
                    <div id="detailPanel" class="p4m-panel flex-2"> 
                        <iron-pages id="mobilepages" selected="{{selected}}" on-iron-select="_onSelectTab">    
                            <iron-page id="summaryPanel" class="p4m-panel smallSummary flex-1 page four">
                                <p4m-order-summary id="orderSummary" mobile="true" cart-data="{{cartData}}"></p4m-order-summary>
                                <p4m-purchase id="p4mPurchase" mobile="true" cart-data="{{cartData}}" on-payment-complete="onPaymentComplete" on-request-payment-method="goToPaymentMethods" use-paypal="{{usePaypal}}" selected-card="{{selectedCard}}" use-paypal="true"></p4m-purchase>
                                <p4m-footer mobile="true" consumer-data="{{consumerData}}" cart-data="{{cartData}}" change-indicator-class="{{_changeIndicatorClass}}"></p4m-footer>
                            </iron-page>

                            <iron-page id="cartPage" class="page one">     
                                <p4m-spinner species="progress" id="myorder_spinner"></p4m-spinner>
                                <p4m-cart id="cart" cart-data="{{cartData}}"></p4m-cart>
                                <div class="action-button">
                                    <button class="grey" onclick="select(0);"><i class="p4micon-delete style-scope gfs-calendar gfs-checkout"></i>Back to checkout</button>
                                </div>
                                <div class="notification success shadow hidden">Changes saved<i class="p4micon-check style-scope gfs-calendar gfs-checkout"></i></div>
                            </iron-page>

                            <iron-page id="addressPage" class="page two">
                                <p4m-spinner species="progress" id="addresses_spinner"></p4m-spinner>
                                <p4m-address-list id="addressList" address-list-data="{{consumerData.addresses}}" cart-data="{{cartData}}" on-select="onSelectAddressFromList" on-add="onAddAddress" on-update="onUpdateAddress"></p4m-address-list>
                                <div class="action-button">
                                    <button class="grey" onclick="select(0);"><i class="p4micon-delete style-scope gfs-calendar gfs-checkout"></i>Back to checkout</button>
                                </div>
                                <div class="notification success shadow hidden">Changes saved<i class="p4micon-check style-scope gfs-calendar gfs-checkout"></i></div>
                            </iron-page>

                            <iron-page id="deliveryPage" class="page three">
                                <p4m-spinner species="progress" id="delivery_spinner"></p4m-spinner>
                                <div id="shippingSelector" class="hidden">

                                    <gfs-checkout id="gfsCheckoutWidget" mobile="true" on-session-expiry="onGfsSessionExpiry" access-token="{{gfsCheckoutToken}}"  on-selectedservicechanged="onGfsServiceChanged" on-noservice="onGfsNoService" on-no-delivery-opts="onNoDeliveryOpts" delivery-preferences="{{deliveryPreferences}}" consumer-addresses="{{consumerData.addresses}}" ></gfs-checkout>
                                </div>
                                <div id="noShippingWarning">
                                    <p>Please <a class="link" href="#">enter an address</a> to continue</p>
                                </div>

                                <template is="dom-if" if="{{useGfsCheckout}}">
                                </template>
                            </iron-page>

                            <iron-page id="cardPage" class="page four">
                                <p4m-spinner species="progress" id="payment_spinner"></p4m-spinner>
                                <p4m-card-list id="cardList" consumer-data="{{consumerData}}" cart-data="{{cartData}}" platform="{{hostType}}" on-selected="onSelectPaymentMethod" on-gotnewcard="onGotNewCard"></p4m-card-list>
                                <div class="action-button">
                                    <button class="grey" onclick="select(0);"><i class="p4micon-delete style-scope gfs-calendar gfs-checkout"></i>Back to checkout</button>
                                </div>
                                <div class="notification success shadow hidden">Changes saved<i class="p4micon-check style-scope gfs-calendar gfs-checkout"></i></div>
                            </iron-page>
                        </iron-pages>
                    </div>  
                </div>  
			</template>
        </div>

        <p4m-general-fault id="generalFault" no-cancel-on-outside-click with-backdrop></p4m-general-fault>
        <p4m-overlay id="screenOverlay" no-cancel-on-outside-click with-backdrop></p4m-overlay>

        <polymer-cookie id="sessionCookie" name="CartId"></polymer-cookie>
        <polymer-cookie id="p4mConsumerCookie" name="p4mConsumer"></polymer-cookie>
        <polymer-cookie id="p4mPrefAddressCookie" name="p4mPrefAddress"></polymer-cookie>
        <polymer-cookie id="p4mCartCookie" name="p4mCart"></polymer-cookie>
        <polymer-cookie id="p4mCartAddressCookie" name="p4mCartAddress"></polymer-cookie>
        <polymer-cookie id="gfsCheckoutTokenCookie" name="gfsCheckoutToken"></polymer-cookie>

        <style include="p4m-shared">
            :host {
                position: relative;
                display: block;
            }

            @media (max-width: 768px)  {
                :host {
                    position: absolute;
                    display: flex;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: initial;
                    z-index: 9999;
                    height: 100%;
                }
            }

            p4m-general-fault {
               --p4m-general-fault-h1-border: 5px solid red;
                --p4m-general-fault-h1-border: #37a553;
                --p4m-general-fault-h1-font-size: 28px;
                --p4m-general-fault-h1-line-height: 1em;
                --p4m-general-fault-h1-margin-bottom: .425em;
            }
            .litte-spinner {
                width: 20px;
                height: 20px;
                position: relative;
                margin-left: auto;
            }
            paper-tab {
                border-right: 1px solid rgba(255,255,255,0.2);
                padding: 0;
            }
            paper-tab:first-of-type {
                border-left: none;
            }
            paper-input label {
                /*font-family: 'Roboto', 'Noto', sans-serif;
                -webkit-font-smoothing: antialiased;
                font-size: 16px;
                font-weight: 400;
                line-height: 24px;*/
                font-family: 'Lato', sans-serif;
                -webkit-font-smoothing: antialiased;
                font-size: 14px;
                font-weight: 400;
                line-height: 24px;
            }

            /* Page transition aniumation */

            #nav > span {
/*                height: 100%;*/
                cursor: pointer;
            }
            #nav > span:hover {
                color: #888;
            }

            /* Define the animation here. You can do pretty much anything you want. */
/*            @keyframes slide {
                from {
                    left: -70%;
                }

                to {
                    left: 0;
                }
            }*/

/*            @keyframes slide-from-left {
                from {
                    left: -100%;
                }

                to {
                    left: 0;
                }
            }
            @keyframes slide-to-right {
                from {
                    left: 0%;
                }

                to {
                    left: 100%;
                }
            }*/

            /* Adding this class starts the animation, removing it cuts it short */
/*            .animated {
                display: block !important;
                animation-duration: 1s;
                animation-name: slide-from-left;
            }
            #summaryPanel.animated {
                animation-name: slide-to-right;
            }
            iron-pages#mobilepages  > .animated:not(.iron-selected) {
                display: block !important;
            }
            iron-pages#mobilepages  > :not(.iron-selected) {
                overflow: hidden;
                display: block !important;
            }
            iron-pages#mobilepages  > :not(.iron-selected) {
                overflow: hidden;
                display: block !important;
            }
*/
            #nav {
                display: flex;
                width: 84px;
                align-self: flex-end;
                text-align: right;
                position: absolute;
                z-index: 2;
                height: 20px;
                margin-top: -64px;
            }
            #nav span {
                background: rgba(255,255,255,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                margin: 1px;
                width: 20px;
                max-width: 20px;
            }
            iron-pages#mobilepages {
                position: relative;
                height: 375px;
                overflow: hidden;
            }
            iron-pages#mobilepages > iron-page {
                position: absolute;
                top: 0;
                bottom: initial;
                height: 375px;
                display: flex !important;
                background: #fff;
                align-items: flex-start;
            }
            /*.animated {
                -webkit-transform: translateY(-0%);
                transform: translateY(-0%);
                transition: transform 300ms ease-out;
                will-change: transform;
            }*/
            iron-pages#mobilepages  > .iron-selected:not(#summaryPanel) {
                -webkit-transform: translateY(0%);
                transform: translateY(0%);
                transition: transform 300ms ease-out;
                will-change: transform;
            }
            iron-pages#mobilepages  > .animated:not(.iron-selected) {
            }
            iron-pages#mobilepages  > :not(.iron-selected):not(#summaryPanel) {
                -webkit-transform: translateY(110%);
                transform: translateY(110%);
                transition: transform 300ms ease-out;
                will-change: transform;
            }


            .page {
                position: relative;
/*
                width: 100vw;
                height: 100vh;*/

                display: flex;
                align-items: center;
                justify-content: center;
                align-self: stretch;
            }

            .page > p {
/*                width: 30vw;
                height: 15vh;

                display: flex;
                align-items: center;
                justify-content: center;

                border: 3px solid black;

                font-size: 5vmin;*/
            }

/*            .page#summaryPanel {
                border: 1px solid orange;
            }
            .page#cartPage {
                border: 1px solid red;
            }
            .page#addressPage {
                border: 1px solid blue;
            }
            .page#deliveryPage {
                border: 1px solid yellow;
            }
            .page#cardPage {
                border: 1px solid green;
            }*/

            #noShippingWarning {
                display: flex;
                height: 100%;
                width: 100%;
                justify-content: center;
                align-items: center;
                font-size: 14px;
            }


        </style>
    </template>

    <script>
        const wantDom = true;
        Polymer({
            is: "p4m-checkout",

            properties: {
                mobile: {
                    type: Object,
                    value: false,
                },
                sessionId: {
                    type: String
                },
                consumerData: {
                    type: Object,
                    notify: true
                    //observer: "onConsumerDataChange"
                },              
                cartData: {
                    type: Object,
                    notify: true,
                },
                isNew: {
                    type: Object,
                    value: false
                },
                deliveryData: {
                    type: Object,
                    notify: true
                },
                selectedTab: {
                    type: Number,
                    value: 0
                },
                currency: {
                    type: String,
                    value: "GBP"
                },
                selectedCard: {
                    type: Object
                },
                hostType:{
                    type: String,
                    value: "dev" //default value
                },
                useGfsCheckout: {
                    type: Object,
                    value: false
                },
                usePaypal: {
                    type: Object,
                    value: false,
                    notify: true
                },
                gfsCheckoutToken: {
                    type: String
                },
                gfsData: {
                    type: String
                },
                initialPostCode: {
                    type: String,
                    value: "W1A 0AX"
                },
                initialCountryCode: {
                    type: String,
                    value: "GB"
                },
                onSessionExpiry: {
                    type: String
                },
                _notUseGfsCheckout: {
                    type: Object,
                    value: true
                },
                _changeTimer: {
                    //Timer object to allow sending of changes once user has finished interaction
                    type: Object
                },
                _changeIndicatorClass: {
                    type: String,
                    value: "not_changed"
                },
                _loadingStack: {
                    type: Number,
                    value: 0
                },

                selected: {
                    type: Number,
                    notify: true,
                    value: 0,
                    observer: '_newPageSelected',
                },

            },

            observers: [
                //"onCartDiscountChange(cartData.discounts.*)"
               "onCartItemsChange(cartData.items.*)",
               //"onCartAddressSelect(cartData.addressId)"
               "onConsumerAddressChange(consumerData.addresses.*)"
            ],

            listeners: {
                // do not attach listeners here for any components created inside a dom-if
            },

            ready: function()
            {
                console.log("P4M Checkout ready", new Date().getTime());
                //console.log('Async:',async);
                var self = this;
                this.Tabs = { "ORDER": 0, "ADDRESS": 1, "DELIVERY": 2, "PAYMENT": 3 };
                this._notUseGfsCheckout = !this.useGfsCheckout;
                if (!this.gfsCheckoutToken) {
                    this.gfsCheckoutToken = this.$.gfsCheckoutTokenCookie.readCookie();
                }
                if (!this.sessionId) {
                    this.sessionId = this.$.sessionCookie.readCookie();
                }
                if (this.mobile) {
                    // move p4m-checkout to the end of the body tag so that we can make it full screen
                    document.body.appendChild(this);
                }
                this.init();
            },

            _newPageSelected (newVal, oldVal) {
                let mobilepages = this._getWidget('mobilepages');
                if (!mobilepages)
                    return;

                mobilepages = mobilepages.children;
                // Run the animation on the newly selected page
                if (!mobilepages[newVal].className.includes('animated')) {
                    mobilepages[newVal].className += ' animated';
                }

                if (typeof oldVal !== 'undefined') {
                    // Stop the animation of hidden pages
                    mobilepages[oldVal].className = mobilepages[oldVal].className.split(' animated').join('');
                }
            },

            firstLoadComplete: false,
            init: function () {
                var self = this;
                self.initialising = true;
                console.log('Initialising...');
                window.addEventListener('discount', this.onDiscount.bind(this));
                window.addEventListener('discountdelete', this.onDiscountDelete.bind(this));
                window.addEventListener('popup-blocked', this.onPopupBlocked.bind(this));
                window.addEventListener('cvv-enter-key', this.clickBuyNow.bind(this));

                self.sessionAddressId = hashThis(this.sessionId);   // default P4M Id for a DP

                // check if the consumer details have changed since last retrieved
                var lastChanged = this.getConsumerLastChanged();
                this.$.p4mCheckoutApi.call('consumerNeedsUpdating', { lastUpdated: lastChanged }, null, function (err, data) {
                    if (!data.result)
                        async.parallel([
                            function _consumer(callback) { self._getConsumer(callback) },
                            function _cart(callback) { self.getCartFromRetailer(callback) }
                        ]);
                    else {
                        console.log('Consumer has changed');
                        //self.$.p4mCartAddressCookie.eraseCookie();  // this will force the cart address to be reassigned
                        self._getConsumer(function (err, data) {
                            if (!err) {
                                //self.isNew = true;
                                self.getCartFromRetailer();
                            }
                        });
                    }
                });
            },

            //Get local cart
            getCartFromRetailer: function (callback) {
                console.log('getting local cart');
                var self = this;
                if (this.sessionId) {
                    this.getLocalCart(function (err) {
                        if (err) {
                            callback(err)
                        }
                        else {
                            if (err) {
                                self.initialising = false;
                                console.error(err);
                                console.log('...Initialisation aborted.');
                                throw err;
                            }
                            //Send info from cart and consumer to GFS
                            console.log('_gfs()');
                            self._runGFS_IfReady(function (err) {
                                self.initialising = false;
                                if (err) {
                                    console.error(err);
                                    console.error("Cancelled initialisation.");
                                }
                                var checkout = self._getWidget('gfsCheckoutWidget');
                                self._getWidget('p4mPurchase').beforePurchase = checkout._closeReq.bind(checkout);
                                self.listen(self._getWidget('noShippingWarning'), 'tap', 'goToAddresses');
                                console.log('...Initialisation complete.');
                                self.firstLoadComplete = true;
                            })
                        }
                    });
                }
                else {
                    if (callback)
                        callback("No cart");
                    //self.getP4mCart(callback);
                }
            },

            _components: [],
            _getWidget: function (name, wantDomNode) {
                // normally we could use this.$.componentName to get components, but because they're 
                // now wrapped in dom-ifs that won't work
                for (var i = 0; i < this._components.length; i++) {
                    if (this._components[i].name === name)
                        return wantDomNode ? this._components[i].domNode : this._components[i].polyNode;
                }
                var domNode = this.$$('#' + name);
                var polyNode = null;
                this._components.push({ name: name, domNode: domNode, polyNode: polyNode ? polyNode : domNode });
                return wantDomNode ? domNode : (polyNode ? polyNode : domNode);
            },

            _getConsumer: function (callback) {
                var self = this;
                if (!callback)
                    callback = function () { };

                self.$.p4mCheckoutApi.call('consumer', null, null, function (err, data) {
                    if (!data.success) {
                        callback(data.error);
                    }
                    else {
                        self.set('consumerData', data.consumer);
                        var addr = self.getDefaultAddr();
                        var gfs = self._getWidget('gfsCheckoutWidget');
                        if (!gfs.config) {
                            // this can happen if P4M returns before the local cart - e.g. when consumer must be updated before sending cart
                            self.gfsPostConfig.defaultAddress = p4mAddressToGfsAddress(addr);
                            self.gfsPostConfig.favAddresses = self._getPreferredAddresses();
                            self.gfsPostConfig.favDropPoints = self._getPreferredDropPoints();
                        }
                        else {
                            gfs.config.defaultAddress = p4mAddressToGfsAddress(addr);
                            gfs.setFavAddresses(self._getPreferredAddresses());
                            gfs.setFavDropPoints(self._getPreferredDropPoints());
                        }
                        self.updateConsumerCookie(addr);
                        if (data.consumer.hasInstalledApp)
                            self._getWidget('downloadAppAd', wantDom).classList.add("hide");
                        callback(err, data);
                    }
                });
            },

            updateConsumerCookie: function(addr) {
                // the consumer cookie stores default address details so that we can initiate GFS before getting the consumer
                var prefAddr = this.getAddressById(this.consumerData.prefDeliveryAddressId);
                if (!addr)
                    addr = prefAddr;
                var consumer = this.consumerData;
                document.cookie = "p4mConsumer=" + 
                    fldStr(consumer.id) + fldStr(consumer.deliveryPreferences) + fldStr(consumer.extras.localId) + fldStr(consumer.lastChanged, true) + "; path=/;";
                this.updatePrefAddrCookie(prefAddr);
                document.cookie = "p4mAvatarUrl=" + fldStr(consumer.profilePicUrl, true) + "; path=/;";
                document.cookie = "p4mGivenName=" + fldStr(consumer.givenName, true) + "; path=/;";
            },

            updateAddressCookies: function (addr) {
                // an address has been edited so the cookies may need to be updated
                if (!addr) return;
                var consumer = this.consumerData;
                if (consumer.prefDeliveryAddressId === addr.id)
                    this.updatePrefAddrCookie(addr);
                if (this.cartData.addressId === addr.id)
                    this.updateCartAddressCookie(addr);
            },

            updatePrefAddrCookie: function (prefAddr) {
                // the consumer's preferred delivery address
                document.cookie = "p4mPrefAddress=" +
                    fldStr(prefAddr.id) + fldStr(prefAddr.dropPointId) + fldStr(prefAddr.street1) + fldStr(prefAddr.street2) + fldStr(prefAddr.city) +
                    fldStr(prefAddr.postCode) + fldStr(prefAddr.state) + fldStr(prefAddr.countryCode) + fldStr(prefAddr.latitude) +
                    fldStr(prefAddr.longitude, true) + "; path=/;";
            },

            updateCartCookie: function () {
                // the consumer cookie stores default address details so that we can initiate GFS before getting the consumer
                var cart = this.cartData;
                var addr = this.getCartAddr();
                document.cookie = "p4mCart=" + fldStr(cart.id) + fldStr(cart.addressId) + fldStr(addr.dropPointId) +
                                               fldStr(cart.serviceId) + fldStr(cart.expDeliveryDate, true) + "; path=/;";
                this.updateCartAddressCookie(addr);
            },

            updateCartAddressCookie: function (addr) {
                document.cookie = "p4mCartAddress=" +
                    fldStr(addr.id) + fldStr(addr.dropPointId) + fldStr(addr.street1) + fldStr(addr.street2) + fldStr(addr.city) +
                    fldStr(addr.postCode) + fldStr(addr.state) + fldStr(addr.countryCode) + fldStr(addr.latitude) +
                    fldStr(addr.longitude, true) + "; path=/;";
            },

            //Send all cart information to shipping plugin
            _gfsCurrentAddrId: null,
            gfsPostConfig: {},
            _updateGfs: function (selectAddr, callback, showingOverlay) {
                if (!callback) {
                    callback = function(){};
                }

                if (!this.cartData || !this.cartData.items || this.cartData.items.length === 0) {
                    callback();
                    return;
                }

                var self = this;
                if (!this.setGfsConfigValues()) {
                    callback("Couldn't set GFS values: cart is empty");
                    return;
                }

                //Make an object containing everything needed for GFS Checkout to re-select my previous delivery options
                var selection = null;
                var hasCartAddrCookie = self.$.p4mCartAddressCookie.readCookie();
                if (selectAddr || (/*!this.isNew &&*/ hasCartAddrCookie && self.cartData.addressId)) {
                    var addr = self.getAddressById(self.cartData.addressId);
                    var dropPointId = addr ? addr.dropPointId : null;
                    selection = {
                        dropPointId: dropPointId,
                        deliveryMethodId: self.cartData.serviceId,
                        address: p4mAddressToGfsAddress(addr) || null,
                        deliveryDate: self.cartData.expDeliveryDate ? new Date(self.cartData.expDeliveryDate) : null
                    }
                }
                if (!showingOverlay)
                    this.toggleLoading(true);
                this._getWidget('gfsCheckoutWidget').init(this.gfsPostConfig, selection, function (err, data) {
                    //self.updateCartCookie();
                    self.toggleLoading(false);
                    callback(err, data);
                });

            },

            setGfsConfigValues: function() {
                this._gfsCurrentAddrId = this.getDefaultCartAddrId();
                //this._updateUiForAddress(this.getAddressById(this._gfsCurrentAddrId));

                var orderValue = 0.0;
                this.cartData.items.forEach(function (item) {
                    orderValue += item.qty * item.price;
                });
                if (orderValue <= 0.0) {
                    callback();
                    return false;
                }
                var addrPrefs = this.consumerData.deliveryPreferences ? this.consumerData.deliveryPreferences.split(',') : null;
                var currAddr = this.getCartAddr();
                var defAddr = this.getDefaultAddr(currAddr);
                this.gfsPostConfig.id = currAddr.id;
                this.gfsPostConfig.countryCode = currAddr.countryCode;
                this.gfsPostConfig.town = currAddr.city;
                this.gfsPostConfig.county = currAddr.state;
                this.gfsPostConfig.postCode = currAddr.postCode;
                this.gfsPostConfig.addressLineCollection = [currAddr.street1, currAddr.street2];
                //contactEmail: this.consumerData.email,
                //recipientFirstName: this.consumerData.familyName,
                //recipientLastName: this.consumerData.givenName,
                //recipientTitle: this.consumerData.title || "",
                //favDropPoints: self._getPreferredDropPoints() || [],
                //favAddresses: self._getPreferredAddresses(currAddr) || [],
                this.gfsPostConfig.cartValue = orderValue;
                this.gfsPostConfig.nearestAddress = defAddr;
                this.gfsPostConfig.addressPreferences = addrPrefs;
                this.gfsPostConfig.deliveryPreferences = {
                    preferSoonest: this.consumerData.preferSoonestDelivery ? true : false
                };
                this.gfsPostConfig.mapCenter = { lat: currAddr.latitude, lng: currAddr.longitude };
                this.gfsPostConfig.label = currAddr.label;
                return true;
            },

            //_updateGfsCartTotal: function (callback) {
            //    if (!callback) {
            //        callback = function () { };
            //    }

            //    if (!this.cartData || !this.cartData.items || this.cartData.items.length === 0) {
            //        callback();
            //        return;
            //    }

            //    var self = this;
            //    if (!this.setGfsConfigValues()) {
            //        callback("Couldn't set GFS values: cart is empty");
            //        return;
            //    }
            //    this.toggleLoading(true);
            //    this._getWidget('gfsCheckoutWidget').initCartTotalOnly(this.gfsPostConfig, function (err, shippingAmt) {
            //        self.toggleLoading(false);
            //        callback(err, shippingAmt);
            //    });

            //},

            getConsumerLastChanged: function() {
                var consDetails = this.$.p4mConsumerCookie.readCookie();
                if (consDetails) {
                    var parts = consDetails.split('|');
                    if (parts.length === 4)
                        return parts[3];
                }
                return new Date();
            },

            setConsumerDefaultsFromCookie: function () {
                var consDetails = this.$.p4mConsumerCookie.readCookie();
                var parts = consDetails.split('|');
                if (parts.length !== 4)
                    this.consumerData = { id: null, prefDeliveryAddressId: null, deliveryPreferences: null, lastChanged: null, addresses: [] };
                else {
                    var addr = this.getAddressFromString(this.$.p4mPrefAddressCookie.readCookie());
                    var cartAddr = this.getAddressFromString(this.$.p4mCartAddressCookie.readCookie());
                    if (!addr)
                        this.consumerData = { id: parts[0], prefDeliveryAddressId: null, deliveryPreferences: parts[1], addresses: [], extras: { localId: parts[2] }, lastChanged: parts[3] };
                    else if (!cartAddr || (cartAddr && addr.id === cartAddr.id))
                        this.consumerData = { id: parts[0], prefDeliveryAddressId: addr.id, deliveryPreferences: parts[1], addresses: [addr], extras: { localId: parts[2] }, lastChanged: parts[3] };
                    else
                        this.consumerData = { id: parts[0], prefDeliveryAddressId: addr.id, deliveryPreferences: parts[1], addresses: [addr, cartAddr], extras: { localId: parts[2] }, lastChanged: parts[3] };
                }
            },

            getAddressFromString: function(addrStr) {
                var addrParts = addrStr.split('|');
                var addr;
                if (addrParts.length === 10)
                    addr = {
                        id: fldOrNull(addrParts[0]), dropPointId: fldOrNull(addrParts[1]), street1: fldOrNull(addrParts[2]),
                        street2: fldOrNull(addrParts[3]), city: fldOrNull(addrParts[4]), postCode: fldOrNull(addrParts[5]),
                        state: fldOrNull(addrParts[6]), countryCode: fldOrNull(addrParts[7]), 
                        latitude: +fldOrNull(addrParts[8]), longitude: +fldOrNull(addrParts[9])
                    };
                return addr;
            },

            updateCartDataFromCookie: function () {
                var cartDetails = this.$.p4mCartCookie.readCookie();
                // cart.Id + "|" + cart.AddressId + "|" + cart.DropPointId + "|" + cart.ServiceId + "|" + dateStr;
                // if there is no cart address cookie then we can skip updating most details
                var idOnly = this.$.p4mCartAddressCookie.readCookie() ? false : true;
                var parts = cartDetails.split('|');
                if (parts.length === 5) {
                    this.cartData.id = fldOrNull(parts[0]);
                    if (!idOnly) {
                        this.cartData.addressId = fldOrNull(parts[1]);
                        this.cartData.dropPointId = fldOrNull(parts[2]);
                        this.cartData.serviceId = fldOrNull(parts[3]);
                        this.cartData.expDeliveryDate = fldOrNull(parts[4]);
                        var addr = this.getAddressFromString(this.$.p4mCartAddressCookie.readCookie());
                        if (addr)
                            this.addOrUpdAddress(addr);
                    }
                }
            },

            queryRadiusKm: 5.0,

            getDefaultAddr: function (cartAddr, skipNearest) {
                // default address is the consumer's pref del. addr unless the cart address is a DP
                // in which case the preferred address must be within the query radius of the DP
                if (!this.consumerData || !this.consumerData.prefDeliveryAddressId) 
                    this.setConsumerDefaultsFromCookie();
                if (!this.consumerData || !this.consumerData.addresses || this.consumerData.addresses.length === 0)
                    return;

                var prefAddr = this.getAddressById(this.consumerData.prefDeliveryAddressId);
                if (prefAddr)
                    prefAddr.prefDelivery = true;
                var prefBillAddr = this.getAddressById(this.consumerData.billingAddressId);
                if (prefBillAddr)
                    prefBillAddr.prefBilling = true;

                if (!cartAddr && this.cartData && this.cartData.addressId)
                    cartAddr = this.getCartAddr();
                if (skipNearest || !cartAddr || !cartAddr.dropPointId || cartAddr.dropPointId === '')
                    return prefAddr;

                var dist = this.kmsBetweenPts(prefAddr.latitude, prefAddr.longitude, cartAddr.latitude, cartAddr.longitude);
                if (dist <= this.queryRadiusKm) 
                    return prefAddr;
                return this.findNearestAddr(cartAddr);
            },

            findNearestAddr: function (cartAddr) {
                var retAddr, minDist = this.queryRadiusKm;
                const qLat = cartAddr.latitude, qLng = cartAddr.longitude;
                var self = this;
                this.consumerData.addresses.forEach(function (addr) {
                    if (addr.addressType === 'Address') {
                        var dist = self.kmsBetweenPts(qLat, qLng, addr.latitude, addr.longitude);
                        if (dist < minDist) {
                            minDist = dist;
                            retAddr = addr;
                        }
                    }
                });
                return retAddr;
            },

            kmsBetweenPts: function (lat1, lon1, lat2, lon2) {
                var p = 0.017453292519943295;    // Math.PI / 180
                var c = Math.cos;
                var a = 0.5 - c((lat2 - lat1) * p) / 2 +
                        c(lat1 * p) * c(lat2 * p) *
                        (1 - c((lon2 - lon1) * p)) / 2;
                return 12742 * Math.asin(Math.sqrt(a)); // 2 * R; R = 6371 km
            },

            getDefaultCartAddrId: function() {
                var id = this._gfsCurrentAddrId || this.cartData.addressId;
                if (!id) {
                    if (!this.consumerData)
                        this.getConsumerDefaultsFromCookie();
                    id = this.consumerData.prefDeliveryAddressId;
                }
                return id;
            },

            getCartAddr: function () {
                var returnAddr = null;
                var addrId = (this.cartData && this.cartData.addressId) ? this.cartData.addressId : null;
                if (addrId)
                    returnAddr = this.getAddressById(addrId);
                if (!returnAddr) {
                    this.cartData.addressId = this.consumerData.prefDeliveryAddressId;
                    returnAddr = this.getAddressById(this.consumerData.prefDeliveryAddressId);
                }
                return returnAddr;
            },

            debug: function (e) {
                console.log("p4m-checkout debug", this.cartData);
            },

            getLocalCart: function (callback) {
                var self = this;
                this.$.localApi.call('getP4MCart', null, null, function (err, data) {
                    if (err) {
                        console.log("getLocalCart() error:", err);
                        callback(err);
                    }
                    else {
                        self.cartData = data.cart;
                        self.updateCartDataFromCookie();
                        callback(err, data.cart);
                    }
                });
            },

            checkCartItemChanges: function () {          
                // if any item qtys have changed then update the shipping service in case there is a new shipping amt
                // this will trigger sendCartItemChanges when the shipping service is updated
                var self = this;
                var changes = this.getItemChanges();
                if (changes.length > 0) {                    
                    self.toggleLoading(true);
                    self._updateGfs(false, function (err, dropPoint) {
                        if (err) {
                            self.onGfsNoService();
                        }
                        else if (dropPoint) {
                            // this means an existing DP was already selected
                            self.sendCartItemChanges();
                        }
                    });
                }
            },

            sendCartItemChanges: function(callback) {
                // TODO: functionality could be included to handle backorder qtys, etc - 
                // for now we'll assume that only discount and tax will be changed by the retailer (not item qtys)
                var changes = this.getItemChanges();
                if (changes.length === 0)
                    return;
                var updCart = { 'shippingDetails': null, 'items': changes };
                var self = this;
                this.$.localApi.call('itemQtyChanged', {}, updCart, function (err, newCartTotals) {
                    if (err) {
                        self.onRetailerNoService();
                        return;
                    }
                    console.log("sendCartItemChanges(): itemQtyChanged: new cart totals", newCartTotals);
                    self._getWidget('cart').clearChanges();
                    self.updCartTotals(newCartTotals, callback);
                });
            },

            getItemChanges: function () {
                var changes = [];
                var cartWidget = this._getWidget('cart');
                for (var sku in cartWidget.changes) {
                    if (cartWidget.changes[sku] === "" || cartWidget.changes[sku] === null) {
                        cartWidget.changes[sku] = 0;
                    }
                    changes.push({ itemCode: sku, qty: cartWidget.changes[sku] });
                }
                return changes;
            },

            updCartTotals: function (newCartTotals, callback) {
                // this gets called when an item qty is changed, or when a discount is changed
                this.cartData.tax = newCartTotals.tax || 0;
                this.cartData.shippingAmt = newCartTotals.shipping || 0;
                this.cartData.total = newCartTotals.total || 0;
                var self = this;
                this.updateP4mCart(function (err) {
                    if (err) {
                        self.onP4mNoService();
                    }
                    else {
                        self.toggleLoading(false);
                        self.set("cartData.discounts", newCartTotals.discounts);
                        if (self.mobile) select(0);
                        if (callback)
                            callback();
                    }
                });
            },

            _showAsLoadingShipping: function(loading) {
                this._getWidget('delivery_spinner').active = loading;
            },
            
            _toggleAddressesLoading: function(loading) {
                this._getWidget('addresses_spinner').active = loading;  
            },

            onPopupBlocked: function() {
                // the consumer needs to login again but the browser blocked the login popup
                this.$.generalFault.loginBlocked = true;
                this.showGeneralFault();
                //if (!this.showingGeneralFault) 
                //    this.$.screenOverlay.show('You must login again to continue', true);
            },
            
            toggleLoading: function (loading, newMessage) {
                var showAsLoading;
                if (loading === 'reset' || this.showingGeneralFault) {
                    this._loadingStack = 0;
                }
                else if (loading) {
                    this._loadingStack++;
                }
                else {
                    this._loadingStack--;
                }
                showAsLoading = (this._loadingStack > 0);

                if (showAsLoading) {
                    var message = newMessage ? newMessage : (!this.firstLoadComplete ? "Getting things ready" : "Updating your cart");
                    this.$.screenOverlay.show(message);
                    this._getWidget('orderSummary').showAsLoading();
                    this._showAsLoadingShipping(this.cartData && this.cartData.total > 0);
                    this._toggleCartEditing(false);
                }
                else {
                    this.$.screenOverlay.close();
                    this._getWidget('orderSummary').showAsLoaded();
                    this._showAsLoadingShipping(false);
                    this._toggleCartEditing(true);
                }

            },

            _toggleCartEditing: function(allowEditing) {
                this._getWidget('cart').toggleEditing(allowEditing);
            },

            firstCartUpdate: true,
            updateP4mCart: function (callback) {
                //Send changes to P4M
                if (!callback) {
                    console.warn('updateP4mCart: no callback');
                    callback = function () { };
                } 
                console.log('updateP4mCart()');
                this.updating = true;
                try {
                   
                    var self = this;
                    var cartMessage =
                    {
                        "sessionId": this.sessionId,
                        "clearItems": this.firstCartUpdate,
                        "cart": this.cartData
                    };
                    this.firstCartUpdate = false;
                    this.toggleLoading(true);
                    this.$.p4mCheckoutApi.call('postCart', null, cartMessage, function (err, data) {
                        self.updating = false;
                        if (err) {  
                            //This is a workaround. Need to either stop the double-post, or fix the 404 response to them.
                            /*console.warn('An error occurred while updating ParcelForMe:', err);
                            console.log('Stack:', new Error().stack);
                            self.onRemoteCartData.bind(self)({Cart:self.cartData}, callback);  //TODO: Fix double-post error causing 404 in P4M back end, so we can stop suppressing errors here*/

                            callback(err);
                        }
                        else {
                            self.onRemoteCartData.bind(self)(data, callback);
                        }
                    });
                }
                catch (e) {
                    this.updating = false;
                }                
            },

            onRemoteCartData: function (data, callback) {
                console.log('onRemoteCartData()');
                this.toggleLoading(false);
                if (!data.success) {
                    console.error(data.error);
                    callback(data.error)
                }
                else {
                    
                    if (!data.cart || !data.cart.items || data.cart.items.length === 0) {

                        window.location.reload(true);
                    }                  
                    else {
                        this.cartData = data.cart;
                        //this.isNew = data.isNew;
                        this.updateCartCookie();
                    }
                    callback(null);
                }                                     
            },

            onCartItemsChange: function (e) {
                console.log('p4m-checkout: onCartItemsChange()');
                //If this is a valid change record,
                var beforeHash = JSON.stringify(e.base);
                var afterHash = JSON.stringify(e.value);
                if (e.path && beforeHash !== afterHash ) {
                    //Start timer, then send changes.
                    //If more changes are detected while the timer is active, reset the timer.
                    console.log("onCartItemsChange: Preparing to send cart changes");
                    if (this._changeTimer) window.clearTimeout(this._changeTimer);
                    this._changeTimer = window.setTimeout(this.checkCartItemChanges.bind(this), 2000);
                }
                else
                {
                    console.log("onCartItemsChange: No cart changes");
                }
            },

            onConsumerAddressChange: function (e) {
                if (!this.initialising)
                    this._runGFS_IfReady();
            },

            _runGFS_IfReady: function (callback) {
                var shouldShow = this._readyForShippingSelector();
                this._ensureShippingVisible(shouldShow);
                if (shouldShow && !this._gfsCurrentAddrId) {
                    this._updateGfs(false, callback);
                }
                else if (callback)
                    callback();
            },

            _ensureShippingVisible: function (show) {
                if (show) {
                    this._getWidget('noShippingWarning').classList.add('hidden');
                    this._getWidget('shippingSelector').classList.remove('hidden');
                }
                else {
                    this._getWidget('noShippingWarning').classList.remove('hidden');
                    this._getWidget('shippingSelector').classList.add('hidden');
                }
            },

            _readyForShippingSelector: function () {
                return (this.cartData && this.getDefaultAddr(null, true)) ? true : false;
            },

            //Take data from shipping selector representing selected shipping options
            //For example output, see gfs-checkout event selectedservicechanged
            //WARNING: Nothing in this function should send messages to the shipping selector or an endless feedback loop will ensue!
            currentService: {},
            updateShippingService: function (data, callback) { //service, shipping, expDeliveryDate, collectPoint) {
                var self = this;
                if (!callback) {
                    throw "updateShippingService(): No callback";
                }
                this.updatingShipping = true;
                if (this.currentService.shipping === data.shipping &&
                    this.currentService.collectionPoint === data.collectionPoint &&
                    this.currentService.service === data.service &&
                    this.currentService.serviceId === data.serviceId &&
                    this.currentService.expDeliveryDate === data.expDeliveryDate &&
                    this.sameAddress(this.currentService.deliveryAddress, data.deliveryAddress)) {
                        // this event could've been triggered by changing item qtys, so we need to check for that 
                        console.warn("updateShippingService(): Nothing has changed")
                        this.updatingShipping = false;
                        var changes = this.getItemChanges();
                        if (changes.length > 0) 
                            this.sendCartItemChanges(callback);
                        else
                            callback(null);                       
                }
                else {
                    self.toggleLoading(true);
                    var addrId = data.deliveryAddress.id || this.cartData.addressId;
                    var addr;
                    if (data.collectionPoint) { // has this DP been saved already?
                        addr = self.consumerData.addresses.find(a => a.dropPointId === data.collectionPoint);
                        if (!addr) {
                            self.saveNewDPAddress(data.provider, data.providerId, data.collectionPoint, data.deliveryAddress, data.companyName, function (err, address) {
                                self.updLocalAfterNewAddr(data, address, callback);
                            });
                            return;
                        }
                    }
                    else
                        addr = this.consumerData.addresses.find(a => a.id === addrId);
                    self.updLocalShipping(data, addr, callback);
                }
            },

            updLocalAfterNewAddr: function(data, addr, callback) {
                var self = this;
                var shippingDetails = { 'service': data.service, 'amount': data.shipping, 'dueDate': data.expDeliveryDate, 'address': addr };
                // got new shipping details so we need to get updated tax from the host
                this.$.localApi.call('updShippingService', null, shippingDetails, function (err, cartTotals) {
                    if (err) {
                        console.error("localApi updShippingService error: ", err);
                        self.toggleLoading(false);
                        callback(err);
                    }
                    else {
                        self._getWidget('cart').clearChanges();
                        self.currentService = data;
                        self.set('cartData.carrier', data.carrier);
                        self.set('cartData.shippingAmt', data.shipping);
                        self.set('cartData.serviceName', data.service);
                        self.set('cartData.serviceId', data.serviceId);
                        self.set('cartData.dropPointId', data.collectionPoint);
                        self.set('cartData.expDeliveryDate', data.expDeliveryDate);
                        self.set('cartData.tax', cartTotals.tax || 0);
                        self.set('cartData.total', cartTotals.total || 0);
                        self.updateP4mCart(function (err) {
                            self.updatingShipping = false;
                            self.toggleLoading(false);
                            callback(err);
                        });
                    }
                });
            },

            updLocalShipping: function (data, addr, callback) {
                var self = this;
                var upd, endpoint;
                var shippingDetails = { 'service': data.service, 'amount': data.shipping, 'dueDate': data.expDeliveryDate, 'address': addr };
                var itemChanges = this.getItemChanges();
                if (itemChanges.length > 0) {
                    // update the item changes as well as the shipping service
                    endpoint = 'itemQtyChanged';
                    upd = { 'shippingDetails': shippingDetails, 'items': itemChanges };
                }
                else {
                    // just updating the shipping service
                    endpoint = 'updShippingService';
                    upd = shippingDetails;
                }
                // got new shipping details so we need to get updated tax from the host
                this.$.localApi.call(endpoint, null, upd, function (err, cartTotals) {
                    if (err) {
                        console.error("localApi updShippingService error: ", err);
                        self.toggleLoading(false);
                        callback(err);
                    }
                    else {
                        self.currentService = data;
                        self.set('cartData.carrier', data.carrier);
                        self.set('cartData.shippingAmt', data.shipping);
                        self.set('cartData.serviceName', data.service);
                        self.set('cartData.serviceId', data.serviceId);
                        self.set('cartData.dropPointId', data.collectionPoint);
                        self.set('cartData.expDeliveryDate', data.expDeliveryDate);
                        self.set('cartData.tax', cartTotals.tax || 0);
                        self.set('cartData.total', cartTotals.total || 0);
                        if (data.collectionPoint) {
                            var existingDropPoint = self.consumerData.addresses.find(a => a.dropPointId === data.collectionPoint);
                            self.selectDeliveryAddress(existingDropPoint.id, false, function (err) {
                                self.updateP4mCart(function (err) {
                                    self.updatingShipping = false;
                                    self.toggleLoading('reset');
                                    callback(err);
                                });
                            });
                        }
                        else if (data.deliveryAddress.id && data.deliveryAddress.id !== self.cartData.addressId) {
                            console.log("update shipping addr: ", addr);
                            self.selectDeliveryAddress(data.deliveryAddress.id, false /*Not updating GFS*/, function (err) {
                                self.updateP4mCart(function (err) {
                                    self.updatingShipping = false;
                                    self.toggleLoading('reset');
                                    callback(err);
                                })
                            });
                        }
                        else {
                            // something has changed on the cart so we need to update it
                            console.log("updating cart because service or address has changed");
                            self.updateP4mCart(function (err) {
                                self.updatingShipping = false;
                                self.toggleLoading('reset');
                                callback(err);
                            })
                        }
                    }
                });
            },

            sameAddress: function (addr1, addr2) {
                return (
                    addr1.addressLineCollection.length === addr2.addressLineCollection.length &&
                    (addr1.addressLineCollection.length == 0 || addr1.addressLineCollection[0] === addr2.addressLineCollection[0]) &&
                    (addr1.addressLineCollection.length <= 1 || addr1.addressLineCollection[1] === addr2.addressLineCollection[1]) &&
                    ((!addr1.countryCode && !addr2.countryCode) || addr1.countryCode.code === addr2.countryCode.code) &&
                    addr1.county === addr2.county &&
                    addr1.postCode === addr2.postCode &&
                    addr1.town === addr2.town
                ) ? true : false;
            },

            saveNewDPAddress: function (providerName, providerId, collectPointId, collectPointAddress, company, callback) {
                var self = this;
                var directions = collectPointAddress.directions ? collectPointAddress.directions.split("]").pop() : "";
                var prefOrder = this.consumerData.addresses.length || 1;
                var address =
                {
                    "id": this.sessionAddressId,
                    "addressType": "Collect",
                    "label": providerName,
                    "companyName": company,
                    "specialInstructions": directions,
                    "street1": collectPointAddress.addressLines[0] || "",
                    "street2": collectPointAddress.addressLines[1] || "",
                    "city": collectPointAddress.town,
                    "postCode": collectPointAddress.postCode,
                    "state": collectPointAddress.county,
                    "country": collectPointAddress.country,
                    "countryCode": collectPointAddress.countryCode,
                    "phone": collectPointAddress.phone,
                    "latitude": collectPointAddress.coordinates.latitude,
                    "longitude": collectPointAddress.coordinates.longitude,
                    "dropPointProviderId": providerName,              
                    "dropPointId": collectPointId,
                    "collectPrefOrder": prefOrder,
                    "unsaved": true
                };
                self.saveAddress(address, function (err, result) {
                    self.notifyPath('consumerData.addresses');
                    callback(err, address);
                });
            },

            onPaymentComplete: function (e) {
                this.$.p4mCartCookie.eraseCookie();
                this.$.p4mCartAddressCookie.eraseCookie();
                if (e && e.detail.redirectUrl) {
                    window.location = e.detail.redirectUrl;
                }
            },
            

            onSelectPaymentMethod: function (e) {
                var updCart = this.selectedCard !== undefined && this.selectedCard !== null;
                this.set('cartData.payMethodId', e.detail.id);
                this.selectedCard = e.detail;
                if (updCart) {
                    var self = this;
                    this.updateP4mCart(function () {
                        if (self.mobile) select(0);
                    });
                }
            },

            //onCardHashData: function (data) {
            //    this.set('cardTimestamp', data.Timestamp);
            //    this.set('cardMerchantId', data.MerchantId);
            //    this.set('cardHash', data.Hash);               
            //},

            onDiscount: function (e) {
                var cartDiscount = this.cartData.discounts.find(function (element, index, arr) { return element.code === e.detail.code; }); //TODO: Change to bound function; arrow functions may not work in older browsers
                if (cartDiscount) {
                    if (cartDiscount.description !== e.detail.description ||
                        cartDiscount.amount !== e.detail.amount ||
                        cartDiscount.code !== e.detail.code)
                    {
                        cartDiscount.description = e.detail.description;
                        cartDiscount.amount = e.detail.amount || 0;
                        cartDiscount.code = e.detail.code;
                        this.updCartTotals(e.detail);
                    }
                }
                else {
                    this.push('cartData.discounts', e.detail);
                    this.updCartTotals(e.detail);
                }
            },

            onDiscountDelete: function (e) {
                var code = e.detail;              
                var item = this.cartData.discounts.find(function(element, index, arr) { return (element.code === code) });
                if (item) {
                    item.amount = 0;
                    item.description = "Deleted";
                    var self = this;
                    this.$.localApi.call('removeDiscountCode', null, { "discountCode": code }, function (err, response) {
                        if (response && response.success)
                            self.updCartTotals(response);   // this will upate the cart as well
                    });
                }
            },

            onGotNewCard: function(){
                 this._getConsumer();
            },

            onSelectAddressFromList: function (e) {
                var self = this;
                if (e.detail) {

                    //If changed billing address, tell P4M
                    if (e.detail.isBilling && self.cartData.billingAddressId != e.detail.id) {
                        self.set('cartData.billingAddressId', e.detail.id);
                        self.updateP4mCart(function () {
                            if (self.mobile) select(0);
                        });
                    }
                    //If changed delivery address, tell GFS and P4M
                    else if (e.detail.isDelivery && self.cartData.addressId != e.detail.id) {
                        self.selectDeliveryAddress(e.detail.id, true, function () {
                            if (self.mobile) select(0);
                        });
                    }
                }
            },

            selectDeliveryAddress: function (addressId, sendToGfs, callback) {
                var self = this;
                var address = this.getAddressById(addressId);
                if (!callback) callback = function(){};

                if (!address) {
                    callback("No such address");
                    //return false;
                }
                else {
                    self.set('cartData.addressId', addressId); //This allows the address UI to update
                    self.notifyPath('cartData.addressId');
                    //Send to GFS Checkout and await shipping event
                    //If this is a user-initiated address change, we need to tell GFS and get new shipping details back (via onGfsServiceChanged)
                    if (sendToGfs) {
                        // the address is changing so we need to set the default service method and del. date
                        self.cartData.serviceId = null;
                        self.cartData.expDeliveryDate = null;
                        self._gfsCurrentAddrId = addressId;
                        this._updateGfs(true, function (err) {
                            if (!err)
                                self._getWidget('gfsCheckoutWidget').selectFavAddress(address);
                            callback(err, address);
                        });
                    }
                    else {
                        callback(null, address);
                    }
                }
            },

            onAddAddress: function (e) {
                this.onUpdateAddress(e);
            },

            saveAddress: function (address, finalCallback) {
                if (!address.addressType) {
                    address.addressType = 'Address';
                }
                var self = this;
                var result = null

                var hasAnAddress = this.consumerData.addresses.length && this.consumerData.addresses.some(function (address) { return address.id && address.id != ""; });
                var existingAddress = hasAnAddress && address.id && address.id != "" && this.getAddressById(address.id);
                var postData =
                {
                    "Address": address,
                    "isPrefDeliveryAddr": !hasAnAddress,
                    "isBillingAddr": !hasAnAddress
                };

                async.series(
                    [
                        function _postAddress(callback) {
                            self.toggleLoading(true);
                            // send the new address details to P4M
                            self.$.p4mCheckoutApi.call("postAddress", null, postData, function (err, data) {
                                result = data;
                                address = result.address;
                                // if this is the first address it will be set as the billing and delivery addresses
                                if (result.isBillingAddr && (!self.consumerData.billingAddressId || self.consumerData.billingAddressId !== address.id)) {
                                    self.set('consumerData.billingAddressId', address.id);
                                    self.set('cartData.billingAddressId', address.id);
                                }
                                if (result.isPrefDeliveryAddr && (!self.consumerData.prefDeliveryAddressId || self.consumerData.prefDeliveryAddressId !== address.id)) {
                                    self.set('consumerData.prefDeliveryAddressId', address.id);
                                }
                                if (!existingAddress) {
                                    self.push('consumerData.addresses', address);
                                }
                                else
                                    self.addOrUpdAddress(address);
                                if (address.addressType === 'Address')
                                    self._getWidget('gfsCheckoutWidget').setFavAddresses(self._getPreferredAddresses(address));
                                else
                                    self._getWidget('gfsCheckoutWidget').setFavDropPoints(self._getPreferredDropPoints());
                                callback(err, result);
                            });
                        },
                        function _selectAddress(callback) {
                            // check if the selected address has changed
                            if (!self.cartData.addressId || self.cartData.addressId != address.id) {
                                var sendToGfs = result.address.addressType === 'Address';
                                self.selectDeliveryAddress(result.address.id, sendToGfs, function (err, data) {
                                    self.updateAddressCookies(result.address);
                                    callback(err);
                                });
                            }
                            else {
                                self.updateAddressCookies(result.address);
                                callback(null);
                            }
                        }
                    ],
                    function (err) {
                        self.toggleLoading(false);
                        finalCallback(err, result);
                    }
                )
            },

            onUpdateAddress: function (addressElement) {
                // here we're adding or updating an address only, not setting a default value on the consumer at this stage

                this._toggleAddressesLoading(true);

                var self = this;
                this.saveAddress(addressElement.detail.addressData, function (err, result) {
                    self._toggleAddressesLoading(false);
                    if (err) {
                        throw err;
                    }
                    else {
                        addressElement.detail.addressData.id = result.address.id;
                        self._ensureShippingVisible(true);
                    }
                });

            },

            /*
            preselectDeliveryMethod: function () {
                //Select delivery details based on selected address and user's preferences
                if (!this.consumerData) throw "No consumer data"
                else if (!this.cartData) throw "No cart data";

               
                //this.consumerData.PreferSoonestDelivery = true; //TODO: Remove. This is just here for testing.
                //Rather than opening a page, let's handle this directly.

                if (this.consumerData.PreferSoonestDelivery) {
                    if (this.$.gfsCheckoutWidget) {
                        //this.$.gfsCheckoutWidget.showPage_Calendar(true);
                        this.$.gfsCheckoutWidget._preselectForCalendar();
                    }
                }
                else {
                    if (this.$.gfsCheckoutWidget) {
                        this.$.gfsCheckoutWidget._preselectForStandard();
                        //this.$.gfsCheckoutWidget.showPage_Standard(true);
                    }

                }
               

            },
*/
  
            /*
            selectPreferredAddress: function (callback) {
                //If there is a preferred delivery address, select that.
                //PRECONDITION: Consumer data and Cart data exists
                console.log('selectPreferredAddress');
                if (this.consumerData.prefDeliveryAddressId) {
                    this.selectDeliveryAddress(this.consumerData.prefDeliveryAddressId, false, callback);
                }
                else {
                    callback("No preferred address");
                }
            },*/

            _getPreferredDropPoints: function() {
                return this.consumerData.addresses         
                    .filter(function (item) { return (item.addressType == "Collect" && item.latitude && item.dropPointId) })
                    .sort(this.sortByPreference)
                    .map(p4mDroppointToGfsDroppoint);
            },

            sortByPreference: function (a, b) {
                if (a.collectPrefOrder < b.collectPrefOrder)
                    return -1
                else if (b.collectPrefOrder < a.collectPrefOrder)
                    return 1
                else 
                    return 0;
            },

            _getPreferredAddresses: function (topAddr) {
                var preferredAddress = topAddr || this.getDefaultAddr();
                var prefId = preferredAddress ? preferredAddress.id : null;
                return this.consumerData.addresses
                    .filter(function (item, i) { return (item.addressType == "Address") }) //Only addresses, not droppoints
                    .sort(function (a, b) { if (a.id == prefId) { return -1; } else { return 1 } })
                    .filter(function (item, i) { return (i < 99) }) //Up to 99 addresses                   
                    .map(p4mAddressToGfsAddress);
            },

            onGfsServiceChanged: function (e) {
                //if (this.initialising) {
                //    console.warn('onGfsServiceChanged(): not updating while initialising');
                //}
                console.log("p4m widget: onGfsServiceChanged():", e);
                this.triggerChangeIndicator();
                var self = this;
                this.updateShippingService(e.detail, function () {
                    self.notifyPath('consumerData.addresses');
                    console.log("onGfsServiceChanged: updateShippingService complete");
                });
            },

            triggerChangeIndicator: function() {

                this.set("_changeIndicatorClass", "not_changed");
                window.setTimeout(function(){this.set("_changeIndicatorClass", "change")}.bind(this), 10);
                

            },

            //onGfsServicePreselect: function (e) {
            //    this.updateShippingService(e.detail, function () { console.log("onGfsServicePreselect: updateShippingService complete") });
            //},

            onGfsNoService: function (e) {
                // this.preselectDeliveryMethod();
                console.error('No GFS service');
                this.showGeneralFault("our shipping service");
            },

            onNoDeliveryOpts: function (e) {
                // no delivery options are available for the selected address so revert to last
                console.warn('No delivery options for this address');
                var self = this;
                this.updateCartDataFromCookie();
                this.notifyPath('cartData.addressId');
                this.toggleLoading(true, 'No delivery options for this address');
                this._updateGfs(false, function () { self.toggleLoading('reset'); }, true);
            },

            onP4mNoService: function (e) {
                console.error('No P4M service');
                this.showGeneralFault("Parcel for Me");
            },

            onRetailerNoService: function (e) {
                console.error('No retailer service');
                this.showGeneralFault("our server");
            },

            onGfsSessionExpiry: function (e) {
                console.log("GFS Checkout session expired");
                var self = this;
                this.$.localApi.call('renewShippingToken', null, null, function (err, data) {
                    if (err) {
                        self.showGeneralFault("our shipping service");
                    }
                    else {
                        document.cookie = "gfsCheckoutToken=" + data.token + "; path=/;";
                        self.gfsCheckoutToken = data.token;
                    }
                    self._gfsCurrentAddrId = null;
                    self.toggleLoading('reset');
                    self._updateGfs(false, function () { self._getWidget('gfsCheckoutWidget').refreshShippingTab(); });
                });
            },

            addressExists: function(addrId) {
                if (this.consumerData && this.consumerData.addresses && this.consumerData.addresses.length > 0) 
                    return this.consumerData.addresses.find(function (item) { return item.id === addrId });
                return false;
            },

            getAddressById: function (id) {
                if (id && this.consumerData && this.consumerData.addresses && this.consumerData.addresses.length > 0) {
                    var foundItem = this.consumerData.addresses.find(function (item) { return item.id == id });
                    if (foundItem)
                        return foundItem;
                }
                return null;
            },

            addOrUpdAddress: function (address) {
                //return;
                if (!this.consumerData) {
                    return;
                }
                var foundAt = this.consumerData.addresses.findIndex(function (addr) { return addr.id === address.id; });
                if (foundAt < 0) 
                    this.consumerData.addresses.push(address);
                else
                    for (var prop in address) {
                        if (address.hasOwnProperty(prop)) {
                            this.consumerData.addresses[foundAt][prop] = address[prop];
                        }
                    }
            },

            goToPaymentMethods: function () {
                this.selectedTab = this.Tabs.PAYMENT;
                this._getWidget('cardList').addNewCard();
            },

            goToAddresses: function () {
                this.selectedTab = this.Tabs.ADDRESS;
                this._getWidget('addressList').toggleAddressMode();
            },

            _onSelectTab: function (tab) {
                //Tab changed
                //console.log(tab);
                var page = tab.detail.item;
                if (page.id === 'deliveryPage') {
                    // refresh google map because it's been hidden
                    this._getWidget('gfsCheckoutWidget').checkMapIsReset();
                }
//                console.log('page selected', page);
            },

            showingGeneralFault: false,
            showGeneralFault: function(service) {
                //return; //Debug
                this.showingGeneralFault = true;
                this.toggleLoading('reset');
                this.fire('generalFault');
                this.$.generalFault.show(service);
            },

            hideGeneralFault: function () {
                this.showingGeneralFault = false;
                this.$.generalFault.close();
            },

            clickBuyNow: function () {
                // user pressed enter key in the CVV field
                var btn = document.getElementById('p4mPurchaseBtn');
                btn.onClick();
            }
        });
        
        function fldStr (field, last) {
            return (field ? field : "") + (!last ? "|" : "");
        }

        function fldOrNull (fld) {
            return fld === '' ? null : fld;
        }

        function p4mDroppointToGfsDroppoint(item) {
           var gfsAddress = {
                droppointId: item.dropPointId,
                droppointDescription: item.companyName,
                geoLocation: {
                                    
                    postCode: item.postCode,
                    addressLineCollection: [item.companyName, item.street1],
                    addressLines: [item.companyName, item.street1],
                    town: item.city,
                    coordinates: {
                        latitude: item.latitude,
                        longitude: item.longitude
                    },
                    countryCode: item.countryCode,
                    county: "",
                    directions: item.specicalInstructions
                },
                providerId: item.dropPointProviderId,
                providerLogo: "https://s-media-cache-ak0.pinimg.com/avatars/pelithepenguin_1453991623_140.jpg",
                providerName: item.label,
                prefOrder: item.collectPrefOrder
            };
            return gfsAddress;

        }

        function p4mAddressToGfsAddress(item) {
            if (!item) return false
            else {

                var gfsAddress = {
                    id: item.id,
                    countryCode: {
                        code: item.countryCode || "GB",
                        encoding: "ccISO_3166_1_Alpha2"
                    },
                    postCode: item.postCode || "",
                    town: item.city,
                    county: item.state,
                    addressLineCollection: [item.street1, item.street2],
                    addressLines: [item.street1, item.street2],
                    name: item.label
                };
                if (item.latitude && item.longitude) {
                    gfsAddress.lat = item.latitude,
                    gfsAddress.lng = item.longitude
                }
                return gfsAddress;
            }
        }

        function hashThis(value) {
            //return Math.random().toString();
            return value.split("").reverse().join("")
        }
        
        function select(tab) {
            document.getElementsByTagName('p4m-checkout')[0].selected = tab;
        }


    </script>
</dom-module>

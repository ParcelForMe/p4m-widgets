
<link rel="import" href="../../polymer/polymer.html" />

<link rel="import" href="../../polymer-cookie/polymer-cookie.html" />
<link rel="import" href="../../paper-tabs/paper-tabs.html" />
<link rel="import" href="../../iron-pages/iron-pages.html" />

<link rel="import" href="../p4m-profile/p4m-profile.html" />
<link rel="import" href="../p4m-api/p4m-api.html" />
<link rel="import" href="../p4m-cart/p4m-cart.html" /> 
<link rel="import" href="../p4m-order-summary/p4m-order-summary.html" />
<link rel="import" href="../p4m-address-list/p4m-address-list.html" />
<link rel="import" href="../p4m-purchase/p4m-purchase.html" />
<link rel="import" href="../p4m-card-list/p4m-card-list.html" />
<link rel="import" href="../p4m-delivery/p4m-delivery.html" />
<link rel="import" href="../p4m-order-text/p4m-order-text.html" />

<link rel="import" href="../p4m-discount-input/p4m-discount-input.html" />
<link rel="import" href="../p4m-discount-list/p4m-discount-list.html" />

<link rel="import" href="../gfs-checkout-widget/gfs-checkout-widget.html" />
<link rel="import" href="../address-lookup-field/address-lookup-field.html" />  

<link rel="import" href="../p4m-imports/p4m-imports.html" />  
 
<link rel="stylesheet" href="../p4m-shared/p4m.css" />

<dom-module id="p4m-checkout">

    <template>
        <p4m-api id="p4mCheckoutApi" ssl="true" host-base-domain="parcelfor.me" host-type="{{hostType}}" version="v2"></p4m-api>
        <p4m-api id="localApi" is-local="true"></p4m-api>
        <div id="container">

            <div id="topPanel" class="topPanel"><h2>Review My Order</h2><p4m-profile mode="basic"></p4m-profile></div>
            <div id="panelContainer">
                <div id="detailPanel" class="p4m-panel">
                   
                    
                    <paper-tabs selected="{{selectedTab}}">
                        <paper-tab>My Order</paper-tab>
                        <paper-tab>Delivery Options</paper-tab>
                        <paper-tab>Payment Options</paper-tab>
                        <paper-tab>Addresses</paper-tab>
                    </paper-tabs>
                    <iron-pages id="p4mPages" selected="{{selectedTab}}" on-iron-select="_onSelectTab">                   
                        <iron-page id="cartPage">                       
                            <p4m-cart id="cart" cart-data="{{cartData}}"></p4m-cart>                         
                        </iron-page>
                        <iron-page id="deliveryPage">
                            <gfs-checkout id="gfsCheckoutWidget" gfs-data="{{gfsData}}" preselect="false" auto-load="false" access-token="{{gfsAccessToken}}" on-show-droppoints="onGfsShowDroppoints" on-show-standard="onGfsShowStandard" on-selectedservicechanged="onGfsServiceChanged" on-noservice="onGfsNoService" delivery-preferences="{{deliveryPreferences}}" consumer-addresses="{{consumerData.addresses}}" override-shipping-method-id="{{cartData.ServiceId}}" override-delivery-date="{{cartData.ExpDeliveryDate}}" default-post-code="{{initialPostCode}}" default-country-code="{{initialCountryCode}}"></gfs-checkout>
                            <template is="dom-if" if="{{_notUseGfsCheckout}}">
                                <p4m-delivery></p4m-delivery>
                            </template>
                            <template is="dom-if" if="{{useGfsCheckout}}">
                            </template>
                        </iron-page>
                        <iron-page id="cardPage">
                            <p4m-card-list id="cardList" consumer-data="{{consumerData}}" cart-data="{{cartData}}" on-selected="onSelectPaymentMethod" on-gotnewcard="onGotNewCard"></p4m-card-list>
                        </iron-page>
                        <iron-page id="addressPage">
                            <p4m-address-list id="addressList" address-list-data="{{consumerData.Addresses}}" cart-data="{{cartData}}" on-select="onSelectAddress" on-add="onAddAddress" on-update="onUpdateAddress"></p4m-address-list>
                        </iron-page>
                    </iron-pages>                 
                </div>
                <div id="summaryPanel" class="p4m-panel smallSummary">
                    <p4m-order-text cart-data="{{cartData}}" consumer-data="{{consumerData}}" on-request-address="goToAddresses"></p4m-order-text>
                    <p4m-purchase id="p4mPurchase" cart-data="{{cartData}}" new-drop-point="{{_queuedNewAddress}}" on-payment-complete="onPaymentComplete" on-request-payment-method="goToPaymentMethods" use-paypal="{{usePaypal}}" selected-card="{{selectedCard}}" use-paypal="true"></p4m-purchase>
                    <p4m-order-summary id="orderSummary" cart-data="{{cartData}}"></p4m-order-summary>  
                    <p4m-discount-input on-discount="onDiscount"></p4m-discount-input>    
                 </div>
            </div>           
        </div>

        <polymer-cookie id="sessionCookie" name="CartId"></polymer-cookie>
        <polymer-cookie id="p4mDefaultPostCode" name="p4mDefaultPostCode"></polymer-cookie>
        <polymer-cookie id="p4mDefaultCountry" name="p4mDefaultCountry"></polymer-cookie>


    </template>

    <style>
        #container {
            width: 100%;
            margin: auto;
            padding-bottom: 8px;
        }
        #panelContainer {
            display: flex;
            border-radius: 5px;
            background-color: white;

        }
        .topPanel {
            width: 100%;
            background-color: #E0E0E0;
            border: none;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            padding: 10px;
        }
        .topPanel h4, .topPanel h2 {
            margin: 0px;
            letter-spacing: 3px;
            text-transform: uppercase;
            display: inline-block;
        }

        .topPanel p4m-profile {
            float: right;
            margin-top: -8px;
        }   
        .panelContainer {
            border-bottom-right-radius: 8px;
            border-bottom-left-radius: 8px;
            display: flex;
            flex-direction: row;
        }

        .p4m-panel {
            width: 50%; 
            min-height: 200px;
            border: none;
        }

        .p4m-panel#summaryPanel {
           
        }

        #detailPanel.p4m-panel {
            width: 67%;
            padding-right: 8px;
        }
        #summaryPanel.p4m-panel {
            width: 33%;
             border-left: solid 1px #E0E0E0;
        }

        :root {
            --paper-tabs-selection-bar-color: red;
        }
        #panelContainer > div {
            transition: all 0.25s ease-in-out;
        }

        .price {
            color: darkgreen;
        }    
        
   

    </style>

    <script>

        Polymer({
            is: "p4m-checkout",

            properties: {
                sessionId: {
                    type: String
                },
                consumerData: {
                    type: Object,
                    notify: true
                    //observer: "onConsumerDataChange"
                },              
                cartData: {
                    type: Object,
                    notify: true,
                },
                isNew: {
                    type: Object,
                    value: false
                },
                deliveryData: {
                    type: Object,
                    notify: true
                },
                selectedTab: {
                    type: Number,
                    value: 0
                },
                currency: {
                    type: String,
                    value: "GBP"
                },
                selectedCard: {
                    type: Object
                },
                hostType:{
                    type: String,
                    value: "dev" //default value
                },
                useGfsCheckout: {
                    type: Object,
                    value: false
                },
                usePaypal: {
                    type: Object,
                    value: false,
                    notify: true
                },
                gfsAccessToken: {
                    type: String
                },
                gfsData: {
                    type: String
                },
                initialPostCode: {
                    type: String,
                    value: "W1A 0AX"
                },
                initialCountryCode: {
                    type: String,
                    value: "GB"
                },
                _notUseGfsCheckout: {
                    type: Object,
                    value: true
                },
                _changeTimer: {
                    //Timer object to allow sending of changes once user has finished interaction
                    type: Object
                }
                
            },
            observers: [
                //"onCartDiscountChange(cartData.Discounts.*)"
               "onCartItemsChange(cartData.Items.*)"
            ],

            ready: function()
            {
                console.log("P4M Checkout ready", new Date().getTime());
                //console.log('Async:',async);
                var self = this;
                this.Tabs = { "ORDER": 0, "DELIVERY": 1, "PAYMENT": 2, "ADDRESS": 3 };
                this._notUseGfsCheckout = !this.useGfsCheckout;

                if (!this.sessionId) {
                    this.sessionId = this.$.sessionCookie.readCookie();
                }

                this.init();




                /*
                if (this.sessionId) {
                    this.getLocalCart();
                }

                this.$.p4mCheckoutApi.call('consumer', null, null, function (data) {
                    self.onConsumerData(data);
                    self.preselectAddress();
                    self.preselectDeliveryMethod();
                });*/
            },

            init: function (finalCallback) {
                var self = this;
                self.initialising = true;
                async.parallel(
                    [
                        function _getConsumer(callback) { //TODO: Move this to a parallel thread?
                            self.$.p4mCheckoutApi.call('consumer', null, null, function (err, data) {
                                if (!data.Success) {
                                    callback(data.Error);
                                }
                                else {
                                    self.consumerData = data.Consumer;
                                    callback(err);
                                }
                            });
                        },

                        //Get local cart
                        function _localCart(callback) {
                            if (self.sessionId) {
                                self.getLocalCart(function (err) {
                                    if (err) {
                                        callback(err)
                                    }
                                    else {
                                        self.updateP4mCart(callback);
                                    }
                                });
                            }
                            else {
                                callback("No cart");
                                self.getP4mCart(callback);
                            }
                        },
                    ],
                    function (err) {

                        if (err) {
                            throw err;
                        }

                        async.series(
                        [
                            //Send info from cart and consumer to GFS
                            function _gfs(callback) {
                                if (self.$.gfsCheckoutWidget) {
                                    self._updateGfs(callback);
                                }
                                else {
                                    callback(null);
                                }
                            },

                            function _newCart(callback) {
                                //If this is a new cart, preselect as much as possible.
                                //Otherwise, the user has already selected their options.

                                //self.isNew = true;
                                if (self.isNew) {
                                    console.log('*** New cart - preselect everything');
                                    self.preselectAddress(callback);
                                    self.preselectDeliveryMethod();                                                                     
                                }
                                else {
                                    callback(null);
                                }
                            },

                            function _p4mCart(callback) {
                                self.updateP4mCart(callback); //This will set IsNew to false
                            }
                        ],
                        function (err) {
                            self.initialising = false;               
                        })
                    }
                )
            },

            //Send all cart information to GFS
            _updateGfs: function (callback) {
                var self = this;
                var orderValue = 0.0;
                self.cartData.Items.forEach(function (item) {
                    orderValue += item.Qty * item.Price;
                });
                self.$.gfsCheckoutWidget.setGfsOrderValue(orderValue);
               
                //Set preferred droppoints
                var p4mDropPoints = self._getPreferredDropPoints();
                self.$.gfsCheckoutWidget.setPreferredDroppoints(p4mDropPoints);

                //Tell Gfs Checkout widget about our preferred addresses
                var p4mConsumerAddresses = self._getPreferredAddresses(3);
                self.$.gfsCheckoutWidget.setConsumerAddresses(p4mConsumerAddresses);

                //Set service ID and name
                var deliveryAddress = self.getAddressById(self.cartData.AddressId);
                if (self.sessionId && self.cartData.ServiceId && deliveryAddress.AddressType === "Address") {                   
                    self.$.gfsCheckoutWidget.setGfsAddress(p4mAddressToGfsAddress(deliveryAddress, self.initialCountryCode));
                }

                self.$.gfsCheckoutWidget.postGfsData(function (err, data) {

                    //TODO: Set delivery location                 
                    if (deliveryAddress.AddressType === "Collect") {
                        self.$.gfsCheckoutWidget.chooseDropPointId(address.DropPointId || address.droppointId);
                    }

                    if (self.sessionId && self.cartData.ServiceId ) {
                        self.$.gfsCheckoutWidget.updateDeliveryOptions(self.cartData.ServiceId);
                    }                  

                    callback(err);
                });
            },

            debug: function(e) {
                console.log("p4m-checkout debug", this.cartData);
            },

            getLocalCart: function (callback) {
                var self = this;
                this.$.localApi.call('getP4MCart', null, null, function (err, data) {
                    if (err) {
                        callback(err);
                    }
                    else {
                        self.cartData = data.Cart;
                        callback(err, data.Cart);
                    }
                });
            },

            getP4mCart: function (callback) {
                this.$.p4mCheckoutApi.call('currentCart', { sessionId: this.sessionId }, null, this.onRemoteCartData.bind(this, callback));
            },

            sendCartItemChanges: function () {          
                //Send changes to local API, then to P4m
                var self = this;
                var changes = [];

                for (var sku in this.$.cart.changes) {
                    changes.push({ItemCode: sku, Qty: this.$.cart.changes[sku]});
                }
                if (changes.length > 0) {
                    
                    var orderValue = 0.0;
                    for (var item in this.$.cart.Items) {
                        orderValue += item.Qty * item.Price; 
                    }

                    //this.$.gfsCheckoutWidget.setGfsOrderValue(orderValue, function () {

                        self.$.localApi.call('itemQtyChanged', {}, changes, function (err, newCartTotals) {
                            //console.log("Called local api itemQtyChanged");
                            console.log("sendCartItemChanges(): itemQtyChanged: new cart totals", newCartTotals);
                            self.$.cart.clearChanges();
                            self.updCartTotals(newCartTotals, function (err) {
                                self.cartData.Discounts = newCartTotals.Discounts;
                                self.updateP4mCart();
                            });

                        });
                    //})

                }
                else {
                    //console.log("No changes to send");
                }
            },

            //Send new total to shipping module and ask for new shipping price etc
            updCartTotals: function (newCartTotals, callback) {
                this.cartData.Tax = newCartTotals.Tax;
                this.cartData.ShippingAmt = newCartTotals.Shipping;
                this.cartData.Total = newCartTotals.Total;

                if (this.$.gfsCheckoutWidget) {
                    var cartValue = Number(this.cartData.Total - (this.cartData.ShippingAmt || 0) - (this.cartData.Tax || 0));
                    //console.log(cartValue, this.$.gfsCheckoutWidget._postData.Request.Order.Value.Value);
                    if (cartValue != this.$.gfsCheckoutWidget._postData.Request.Order.Value.Value) {
                        console.log("Updating GFS Checkout");
                    }
                    callback(null);                   
                }
                else {
                    callback(null);
                }
            },

            /*
            onConsumerData: function(data) {
                this.consumerData = data.Consumer;
                this.lastSelectedAddrId = data.Consumer.PrefDeliveryAddressId;
                if (this.$.gfsCheckoutWidget) {
                    var p4mDropPoints = this._getPreferredDropPoints();
                    this.$.gfsCheckoutWidget.setPreferredDroppoints(p4mDropPoints);

                    //If we have selected a droppoint, let GFS Checkout know.
                    var address = this.getAddressById(this.cartData.AddressId);
                    if (address && address.AddressType === "Collect") {
                        this.$.gfsCheckoutWidget.chooseDropPointId(address.DropPointId || address.droppointId);
                    }

                    var p4mConsumerAddresses = this._getPreferredAddresses(3);                        
                    this.$.gfsCheckoutWidget.setConsumerAddresses(p4mConsumerAddresses);
                }             
            },*/


            toggleLoading: function (loading) {
                if (loading) {
                    this.$.orderSummary.showAsLoading();
                    this.$.p4mPurchase.setLoadingState(true);
                }
                else {
                    this.$.orderSummary.showAsLoaded();
                    this.$.p4mPurchase.setLoadingState(false);
                }

            },

            updateP4mCart: function (callback) {
                console.log('updateP4mCart()');
                //Send changes to P4M
                var self = this;
                var cartMessage =
                {
                    "SessionId": this.sessionId,
                    "ClearItems": true, // are we always replacing the whole cart? or ClearItems = this.cartData.Id === null; ??
                    "Cart": this.cartData,
                    "DeliverToNewDropPoint": (this._queuedNewAddress) ? true : false
                }
                if (!callback) callback = function () { };
                this.toggleLoading(true);                 
                this.$.p4mCheckoutApi.call('postCart', null, cartMessage, function (err, data) {
                    if (err) {
                        callback(err);
                    }
                    else {
                        self.onRemoteCartData.bind(self)(data, callback);
                    }
                });

                
            },
            //lastSelectedAddrId: '', // record the last selected address for switching between drop points and delivery addrs

            onRemoteCartData: function (data, callback) {
                console.log('onRemoteCartData()');
                this.toggleLoading(false);
                if (!data.Success) {
                    console.error(data.Error);
                    callback(data.Error)
                }
                else {
                    
                    if (!data.Cart || !data.Cart.Items || data.Cart.Items.length === 0) {
                        window.location.reload(true);
                    }                  
                    else {
                        this.cartData = data.Cart;
                        this.isNew = data.IsNew;
                        /*var address = this.getAddressById(this.cartData.AddressId);
                        if (address && address.AddressType == "Address") {
                            this.lastSelectedAddrId = data.Cart.AddressId;
                        } */                                                     
                    }
                    callback(null);
                }                                     
            },

            /*
            onCartData: function (data, callback) {
                this.toggleLoading(false);
              
                if (data.Success) {
                    this.cartData = data.Cart;
                    callback(null, this.cartData);
                }
                else {
                    console.error(data.Error);
                    callback(data.Error);
                }
                
                //this.$.p4mPurchase.updateUi();
            },*/

            onCartItemsChange: function (e) {
                console.log('p4m-checkout: onCartItemsChange()');//, JSON.stringify(e));
                //If this is a valid change record,
                var beforeHash = JSON.stringify(e.base);
                var afterHash = JSON.stringify(e.value);
                if (e.path && beforeHash !== afterHash ) {
                    //Start timer, then send changes.
                    //If more changes are detected while the timer is active, reset the timer.
                    console.log("onCartItemsChange: Preparing to send cart changes");
                    if (this._changeTimer) window.clearTimeout(this._changeTimer);
                    this._changeTimer = window.setTimeout(this.sendCartItemChanges.bind(this), 2000);
                }
                else
                {
                    console.log("onCartItemsChange: No cart changes");
                }
            },

            //Take data from shipping selector representing selected shipping options
            //For example output, see gfs-checkout event selectedservicechanged
            currentService: {},
            updateShippingService: function (data, callback) { //service, shipping, expDeliveryDate, collectPoint) {
                if (!callback) {
                    throw "updateShippingService(): No callback";
                }
                if (this.currentService.shipping === data.shipping &&
                    this.currentService.collectionPoint === data.collectionPoint &&
                    this.currentService.service === data.service &&
                    this.currentService.serviceId === data.serviceId &&
                    this.currentService.expDeliveryDate === data.expDeliveryDate) {
                    console.log("Skipping upd service", this.currentService);
                    return;
                }
                else
                    console.log("Upd service: ", this.currentService, data);


                var self = this;

                var shippingDetails = { 'Service': data.service, 'Amount': data.shipping, 'DueDate': data.expDeliveryDate };
                // got new shipping details so we need to get updated tax from the host
                this.$.localApi.call('updShippingService', null, shippingDetails, function (err, cartTotals) {
                    if (err) {
                        callback(err);
                    }
                    else {
                        this.currentService = data;
                        /*this.currentService.shipping = data.shipping;
                        this.currentService.collectionPoint = data.collectionPoint;
                        this.currentService.service = data.service;
                        this.currentService.serviceId = data.serviceId;
                        this.currentService.expDeliveryDate = data.expDeliveryDate;
                        */
                        /*this.cartData.ShippingAmt = data.shipping;
                        this.cartData.ServiceName = data.service;
                        this.cartData.ServiceId = data.serviceId;
                        this.cartData.ExpDeliveryDate = data.expDeliveryDate;
                        */
                        self.set('cartData.Carrier', data.carrier);
                        self.set('cartData.ShippingAmt', data.shipping);
                        self.set('cartData.ServiceName', data.service);
                        self.set('cartData.ServiceId', data.serviceId);
                        self.set('cartData.DropPointId', data.collectionPoint);
                        self.set('cartData.ExpDeliveryDate', data.expDeliveryDate);
                        self.set('cartData.Tax', cartTotals.Tax);
                        self.set('cartData.Total', cartTotals.Total);

                        if (data.collectionPoint) {
                            self.selectCollectPoint(data.provider, data.providerId, data.collectionPoint, data.deliveryAddress);
                        }
                        else {
                            //If no non-collection address specified, pick the preferred one
                            var address = self.getAddressById(self.cartData.AddressId);
                            if (!address || address !== 'Address') {
                                //if (self.lastSelectedAddrId)
                                //    address = self.getAddressById(self.lastSelectedAddrId);
                                if (!address && self.consumerData.PrefDeliveryAddressId)
                                    address = self.getAddressById(self.consumerData.PrefDeliveryAddressId);
                                if (address)
                                    self.set('cartData.AddressId', address.Id);
                            }

                           
                        }
                        self.updateP4mCart();
                    }

                });
            },


            selectCollectPoint: function (providerName, providerId, collectPointId, collectPointAddress, callback) {
                if (!callback) callback = function () { };
                var self = this;
                var result;
                if (!collectPointId) {
                    console.error("No collectPointId");
                    if (callback)
                        callback();
                    return;
                }
               
                var existingDropPoint = this.$.addressList.getDropPointById(collectPointId);
                if (!existingDropPoint || existingDropPoint.Unsaved) {
                                 
                    var directions = collectPointAddress.directions ? collectPointAddress.directions.split("]").pop() : "";
                    var prefOrder = this.consumerData.Addresses.length || 1;
                    var postData =
                    {
                        "Address": {
                            "Id": collectPointId,
                            "AddressType": "Collect",
                            "Label": providerName,
                            "CompanyName": directions,
                            "Street1": collectPointAddress.addressLines[0] || "",
                            "Street2": collectPointAddress.addressLines[1] || "",
                            "City": collectPointAddress.town,
                            "PostCode": collectPointAddress.postCode,
                            "State": collectPointAddress.county,
                            "Country": collectPointAddress.country,
                            "CountryCode": collectPointAddress.countryCode,
                            "Phone": collectPointAddress.phone,
                            "Latitude": collectPointAddress.coordinates.latitude,
                            "Longitude": collectPointAddress.coordinates.longitude,
                            "DropPointProviderId": providerId,              
                            "DropPointId": collectPointId,
                            "CollectPrefOrder": prefOrder,
                            "Unsaved": true
                        },
                        "isPrefDeliveryAddr": false,
                        "isBillingAddr": false

                    };
                    self.push('consumerData.Addresses', postData.Address);
                    self.set('cartData.AddressId', collectPointId);

                    self._queuedNewAddress = postData.Address;
                    result = self._queuedNewAddress;
                   
                }
                else {
                    self._queuedNewAddress = null;
                    self.set('cartData.AddressId', existingDropPoint.Id); //collectPointAddress.Id;
                    result = existingDropPoint;
                }
                //self.updateP4mCart(callback);
               // if (callback)
                callback(null, result);
            },

            onPaymentComplete: function () {
            },

            toggleDetailExpansion: function (expand) {
            },

            onSelectPaymentMethod: function (e) {
                var updCart = this.selectedCard !== undefined && this.selectedCard !== null;
                this.set('cartData.PayMethodId', e.detail.Id);
                this.selectedCard = e.detail;
                if (updCart) {
                    this.updateP4mCart();
                }
            },

            onCardHashData: function (data) {
                this.set('cardTimestamp', data.Timestamp);
                this.set('cardMerchantId', data.MerchantId);
                this.set('cardHash', data.Hash);               
            },

            onDiscount: function (e) {
                this.set('cartData.Tax', Number(e.detail.Tax));
                var cartDiscount = this.cartData.Discounts.find((element, index, arr) => element.Code === e.detail.Code); //TODO: Change to bound function; arrow functions may not work in older browsers
                if (cartDiscount) {
                    //console.log("Added existing discount")
                    if (cartDiscount.Description !== e.detail.Description ||
                        cartDiscount.Amount !== e.detail.Amount ||
                        cartDiscount.Code !== e.detail.Code)
                    {
                        cartDiscount.Description = e.detail.Description;
                        cartDiscount.Amount = e.detail.Amount;
                        cartDiscount.Code = e.detail.Code;
                        this.cartData.Tax = e.detail.Tax;
                        this.updateP4mCart();
                    }
                }
                else {
                    this.push('cartData.Discounts',
                    {
                        Description: e.detail.Description,
                        Amount: e.detail.Amount,
                        Code: e.detail.Code
                    });
                    this.cartData.Tax = e.detail.Tax;
                    this.updateP4mCart();
                }
            },

            onDiscountDelete: function (e, code) {

                var item = this.cartData.Discounts.find((element, index, arr) => element.Code === code);
                if (item) {
                    item.Amount = 0;
                    item.Description = "Deleted";
                    this.cartData.Tax = e.detail.Tax;
                    this.updateP4mCart();
                    this.$.localApi.call('removeDiscountCode', {"discountCode": code}, null, null);
                }
            },

            onGotNewCard: function(){
                this.$.p4mCheckoutApi.call('consumer', null, null, this.onConsumerData.bind(this));
            },

            onSelectAddress: function (e) {
                //TODO: Trigger POST to GFS
                console.log("^^^ ADDRESS SELECTED");
                var self = this;
                if (e.detail) {
                    //If changed billing address, tell P4M
                    if (e.detail.isBilling && self.cartData.BillingAddressId != e.detail.id) {
                        self.set('cartData.BillingAddressId', e.detail.id);
                        self.updateP4mCart();
                    }
                    //If changed delivery address, tell GFS and P4M
                    else if (e.detail.isDelivery && self.cartData.AddressId != e.detail.id) {
                        self.set('cartData.AddressId', e.detail.id);
                        async.series([
                            function _gfs(callback) {
                                if (self.$.gfsCheckoutWidget) {
                                    self.$.gfsCheckoutWidget._unselectDropPoint();
                                    self._updateGfs(callback);
                                }
                                else {
                                    callback(null);
                                }
                            },
                            function _p4m(callback) {
                                self.updateP4mCart();
                            },
                        ],
                        function (err) {
                            if (err) console.error(err);
                        });

                        
                    }
                }
            },

            onAddAddress: function (e) {
                this.onUpdateAddress(e);
                /*, function (result) {
                    if (result) {
                        e.detail.markAsBilling();
                    }
                });*/
            },

            onUpdateAddress: function (addressElement) {
                // here we're adding or updating an address only, not setting a default value on the consumer at this stage
                this.$.addressList.showAsLoading();
                var postData =        
                {
                    "Address": addressElement.detail.addressData,
                    "isPrefDeliveryAddr": true
                };
                if (!postData.Address.AddressType) {
                    postData.Address.AddressType = 'Address';
                }
                var self = this;
                this.$.p4mCheckoutApi.call("postAddress", null, postData, function (err, result) {
                    //console.log("Got address result: ", result);
                    if (err) {
                        throw err;
                    }
                    else {
                        addressElement.detail.addressData.Id = result.Address.Id;
                        //addressElement.detail.mode = "view";
                        self.$.addressList.showAsLoaded();
                        //if (callback) callback(result);
                    }

                });
            },

            preselectDeliveryMethod: function () {
                //Select delivery details based on selected address and user's preferences
                if (!this.consumerData) throw "No consumer data"
                else if (!this.cartData) throw "No cart data";

                //this.consumerData.PreferSoonestDelivery = true; //TODO: Remove. This is just here for testing.

                if (this.consumerData.PreferSoonestDelivery) {
                    if (this.$.gfsCheckoutWidget) {
                        this.$.gfsCheckoutWidget.showPage_Calendar(true);
                    }
                }
                else {
                    if (this.$.gfsCheckoutWidget) {
                        this.$.gfsCheckoutWidget.showPage_Standard(true);
                    }

                }
               

            },

            preselectAddress: function () {
                //Select address based on preferences
                console.log('preselectAddress()');
                if (!this.consumerData) throw "No consumer data"
                else if (!this.cartData) throw "No cart data";

                var preferences = ["useMyDeliveryAddress", "useMyDropPoints", "useRetailerDropPoint"];
                if (this.consumerData.DeliveryPreferences & this.consumerData.DeliveryPreferences !== "") {
                    preferences = this.consumerData.DeliveryPreferences.split(',');
                }

                //Preferred address
                //Process a priority list of address preferences
                var self = this;
                var handlers = {
                    "useMyDeliveryAddress": function (callback) { self.selectPreferredAddress(callback); },
                    "useMyDropPoints": function (callback) { self.selectPreferredDroppoint(callback); },
                    "useRetailerDropPoint": function (callback) { self.selectSupportedDropPoint(callback); }
                };
                var handlerArray = [];
                preferences.forEach(function (pref) {
                    handlerArray.push(handlers[pref]);
                });

                function runHandler(index) {
                    handler = handlerArray[index || 0];
                    if (handler) {
                        //console.log("Running handler", index);
                        handler(function (err, data) {
                            //console.log("Handler returned", err);
                            if (err) {
                                runHandler(index+1);
                            }
                        });
                    }
                    else {
                        //console.log("Finished running handlers");
                    }
                }

                runHandler(0);
                 
            },

            selectPreferredAddress: function (callback) {
                //If there is a preferred delivery address, select that.
                //PRECONDITION: Consumer data and Cart data exists
                //Returns: addressId/null depending on success/failure
                console.log('selectPreferredAddress');
                if (this.consumerData.PrefDeliveryAddressId) {
                    this.set('cartData.AddressId', this.consumerData.PrefDeliveryAddressId);
                    callback(null, this.consumerData.PrefDeliveryAddressId);
                }
                else {
                    callback("No preferred address");
                }
            },

            selectPreferredDroppoint: function(callback) {
                //If there are preferred droppoint addresses, select the nearest.
                //PRECONDITION: Consumer data and Cart data exists
                //Returns: addressId/null depending on success/failure
                console.log('selectPreferredDroppoint');
                var self = this;
                var preferredDroppoints = this._getPreferredDropPoints();

                if (preferredDroppoints.length) {
                    var nearestDroppoint = preferredDroppoints[0];
                    //this.set('cartData.AddressId', nearestDroppoint.droppointId);
                    this.selectCollectPoint(nearestDroppoint.providerName, nearestDroppoint.providerId, nearestDroppoint.droppointId, nearestDroppoint.geoLocation, function (err) {
                        //self.updateP4mCart();
                        callback(err, nearestDroppoint);
                    });
                }
                else {
                    callback("No preferred droppoints");
                }
            },

            selectSupportedDropPoint: function (callback) {
                //If there is a suitable shipping selector that can return droppoints, select the nearest to the preferred address
                //PRECONDITION: Consumer data and Cart data exists, preferred address 
                //Returns: addressId/null depending on success/failure
                console.log('selectSupportedDroppoint');
                var self = this;
                if (this.$.gfsCheckoutWidget) {
                    //Ask GFS Checkout for the supported droppoint closest to the preferred address
                    if (this.consumerData.PrefDeliveryAddressId) {
                        var preferredAddress = this.getAddressById(this.consumerData.PrefDeliveryAddressId);
                        this.$.gfsCheckoutWidget.requestDropPointsByAddress(preferredAddress.Street1, preferredAddress.PostCode, function (dropPoints) {
                            if (dropPoints && dropPoints.length) {
                                var dropPoint = dropPoints[0];
                                self.selectCollectPoint(dropPoint.providerName, dropPoint.providerId, dropPoint.droppointId, dropPoint.geoLocation, function (err) {
                                    //self.updateP4mCart();
                                    callback(err);
                                });
                            }
                            else {
                                callback("No supported collection points found");
                            }
                        });
                    }

                }
                else {
                    callback("No shipping handler to get droppoints");
                }
            },

            _getPreferredDropPoints: function() {
                return this.consumerData.Addresses         
                    .filter(function (item) { return (item.AddressType == "Collect" && item.Latitude && item.DropPointId) })
                    .map(p4mDroppointToGfsDroppoint);
            },

            _getPreferredAddresses: function (maxItems) {
                var preferredAddressId = this.consumerData.PrefDeliveryAddressId;
                return this.consumerData.Addresses
                    .filter(function (item, i) { return (item.AddressType == "Address") }) //Only addresses, not droppoints
                    .sort(function (a, b) { if (a.Id == preferredAddressId) { return -1; } else { return 1 } })
                    .filter(function (item, i) { return (i < maxItems || 10) }) //Up to 3 addresses                   
                    .map(p4mAddressToGfsDroppoint);
            },

            _onSelectTab: function (e) {
                /*
               if (e.detail.item && e.detail.item.tagName.toLowerCase() == "iron-page" && e.detail.item.id !== "deliveryPage" && e.detail.item.id !== "pageDroppoints") {
                    this.toggleDetailExpansion(false);
                }
                else {
                    this.$.gfsCheckoutWidget.broadcastState();
                }
                */
            },

            onGfsServiceChanged: function (e) {
                if (this.initialising) {
                    console.warn('onGfsServiceChanged(): not updating while initialising');
                    return;
                }
                else {
                    console.log("p4m widget: onGfsServiceChanged():", e);
                    this.updateShippingService(e.detail, function () { console.log("onGfsServiceChanged: updateShippingService complete")});
                }
            },

            //The selected service wasn't available, so choose a default
            onGfsNoService: function (e) {
                this.preselectDeliveryMethod();
            },

            onGfsShowDroppoints: function (e) {
                this.toggleDetailExpansion(true);
            },

            onGfsShowStandard: function (e) {
                this.toggleDetailExpansion(false);
            },

            getAddressById: function(id) {
                if (!this.consumerData) {
                    return null;
                }
                var foundItem = this.consumerData.Addresses.find(function(item) { return item.Id == id });
                return foundItem;
            },

            goToPaymentMethods: function () {
                this.selectedTab = this.Tabs.PAYMENT;
                this.$.cardList.addNewCard();
            },

            goToAddresses: function () {
                this.selectedTab = this.Tabs.ADDRESS;
                this.$.addressList.addNewAddress();
            }
        });

        function p4mDroppointToGfsDroppoint(item) {
           var gfsAddress = {
                droppointId: item.DropPointId,
                droppointDescription: item.CompanyName,
                geoLocation: {
                                    
                    postCode: item.PostCode,
                    addressLines: [item.CompanyName, item.Street1],
                    town: item.City,
                    coordinates: {
                        latitude: item.Latitude,
                        longitude: item.Longitude                                
                    },
                    countryCode: item.CountryCode,
                    county: "",
                    directions: ""
                },
                providerId: item.DropPointProviderId,
                providerLogo: "https://s-media-cache-ak0.pinimg.com/avatars/pelithepenguin_1453991623_140.jpg",
                providerName: item.Label                        
            };
            return gfsAddress;

        }

        function p4mAddressToGfsDroppoint(item, defaultCountryCode) {
            var gfsAddress = {
                geoLocation: {
                    postCode: item.PostCode,
                    addressLines: [item.Street1],
                    town: item.City,
                    coordinates: {
                        latitude: item.Latitude,
                        longitude: item.Longitude
                    },
                    countryCode: item.CountryCode || defaultCountryCode || 'GB',
                    county: "",
                    directions: ""
                },
                providerName: item.Label
            };
            return gfsAddress;

        }

        function p4mAddressToGfsAddress(item, defaultCountryCode) {
            var gfsAddress = {
                CountryCode: {
                    Code: item.CountryCode || defaultCountryCode || "GB",
                    Encoding: "ccISO_3166_1_Alpha2"
                },
                Postcode: item.PostCode,// "SO40 7JF", //ViewBag.InitialPostCode,
                town: item.City,
                addressLineCollection: [item.Street1]
            };
            return gfsAddress;

        }
    </script>
</dom-module>

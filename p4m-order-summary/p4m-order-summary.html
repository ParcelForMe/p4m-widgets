<link rel="import" href="../p4m-card/p4m-card.html" />
<link rel="import" href="../../polymer/polymer.html" />
<link rel="import" href="../../paper-spinner/paper-spinner.html" />


<dom-module id="p4m-order-summary">

    <template>
        <div id="p4mContainer">
            <h4>Order Summary</h4>
            <div class="p4m-table" i>
                <div class="p4m-row">
                    <div class="p4m-cell detail-col">{{_cartItemCount}} {{_collectiveNoun}}: {{_cartDescription}}</div>
                    <div class="p4m-cell cost-col">{{currencySymbol}}{{_cartItemsTotalPriceString}}</div>
                </div>
                <div class="p4m-row">
                    <div class="p4m-cell detail-col">Delivery via {{cartData.ServiceName}}</div>
                    <div class="p4m-cell cost-col">{{currencySymbol}}{{_shipping}}</div>
                </div>
                <div class="p4m-row">
                    <div class="p4m-cell detail-col">Tax</div>
                    <div class="p4m-cell cost-col">{{currencySymbol}}{{_tax}}</div>
                </div>
                <div class="p4m-row" id="coupon">
                    <div class="p4m-cell detail-col">Coupon</div>
                    <div class="p4m-cell cost-col"><p4m-discount-input on-discount="onDiscount"></p4m-discount-input>
                    </div>
                </div>
                <div class="p4m-row" id="discount">
                    <div class="p4m-cell detail-col">Discount</div>
                    <div class="p4m-cell cost-col">&ndash;&nbsp;{{currencySymbol}}{{_discount}}</div>
                </div>
                <div class="p4m-row total">
                    <div class="p4m-cell detail-col">Total</div>
                    <div class="p4m-cell cost-col">{{currencySymbol}}{{_total}}</div>
                </div>
            </div>
            <paper-spinner id="spinner"></paper-spinner>

        </div>
    </template>

    <script>
    //
        Polymer({
            is: "p4m-order-summary",

            properties: {
                cartData: {
                    type: Object,
                    notify: true,
                    observer: "onCartDataModified"
                },
                currencySymbol: {
                    type: String,
                    value: '£'
                },
                useSpinner: {
                    type: Object,
                    value: false
                },
                _cartItemCount: {
                    type: Number,
                    notify: true,
                    value: 0
                },
                _cartItemsTotalPrice: {
                    type: Number,
                    notify: true
                },
                _cartItemsTotalPriceString: {
                    type: String
                },
                _cartDescription: {
                    type: Number,
                    notify: true,
                    value: ''
                },
                _tax: {
                    type: String
                },
                _discount: {
                    type: Number,
                    value: 0
                }
            },
            observers: [
                "onCartDataModified(cartData.Items.*)",
                "onCartDataModified(cartData.Discounts)"


            ],
            ready: function()
            {
                this.update.bind(this)();
            },

            update: function () {
                if (this.cartData) {
                    this._updateItemCount();
                    this._updateCartDescription();
                    this._updateDiscount();
                    this._updateCurrencyAmounts();
                    this._updateTemplate();                   
                }               
            },

            hasDiscount: function () {
                 return true;
                //debugger;
                //return (this.cartData && this.cartData.Discounts.length);
            },

            _updateItemCount: function() {
                this._cartItemCount = 0;
                this._cartItemsTotalPrice = 0;
                var self = this;
                this.cartData.Items.forEach(function (item) {
                    self._cartItemCount += Number(item.Qty);
                    self._cartItemsTotalPrice += Number(item.Qty) * Number(item.Price);
                });
                self._cartItemsTotalPriceString = self._cartItemsTotalPrice.toFixed(2);
                self._collectiveNoun = this._cartItemCount > 1 ? "items" : "item";
            },

            _updateCartDescription: function() {
                this._cartDescription = null;
                var self = this;
                this.cartData.Items.forEach(function (item) {
                    if (self._cartDescription) {
                        self._cartDescription += ", ";
                    }
                    else self._cartDescription = "";
                    self.set('_cartDescription', self._cartDescription + item.Desc);
                });
            },

            _updateDiscount: function () {
                if (this.cartData.Discounts) {
                    this.set('_discount', this.cartData.Discounts.reduce(((total, item) => total + item.Amount), 0));
                    this.set('_discountDescription', this.cartData.Discounts.length ? this.cartData.Discounts[0].Description : "None");
                }

            },

            _updateCurrencyAmounts: function () {
                this.set('_tax', this.cartData.Tax.toFixed(2));
                this.set('_discount', Number(this._discount).toFixed(2));
                this.set('_shipping', Number(this.cartData.ShippingAmt).toFixed(2));
                this.set('_total',  Number(this.cartData.Total).toFixed(2));
                
            },

            _updateTemplate: function() {
               // this.$.discountTemplate.render();
            },

            onCartDataModified: function (e) {
                this.update();
            },
         
            showAsLoaded: function () {
                if (this.useSpinner) {
                    this.$.spinner.active = false;
                    this.$.spinner.classList.add('hidden');
                    this.$.p4mContainer.classList.remove('loading');
                }

            },

            showAsLoading: function () {
                if (this.useSpinner) {
                    this.$.spinner.active = true;
                    this.$.spinner.classList.remove('hidden');
                    this.$.p4mContainer.classList.add('loading');
                }

            }

        });
    </script>
</dom-module>
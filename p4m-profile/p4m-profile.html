<link rel="import" href="../../polymer/polymer.html" />
<link rel="import" href="../../paper-spinner/paper-spinner.html" />

<dom-module id="p4m-profile">

    <template>
        <div id="p4m-profile-container" class$="{{_topClass}}">
            <polymer-cookie id="p4mTokenCookie" name="p4mToken"></polymer-cookie>
            <polymer-cookie id="p4mAvatarCookie" name="p4mAvatarUrl"></polymer-cookie>
            <polymer-cookie id="p4mGivenNameCookie" name="p4mGivenName"></polymer-cookie>
            <div id="profileImage">

                <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                     viewBox="0 0 24 24" style="enable-background:new 0 0 24 24;" xml:space="preserve">
                <style type="text/css">
                    .st0{fill:#231F20;}
                </style>
                <path class="st0" d="M22.3,7.7c-0.6-1.3-1.4-2.5-2.4-3.5c-1-1-2.2-1.8-3.5-2.4C15,1.1,13.5,0.9,12,0.9c-1.5,0-3,0.3-4.3,0.9
                    C6.3,2.3,5.1,3.1,4.1,4.1c-1,1-1.8,2.2-2.4,3.5C1.1,9,0.8,10.5,0.8,12c0,1.5,0.3,2.9,0.9,4.3c0.6,1.3,1.3,2.5,2.4,3.5l0,0
                    c1,1,2.2,1.8,3.6,2.4c1.4,0.6,2.9,0.9,4.4,0.9c1.5,0,3-0.3,4.4-0.9c1.3-0.6,2.5-1.4,3.6-2.4l0,0c1-1,1.8-2.2,2.4-3.5
                    c0.6-1.4,0.9-2.8,0.9-4.3C23.1,10.5,22.9,9,22.3,7.7L22.3,7.7z M9,18.2c0.5-0.2,0.9-0.3,1.4-0.5c0.3-0.1,0.4-0.4,0.4-0.6v-2.3
                    c0-0.3-0.2-0.6-0.5-0.6c-0.1,0-0.9-0.4-0.9-2.1c0-0.3-0.2-0.6-0.5-0.7c0-0.1,0-0.1,0-0.2c0-0.1,0-0.2,0-0.2c0.3-0.1,0.5-0.3,0.5-0.7
                    c0-0.1,0-0.3-0.1-0.6C9.3,9.3,9.2,8.8,9.1,8.4C9.1,7.8,9.2,7.7,9.2,7.7c0,0,0.1-0.1,0.4,0c0.4,0.1,0.7-0.2,0.8-0.5
                    c0.1-0.4,1-0.8,2.3-0.8s2.2,0.4,2.3,0.8c0.2,0.8-0.2,1.9-0.3,2.4c-0.1,0.3-0.1,0.4-0.1,0.6c0,0.3,0.2,0.6,0.5,0.7c0,0.1,0,0.1,0,0.2
                    c0,0.1,0,0.2,0,0.2c-0.3,0.1-0.5,0.3-0.5,0.7c0,1.7-0.8,2-0.9,2.1c-0.3,0.1-0.5,0.3-0.5,0.6V17c0,0.3,0.2,0.5,0.4,0.6
                    c0.5,0.2,1,0.4,1.5,0.5l0,0c1.2,0.4,2.4,0.9,3.2,1.3c-0.7,0.6-1.6,1.1-2.5,1.5c-1.2,0.5-2.5,0.8-3.8,0.8c-1.3,0-2.6-0.3-3.8-0.8
                    c-0.9-0.4-1.7-0.9-2.5-1.5C6.6,19,7.8,18.6,9,18.2L9,18.2z M14.5,15.1c0.2-0.2,0.5-0.4,0.8-0.8c0.3-0.5,0.5-1.1,0.6-1.9
                    c0.4-0.3,0.6-0.8,0.6-1.4c0-0.5-0.2-1-0.4-1.2c0.2-0.7,0.6-1.9,0.3-3c-0.2-0.6-0.7-1.2-1.5-1.5c-0.6-0.3-1.4-0.4-2.2-0.4
                    c-0.8,0-1.6,0.1-2.2,0.4C10,5.6,9.6,5.9,9.3,6.3c-0.5,0-0.9,0.2-1.1,0.5C7.4,7.5,7.8,9,8,9.8c-0.3,0.3-0.5,0.7-0.5,1.3
                    c0,0.6,0.2,1.1,0.6,1.4C8.3,14,9,14.8,9.5,15.1v1.4c-0.3,0.1-0.6,0.2-0.9,0.3h0c-1.4,0.5-2.9,1-3.9,1.6c-1.6-1.8-2.5-4.1-2.5-6.5
                    c0-1.3,0.3-2.6,0.8-3.8C3.5,7,4.2,6,5.1,5.1C6,4.2,7,3.5,8.2,3c1.2-0.5,2.5-0.8,3.8-0.8s2.6,0.3,3.8,0.8C17,3.5,18,4.2,18.9,5.1
                    C19.8,6,20.5,7,21,8.2c0.5,1.2,0.8,2.5,0.8,3.8c0,2.4-0.9,4.7-2.4,6.5c-1-0.5-2.3-1-3.8-1.6c-0.3-0.1-0.7-0.2-1-0.4L14.5,15.1
                    L14.5,15.1z"/>
                </svg>

                <img id="profileImage" src="{{_profilePicUrl}}" />
            </div>
            
            <div id="profileName">{{_profileName}}</div>
            <paper-spinner id="spinner"></paper-spinner>
        </div>
    </template>


    <script>
    //
        Polymer({
            is: "p4m-profile",

            properties: {   
                p4mData: {
                    type: Object,
                    notify: true
                },
                mode: {
                    type: String
                },
                hideImage: {
                    type: Object,
                    value: false
                },
                hideName: {
                    type: Object,
                    value: false
                },
                autoLoad: {
                    type: Object,
                    value: false
                },
                _loggedIn: {
                    type: Object,
                    value: false
                },
                _topClass: {
                    type: String,
                    value: ""
                },
                _profilePicUrl: {
                    type: String
                },
                _profileName: {
                    type: String
                }
            },

            ready: function()
            {
                if (this.mode == "basic") {
                    this.hideImage = false;
                    this.hideName = true;
                }
                if (this.hideImage) this.topClass += " hide-image";
                if (this.hideName) this.topClass += " hide-name";

                window.addEventListener('p4m_consumer', this.onProfileData.bind(this));
                this.load();

            },

            load: function() {

                //Try to read all data from cookies first
                var picUrl = this.$.p4mAvatarCookie.readCookie();
                if (picUrl === "")
                    this._profilePicUrl = null;
                else
                    this._profilePicUrl = unescape(picUrl);
                this._profileName = this.$.p4mGivenNameCookie.readCookie();

                //Check to see if the user is logged in
                var token = this.$.p4mTokenCookie.readCookie();
                this._loggedIn = token !== "";
         
                this.show();
            },

            show: function () {
                this.hideSpinner();
             
                if (!this._profilePicUrl) {
                    if (this._loggedIn)
                        this._profilePicUrl = this.resolveUrl("profile-test-image.png");
                    else
                        this._profilePicUrl = this.resolveUrl("profile-test-image.png");
                }
            },

            onProfileData: function (e) {
                this.p4mData = e.detail;
                this._profilePicUrl = this.p4mData.Consumer.ProfilePicUrl;
                this._profileName = this.p4mData.Consumer.GivenName;
                this.show();
            },

            hideSpinner: function () {
                this.$.spinner.active = false;
                this.$.spinner.classList.add('hidden');
            },

            showSpinner: function () {
                this.$.spinner.active = true;
                this.$.spinner.classList.remove('hidden');
            }
        });
    </script>
</dom-module>